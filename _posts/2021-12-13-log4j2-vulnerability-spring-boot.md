---
layout: post
title: 스프링부트와 log4j2 취약점
feature-img: assets/img/titles/log4j.png
thumbnail: assets/img/contents/lvsb-1.png
author: csupreme19
categories: Development Spring
tags: [Spring, Spring boot, Vulnerability, Log4j2, Logback, Security]

---

# 스프링부트와 log4j2 취약점

![log4j.png]({{ "/assets/img/titles/log4j.png"}})

[https://spring.io/blog/2021/12/10/log4j2-vulnerability-and-spring-boot](https://spring.io/blog/2021/12/10/log4j2-vulnerability-and-spring-boot)

---

## log4j2 취약점 발견(~2.14.1 버전)

![lvsb-1.png]({{ "/assets/img/contents/lvsb-1.png"}})

자바 진영 대표 로깅 라이브러리 apache log4j2에서 최근 보안 취약점이 발견 되었어요.

> [CVE-2021-44228](https://nvd.nist.gov/vuln/detail/CVE-2021-44228)
>
> [인터넷침해대응센터 보안공지](https://krcert.or.kr/data/secNoticeView.do?bulletin_writing_sequence=36389)

`Log4j2 2.0-beta9 ~ 2.14.1` 버전에서 JNDI LDAP Lookup을 사용하여 권한을 취득하는 취약점

대부분의 서버에서 사용하고 있는 라이브러리여서 버전 확인 후 패치가 시급해보이네요.

---

## 2021.12.15 추가(2.15.0 버전)

![lvsb-2.png]({{ "/assets/img/contents/lvsb-2.png"}})

log4j2 2.15.0 버전에서 패치한 내용이 완벽하지 않다는 취약점이 발견되었어요.

2.15.0 버전에서는 JNDI LDAP Lookup을 비활성화하고 로컬호스트에서만 가능하게 했는데

기본값이 아닌 특정 패턴 레이아웃을 사용하면 입력 데이터를 조작할 수 있는 것으로 밝혀졌고

최근 배포된 2.16.0에서는 이런 취약점을 해결할 수 있도록 메시지 룩업 패턴 기능을 제거하였어요.

따라서 기존 방법으로 패치하지 말고 2.16.0으로 업데이트가 필요해요.

>[CVE-2021-45046](https://nvd.nist.gov/vuln/detail/CVE-2021-45046)
>
>[인터넷침해대응센터 보안공지](https://krcert.or.kr/data/secNoticeView.do?bulletin_writing_sequence=36389)

---

## 2021.12.20 추가(2.16.0 버전)

![lvsb-3.png]({{ "/assets/img/contents/lvsb-3.png"}})

log4j2 2.16.0 버전 역시 취약점이 존재하는 것으로 확인되었어요.

self-referential lookup(자기 참조 룩업)에 대해서 취약점이 존재하는 것으로 밝혀져 log4j2 2.17.0 버전으로 업데이트를 권장해요.

>[CVE-2021-45015](https://nvd.nist.gov/vuln/detail/CVE-2021-45105)
>
>[인터넷침해대응센터 보안공지 21-12-20](https://krcert.or.kr/data/secNoticeView.do?bulletin_writing_sequence=36397)

---

## 2022. 1. 3 추가(2.17.0 버전)

![lvsb-6.png]({{ "/assets/img/contents/lvsb-6.png"}})

log4j2 2.17.0 버전 특정 조건에서 원격 코드 실행(RCE) 공격에 취약한 것으로 밝혀져

2.17.1 버전으로 업데이트를 권장해요.

>[CVE-2021-44832](https://nvd.nist.gov/vuln/detail/CVE-2021-44832)
>
>[인터넷침해대응센터 보안공지 22-1-3](https://krcert.or.kr/data/secNoticeView.do?bulletin_writing_sequence=36397)

---

## Spring boot를 사용하는 경우

스프링 부트를 사용하는 경우 `spring-boot-starter-logging`을 사용하게 되는데

해당 디펜던시에 포함된 `log4j-to-slf4j`와 `log4j-api` 라이브러리의 경우 취약점 문제가 없다고 하네요.

오직 `log4j-core` 라이브러리가 포함된 경우에만 취약점이 존재하고

기본적으로 spring-boot-starter를 사용하는경우 로그백을 사용하기 때문에 log4j2를 사용하도록 명시하지 않은 경우에는 문제 발생하지 않아요.

> [https://spring.io/blog/2021/12/10/log4j2-vulnerability-and-spring-boot](https://spring.io/blog/2021/12/10/log4j2-vulnerability-and-spring-boot)

---

## 해결방법

### 1. Log4j2 2.17.1 패치하기

~~Lookup 기능을 기본값으로 비활성화시킨 log4j2 2.15.0 버전이 배포 되었다.~~

> ~~[Log4j2 2.15.0](https://repo1.maven.org/maven2/org/apache/logging/log4j/log4j-core/2.15.0/)~~

~~최근 취약점이 해결된 Log4j2 2.16.0 버전으로 업데이트한다.~~

~~최근 취약점이 해결된 Log4j2 2.17.0 버전으로 업데이트한다.~~

최근 취약점이 해결된 Log4j2 2.17.1 버전으로 업데이트한다.

> ~~[Log4j2 2.16.0](https://repo1.maven.org/maven2/org/apache/logging/log4j/log4j-core/2.16.0/)~~
>
> ~~[Log4j2 2.17.0](https://repo1.maven.org/maven2/org/apache/logging/log4j/log4j-core/2.17.0/)~~
>
> [Log4j2 2.17.1](https://repo1.maven.org/maven2/org/apache/logging/log4j/log4j-core/2.17.1/)

#### Maven

```xml
<properties>
    <log4j2.version>2.17.1</log4j2.version>
</properties>
```

#### Gradle with Spring boot

spring dependency management에서 버전 관리해주므로 아래와 같이 사용하세요.

```groovy
ext['log4j2.version'] = '2.17.1'
```

#### Gradle

```groovy
dependencies {
  compile group: 'org.apache.logging.log4j', name: 'log4j-api', version: '2.17.1'
  compile group: 'org.apache.logging.log4j', name: 'log4j-core', version: '2.17.1'
}
```



### ~~2. 프로퍼티로 lookup 비활성화하기~~

~~java 실행시 `log4j2.formatMsgNoLookups=true` 플래그 추가~~

```java
// java -Dlog4j2.formatMsgNoLookups=true -jar myapp.jar
```

> [CVE-2021-45046](https://nvd.nist.gov/vuln/detail/CVE-2021-45046), [CVE-2021-45015](https://nvd.nist.gov/vuln/detail/CVE-2021-45105)에 유효하지 않다.
>
> 2.17.1 버전으로 패치하세요.



### 3. JndiLookup.class 제거 (임시조치)

```sh
zip -q -d log4j-core-*.jar org/apache/logging/log4j/core/lookup/JndiLookup.class
```

라이브러리 자체에서 해당 기능을 하는 클래스를 제거하는 방법으로

당장의 업데이트가 불가피할때 클래스 자체를 지워버리는 방법이에요.



### 4. 패턴 레이아웃 제거(임시조치)

PatternLayout에서 ${ctx:loginId} 또는 $${ctx:loginId}를 (%X, %mdc, or %MDC)로 변경하고

${ctx:loginId} 또는 $${ctx:loginId}를 제거하세요.

---

## 관련 이슈

### log4j 1.2 취약점

![lvsb-4.png]({{ "/assets/img/contents/lvsb-4.png"}})

`log4j 1.2` 버전도 관련 취약점이 존재한다고 하네요.

> [CVE-2021-4104](https://nvd.nist.gov/vuln/detail/CVE-2021-4104)

이전 log4j 1.x 버전을 사용하는 경우 업그레이드 지원 중단으로 인하여

다른 보안 이슈가 존재할 수 있어 log4j2 최신버전으로 업데이트를 권장드려요.



### logback 취약점

![lvsb-5.png]({{ "/assets/img/contents/lvsb-5.png"}})

logback 1.2.7 이하 버전에서도 관련 취약점이 존재해요.

> [CVE-2021-42550](https://nvd.nist.gov/vuln/detail/CVE-2021-42550)

공격자가 logback.xml 등에 대한 쓰기 권한이 있어야해서 위 취약점보다 비교적 심각하지는 않은 것 같아요.

그래도 알려진 보안 취약점이므로 최신버전으로 업데이트를 권고드려요.

---

## Reference

1. [https://spring.io/blog/2021/12/10/log4j2-vulnerability-and-spring-boot](https://spring.io/blog/2021/12/10/log4j2-vulnerability-and-spring-boot)
2. [인터넷침해대응센터 보안공지](https://krcert.or.kr/data/secNoticeView.do?bulletin_writing_sequence=36389)
3. [인터넷침해대응센터 보안공지 22-1-3](https://krcert.or.kr/data/secNoticeView.do?bulletin_writing_sequence=36397)
4. [CVE-2021-4104](https://nvd.nist.gov/vuln/detail/CVE-2021-4104)
5. [CVE-2021-42550](https://nvd.nist.gov/vuln/detail/CVE-2021-42550)
6. [CVE-2021-44228](https://nvd.nist.gov/vuln/detail/CVE-2021-44228)
7. [CVE-2021-45015](https://nvd.nist.gov/vuln/detail/CVE-2021-45105)
8. [CVE-2021-45046](https://nvd.nist.gov/vuln/detail/CVE-2021-45046)
8. [CVE-2021-44832](https://nvd.nist.gov/vuln/detail/CVE-2021-44832)

