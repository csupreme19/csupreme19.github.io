---
layout: post
title: 스프링부트와 log4j2 취약점
feature-img: assets/img/titles/log4j.png
thumbnail: assets/img/contents/lvsb-1.png
author: csupreme19
tags: [Spring, Spring boot, vulnerability, log4j2, logback, logging]

---

# 스프링부트와 log4j2 취약점

![log4j.png]({{ "/assets/img/titles/log4j.png"}})

[https://spring.io/blog/2021/12/10/log4j2-vulnerability-and-spring-boot](https://spring.io/blog/2021/12/10/log4j2-vulnerability-and-spring-boot)

---

## log4j2 취약점 발견

![lvsb-1.png]({{ "/assets/img/contents/lvsb-1.png"}})

자바 진영 대표 로깅 라이브러리 apache log4j2에서 최근 보안 취약점이 발견 되었다.

> [CVE-2021-44228](https://nvd.nist.gov/vuln/detail/CVE-2021-44228)
>
> [인터넷침해대응센터 보안공지](https://krcert.or.kr/data/secNoticeView.do?bulletin_writing_sequence=36389)

`Log4j2 2.0-beta9 ~ 2.14.1` 버전에서 JNDI LDAP Lookup을 사용하여 권한을 취득하는 취약점

대부분의 서버에서 사용하고 있는 라이브러리여서 버전 확인 후 패치가 시급해보인다.

---

## 2021.12.15 업데이트

![lvsb-2.png]({{ "/assets/img/contents/lvsb-2.png"}})

log4j2 2.15.0 버전에서 패치한 내용이 완벽하지 않다는 취약점이 발견되었다.

2.15.0 버전에서는 JNDI LDAP Lookup을 비활성화하고 로컬호스트에서만 가능하게 했는데

기본값이 아닌 특정 패턴 레이아웃을 사용하면 입력 데이터를 조작할 수 있는 것으로 밝혀졌다.

최근 배포된 2.16.0에서는 이런 취약점을 해결할 수 있도록 메시지 룩업 패턴 기능을 제거하였다.

따라서 기존 방법으로 패치하지 말고 2.16.0으로 업데이트가 필요하다.

>[CVE-2021-45046](https://nvd.nist.gov/vuln/detail/CVE-2021-45046)
>
>[인터넷침해대응센터 보안공지](https://krcert.or.kr/data/secNoticeView.do?bulletin_writing_sequence=36389)

---

## Spring boot를 사용하는 경우

스프링 부트를 사용하는 경우 `spring-boot-starter-logging`을 사용하게 되는데

해당 디펜던시에 포함된 `log4j-to-slf4j`와 `log4j-api` 라이브러리의 경우 취약점 문제가 없다고 한다.

오직 `log4j-core` 라이브러리가 포함된 경우에만 취약점이 존재한다.

또한 기본적으로 spring-boot-starter를 사용하는경우 로그백을 사용하기 때문에 log4j2를 사용하도록 명시하지 않은 경우에는 문제 발생하지 않는다.

> [https://spring.io/blog/2021/12/10/log4j2-vulnerability-and-spring-boot](https://spring.io/blog/2021/12/10/log4j2-vulnerability-and-spring-boot)

~~12월 23일 배포되는 v2.5.8과 v2.6.2에는 log4j 2.15.0 버전을 사용할 것이라고 함~~

---

## 해결방법

### 1. Log4j2 2.16.0 패치하기

~~Lookup 기능을 기본값으로 비활성화시킨 log4j2 2.15.0 버전이 배포 되었다.~~

> ~~[Log4j2 2.15.0](https://repo1.maven.org/maven2/org/apache/logging/log4j/log4j-core/2.15.0/)~~

최근 취약점이 해결된 Log4j2 2.16.0 버전으로 업데이트한다.

> [Log4j2 2.16.0](https://repo1.maven.org/maven2/org/apache/logging/log4j/log4j-core/2.16.0/)

#### Maven

```xml
<properties>
    <log4j2.version>2.16.0</log4j2.version>
</properties>
```

#### Gradle with Spring boot

spring dependency management에서 버전 관리해주므로 아래와 같이 사용

```groovy
ext['log4j2.version'] = '2.16.0'
```

#### Gradle

```groovy
dependencies {
  compile group: 'org.apache.logging.log4j', name: 'log4j-api', version: '2.16.0'
  compile group: 'org.apache.logging.log4j', name: 'log4j-core', version: '2.16.0'
}
```



### ~~2. 프로퍼티로 lookup 비활성화하기~~

~~java 실행시 `log4j2.formatMsgNoLookups=true` 플래그 추가~~

```java
// java -Dlog4j2.formatMsgNoLookups=true -jar myapp.jar
```

> [CVE-2021-45046](https://nvd.nist.gov/vuln/detail/CVE-2021-45046)에 유효하지 않다.
>
> 2.16.0 버전으로 패치할 것



### 3. JndiLookup.class 제거 (임시조치)

```sh
zip -q -d log4j-core-*.jar org/apache/logging/log4j/core/lookup/JndiLookup.class
```

라이브러리 자체에서 해당 기능을 하는 클래스를 제거하는 방법이다.

당장의 업데이트가 불가피할때 클래스 자체를 지워버리는 방법이다;

---

## Reference

1. [https://spring.io/blog/2021/12/10/log4j2-vulnerability-and-spring-boot](https://spring.io/blog/2021/12/10/log4j2-vulnerability-and-spring-boot)
2. [CVE-2021-44228](https://nvd.nist.gov/vuln/detail/CVE-2021-44228)
3. [인터넷침해대응센터 보안공지](https://krcert.or.kr/data/secNoticeView.do?bulletin_writing_sequence=36389)
4. [CVE-2021-45046](https://nvd.nist.gov/vuln/detail/CVE-2021-45046)

