<!DOCTYPE html>
<!--
    Type on Strap jekyll theme v2.3.9
    Theme free for personal and commercial use under the MIT license
    https://github.com/sylhare/Type-on-Strap/blob/master/LICENSE
-->
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=0.5, maximum-scale=5">

    <!-- Theme Mode-->
    
    <script>
        const isAutoTheme = false;
        document.documentElement.setAttribute('data-theme', "dark")
    </script>
    

    <!-- Main JS (navbar.js, katex_init.js and masonry_init.js)-->
    <script defer src="/assets/js/main.min.js"></script>
    
    <!-- CSS -->
    <link rel="stylesheet" href="/assets/css/main.css">

    <!--Favicon-->
    <link rel="shortcut icon" href="/assets/favicon.ico" type="image/x-icon">

    <!-- RSS -->
    <link rel="alternate" type="application/atom+xml" title="Seunghoon Choi" href="http://localhost:4000/feed.xml"/>

    

    <!-- KaTeX 0.13.9 -->
    
    <script defer src="/assets/js/vendor/katex.min.js"></script>
    <script defer src="/assets/js/vendor/auto-render.min.js" onload="renderMathInElement(document.body);"></script>
    

    <!-- Mermaid 8.9.2 -->
    
    <script defer src="/assets/js/vendor/mermaid.min.js" onload="mermaid.initialize({startOnLoad:true});"></script>
    

    <!-- Simple Jekyll Search 1.9.1 -->
    <script src="/assets/js/vendor/simple-jekyll-search.min.js" type="text/javascript"></script>

    <!-- Google Analytics / Cookie Consent -->
    <script>
      const cookieName = 'cookie-notice-dismissed-http://localhost:4000';
      const isCookieConsent = 'false';
      const analyticsName = '';
    </script>

    
    

    <!-- seo tags -->
    <meta property="og:image" content="http://localhost:4000/assets/img/contents/jeaa-1.png">
    
    <meta property="og:type" content="website" />
    
    <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Elastic API 알람 모듈 개발기 | Seunghoon Choi</title>
<meta name="generator" content="Jekyll v4.2.1" />
<meta property="og:title" content="Elastic API 알람 모듈 개발기" />
<meta name="author" content="csupreme19" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Elastic API 알람 모듈 개발기" />
<meta property="og:description" content="Elastic API 알람 모듈 개발기" />
<link rel="canonical" href="http://localhost:4000/2021/10/06/java-elastic-api-alert.html" />
<meta property="og:url" content="http://localhost:4000/2021/10/06/java-elastic-api-alert.html" />
<meta property="og:site_name" content="Seunghoon Choi" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-10-06T00:00:00+09:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Elastic API 알람 모듈 개발기" />
<script type="application/ld+json">
{"datePublished":"2021-10-06T00:00:00+09:00","description":"Elastic API 알람 모듈 개발기","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2021/10/06/java-elastic-api-alert.html"},"url":"http://localhost:4000/2021/10/06/java-elastic-api-alert.html","author":{"@type":"Person","name":"csupreme19"},"@type":"BlogPosting","headline":"Elastic API 알람 모듈 개발기","dateModified":"2021-10-06T00:00:00+09:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <!-- RSS -->
    <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Seunghoon Choi" />

    <!-- Twitter Cards -->
    <meta name="twitter:title" content="Elastic API 알람 모듈 개발기">
    <meta name="twitter:description" content="Elastic API 알람 모듈 개발기배경Elastic Kibana의 Alert 기능을 사용하려면 유료 구독형 라이선스(Gold License 이상)가 필요현재 Basic License를 사용중이기 때문에 메트릭 정보를 수집하고 판단하여 slack, mail, 문자 등으로 알람을 ...">
    
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="http://localhost:4000/assets/img/contents/jeaa-1.png">
    <meta name="twitter:image:alt" content="Elastic API 알람 모듈 개발기">
</head>

  <body>
    <header class="site-header">

    <!-- Logo and title -->
	<div class="branding">
        
		<a href="/">
			<img alt="logo img" class="avatar" src="/assets/img/profile-icon.jpeg" />
		</a>
        
        <a class="site-title" aria-label="Seunghoon Choi" href="/">
        Seunghoon Choi
		</a>
	</div>

    <!-- Toggle menu -->
    <nav class="clear">
    <a aria-label="pull" id="pull" class="toggle" href="#">
    <i class="fas fa-bars fa-lg"></i>
    </a>

    <!-- Menu -->
    <ul class="hide">
        

        
            
            
        
            
            <li class="separator"> | </li>
            <li>
                <a class="clear" aria-label="About" title="About" href="/about/">
                     About 
                </a>
            </li>
            
            
        
            
            <li class="separator"> | </li>
            <li>
                <a class="clear" aria-label="Gallery" title="Gallery" href="/gallery/">
                     Gallery 
                </a>
            </li>
            
            
        
            
            
        
            
            
        
            
            <li class="separator"> | </li>
            <li>
                <a class="clear" aria-label="Portfolio" title="Portfolio" href="/portfolio/">
                     Portfolio 
                </a>
            </li>
            
            
        
            
            
        
            
            <li class="separator"> | </li>
            <li>
                <a class="clear" aria-label="Search" title="Search" href="/search/">
                     <i class="fas fa-search" aria-hidden="true"></i>
                    
                </a>
            </li>
            
            
        
            
            <li class="separator"> | </li>
            <li>
                <a class="clear" aria-label="Tags" title="Tags" href="/tags/">
                     <i class="fas fa-tags" aria-hidden="true"></i>
                    
                </a>
            </li>
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
        
        
    </ul>

	</nav>
</header>

    <div class="content">
      <article class="feature-image" >
  <header id="main" style="">
    <div class="title-padder">
      
      <h1 id="Elastic+API+%EC%95%8C%EB%9E%8C+%EB%AA%A8%EB%93%88+%EA%B0%9C%EB%B0%9C%EA%B8%B0" class="title">Elastic API 알람 모듈 개발기</h1>
      


<div class="post-info"><a href="https://github.com/csupreme19" target="_blank">
      <img alt="Author's avatar" src="https://avatars.githubusercontent.com/u/76021703?s=400&v=4">
    
    <p class="meta">
      csupreme19 - 
      
      October 06, 2021
    </p></a></div>

      
    </div>
  </header>

  <section class="post-content">
  
      <h1 id="elastic-api-알람-모듈-개발기">Elastic API 알람 모듈 개발기</h1>

<p><img src="/assets/img/titles/spring-logo.svg" alt="spring-logo.svg" /></p>

<hr />

<h2 id="배경">배경</h2>

<p>Elastic Kibana의 Alert 기능을 사용하려면 유료 구독형 라이선스(Gold License 이상)가 필요</p>

<p>현재 Basic License를 사용중이기 때문에 메트릭 정보를 수집하고 판단하여 slack, mail, 문자 등으로 알람을 줄 수 있는 모듈을 개발</p>

<h3 id="1-monitoring입력">1. Monitoring(입력)</h3>

<p>폴링방식으로 시간 주기 스케줄러를 돌려 API를 호출하여 메트릭 정보를 확인한다.</p>

<ol>
  <li>
    <h4 id="vm-metrics">VM Metrics</h4>
  </li>
  <li>
    <h4 id="kubernetes-metrics">Kubernetes Metrics</h4>
  </li>
  <li>
    <h4 id="service-metrics">Service Metrics</h4>
  </li>
  <li>
    <h4 id="apm">APM</h4>
  </li>
</ol>

<h3 id="2-alert출력">2. Alert(출력)</h3>

<hr />
<h2 id="monitoring입력">Monitoring(입력)</h2>

<p>모니터링 요소는 크게 3가지로 나뉜다.</p>

<h5 id="1-vm-metrics">1. VM Metrics</h5>
<p><img src="/assets/img/contents/jeaa-1.png" alt="jeaa-1.png" /></p>

<p>서버 자원, 네트워크 사용량 등의 메트릭 정보 모니터링</p>

<h5 id="2-kubernetes-metrics">2. Kubernetes Metrics</h5>
<p><img src="/assets/img/contents/jeaa-2.png" alt="jeaa-2.png" /></p>

<p>쿠버네티스 클러스터 상태, 파드 재시작, 레플리카 수 등 API 서버 및 메트릭 정보 모니터링</p>

<h5 id="3-opensource-metrics">3. Opensource Metrics</h5>
<p><img src="/assets/img/contents/jeaa-3.png" alt="jeaa-3.png" /></p>

<p>오픈소스 health, 지연 등 메트릭 정보 모니터링</p>

<h5 id="4-apm">4. APM</h5>
<p><img src="/assets/img/contents/jeaa-4.png" alt="jeaa-4.png" /></p>

<p>Application Transaction, Erros, Latency 정보 모니터링</p>

<hr />
<h2 id="alert출력">Alert(출력)</h2>

<h5 id="1-sms">1. SMS</h5>

<h5><img src="/assets/img/contents/jeaa-5.jpeg" alt="jeaa-5.jpeg" /></h5>

<p>사내 문자 서버 및 에이전트 사용중</p>

<h5 id="2-slack">2. Slack</h5>
<p><img src="/assets/img/contents/jeaa-6.png" alt="jeaa-6.png" /></p>

<p>Slack Webhook API 요청</p>

<hr />
<h2 id="개발-스택">개발 스택</h2>

<ul>
  <li>OpenJDK 8(Java 8)</li>
  <li>Spring Boot 2.4.2</li>
  <li>Gradle</li>
  <li>JUnit</li>
  <li>Elasticsearch REST Client</li>
  <li>Kubernetes</li>
</ul>

<hr />

<h2 id="호출-흐름">호출 흐름</h2>

<div class="mermaid">
  flowchart LR
  	A[Node]
  	B[Node]
  	C[Node]
  	D[Elasticsearch]
  	E[Elastic API Module]
  	F[Admin]
  	A &amp; B &amp; C --metrics--&gt; D
  	E --query--&gt; D
  	E --scheduler--&gt; E
  	D -.response.-&gt; E
  	E --alert--&gt; F
</div>

<hr />

<h2 id="환경구성">환경구성</h2>

<h3 id="1-elasticsearch-java-rest-client">1. Elasticsearch Java REST Client</h3>

<p><a href="https://www.elastic.co/guide/en/elasticsearch/client/java-rest/current/index.html">Java REST Client</a></p>

<p>Elasticsearch에서는 공식적으로 REST 호출을 할 수 있는 자바 클라이언트 라이브러리를 제공한다.</p>

<ul>
  <li>Java Low Level REST Client</li>
  <li>Java High Level REST Client</li>
</ul>

<p>두 명세를 제공하며 엘라스틱서치 query dsl을 그대로 사용하기 위하여 Low level REST Client를 사용할 것이다.</p>

<h4 id="buildgradle-dependency-추가"><code class="language-plaintext highlighter-rouge">build.gradle</code> dependency 추가</h4>

<div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">dependencies</span> <span class="o">{</span>
	<span class="n">implementation</span> <span class="s1">'org.elasticsearch.client:elasticsearch-rest-client:7.12.1'</span>
  <span class="c1">// 참고) High REST Client</span>
  <span class="c1">// implementation 'org.elasticsearch.client:elasticsearch-rest-high-level-client:7.15.2'</span>
<span class="o">}</span>
</code></pre></div></div>

<blockquote>
  <p><a href="https://search.maven.org/search?q=g:org.elasticsearch.client">Maven Central</a></p>
</blockquote>

<h4 id="elasticsearchrestclientutil-작성"><code class="language-plaintext highlighter-rouge">ElasticsearchRestClientUtil</code> 작성</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Slf4j</span>
<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ElasticsearchRestClientUtil</span> <span class="o">{</span>
	
	<span class="kd">private</span> <span class="kd">static</span> <span class="nc">RestClient</span> <span class="n">restClient</span><span class="o">;</span>
	
	<span class="nd">@Autowired</span>
	<span class="nc">EnvironmentConfig</span> <span class="n">env</span><span class="o">;</span>
	
	<span class="kd">private</span> <span class="nf">ElasticsearchRestClientUtil</span><span class="o">()</span> <span class="o">{</span>
	<span class="o">}</span>
	
	<span class="nd">@PostConstruct</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">()</span> <span class="o">{</span>
		<span class="kd">final</span> <span class="nc">CredentialsProvider</span> <span class="n">credentialsProvider</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BasicCredentialsProvider</span><span class="o">();</span>
		<span class="n">credentialsProvider</span><span class="o">.</span><span class="na">setCredentials</span><span class="o">(</span><span class="nc">AuthScope</span><span class="o">.</span><span class="na">ANY</span><span class="o">,</span> <span class="k">new</span> <span class="nc">UsernamePasswordCredentials</span><span class="o">(</span><span class="s">"elastic"</span><span class="o">,</span> <span class="s">"changeme"</span><span class="o">));</span>
		
		<span class="nc">RestClientBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="nc">RestClient</span><span class="o">.</span><span class="na">builder</span><span class="o">(</span><span class="k">new</span> <span class="nc">HttpHost</span><span class="o">(</span><span class="n">env</span><span class="o">.</span><span class="na">getElasticHost</span><span class="o">(),</span> <span class="n">env</span><span class="o">.</span><span class="na">getElasticPort</span><span class="o">(),</span> <span class="s">"http"</span><span class="o">));</span>
		<span class="n">builder</span><span class="o">.</span><span class="na">setFailureListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">RestClient</span><span class="o">.</span><span class="na">FailureListener</span><span class="o">()</span> <span class="o">{</span>
			<span class="nd">@Override</span>
			<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onFailure</span><span class="o">(</span><span class="nc">Node</span> <span class="n">node</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Elasticsearch node fail: {}, {}, {}, {}"</span><span class="o">,</span> <span class="n">node</span><span class="o">.</span><span class="na">getHost</span><span class="o">(),</span> <span class="n">node</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">node</span><span class="o">.</span><span class="na">getRoles</span><span class="o">(),</span> <span class="n">node</span><span class="o">.</span><span class="na">getVersion</span><span class="o">());</span>
			<span class="o">}</span>
		<span class="o">});</span>
		
		<span class="n">builder</span><span class="o">.</span><span class="na">setRequestConfigCallback</span><span class="o">(</span><span class="k">new</span> <span class="nc">RestClientBuilder</span><span class="o">.</span><span class="na">RequestConfigCallback</span><span class="o">()</span> <span class="o">{</span>
			<span class="nd">@Override</span>
			<span class="kd">public</span> <span class="nc">RequestConfig</span><span class="o">.</span><span class="na">Builder</span> <span class="nf">customizeRequestConfig</span><span class="o">(</span><span class="nc">RequestConfig</span><span class="o">.</span><span class="na">Builder</span> <span class="n">requestConfigBuilder</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">return</span> <span class="n">requestConfigBuilder</span><span class="o">.</span><span class="na">setSocketTimeout</span><span class="o">(</span><span class="mi">10000</span><span class="o">);</span> 
			<span class="o">}</span>
		<span class="o">});</span>
		
		<span class="n">builder</span><span class="o">.</span><span class="na">setHttpClientConfigCallback</span><span class="o">(</span><span class="k">new</span> <span class="nc">HttpClientConfigCallback</span><span class="o">()</span> <span class="o">{</span>
	        <span class="nd">@Override</span>
	        <span class="kd">public</span> <span class="nc">HttpAsyncClientBuilder</span> <span class="nf">customizeHttpClient</span><span class="o">(</span>
	                <span class="nc">HttpAsyncClientBuilder</span> <span class="n">httpClientBuilder</span><span class="o">)</span> <span class="o">{</span>
	            <span class="k">return</span> <span class="n">httpClientBuilder</span>
	                <span class="o">.</span><span class="na">setDefaultCredentialsProvider</span><span class="o">(</span><span class="n">credentialsProvider</span><span class="o">);</span>
	        <span class="o">}</span>
	    <span class="o">});</span>
		
		<span class="n">restClient</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
	<span class="o">}</span>
	
	<span class="kd">public</span> <span class="kd">static</span> <span class="nc">Response</span> <span class="nf">request</span><span class="o">(</span><span class="nc">String</span> <span class="n">method</span><span class="o">,</span> <span class="nc">String</span> <span class="n">url</span><span class="o">,</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">param</span><span class="o">,</span> <span class="nc">String</span> <span class="n">jsonBody</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span><span class="o">(</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">url</span><span class="o">))</span> <span class="o">{</span>
			<span class="n">url</span> <span class="o">=</span> <span class="s">"/"</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="nc">Request</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Request</span><span class="o">(</span><span class="n">method</span><span class="o">,</span> <span class="n">url</span><span class="o">);</span>
		<span class="k">if</span><span class="o">(!</span><span class="nc">ObjectUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">param</span><span class="o">))</span> <span class="o">{</span>
			<span class="n">request</span><span class="o">.</span><span class="na">addParameters</span><span class="o">(</span><span class="n">param</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">if</span><span class="o">(!</span><span class="nc">ObjectUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">jsonBody</span><span class="o">))</span> <span class="o">{</span>
			<span class="n">request</span><span class="o">.</span><span class="na">setJsonEntity</span><span class="o">(</span><span class="n">jsonBody</span><span class="o">);</span>
		<span class="o">}</span>
		
		<span class="nc">Response</span> <span class="n">response</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		
		<span class="k">try</span> <span class="o">{</span>
			<span class="n">response</span>  <span class="o">=</span> <span class="n">restClient</span><span class="o">.</span><span class="na">performRequest</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
		<span class="o">}</span>
		
		<span class="k">return</span> <span class="n">response</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ol>
  <li>엘라스틱서치 라이브러리에서 제공하는 <code class="language-plaintext highlighter-rouge">RestClientBuilder</code>로 <code class="language-plaintext highlighter-rouge">RestClient</code> 생성 &amp; 초기화</li>
  <li>이후 <code class="language-plaintext highlighter-rouge">ElasticsearchRestClientUtil</code>에서 초기화된 Singleton 객체 <code class="language-plaintext highlighter-rouge">RestClient</code> 사용</li>
  <li>요청시 파라미터와 json포맷 body를 받도록 설계</li>
  <li>주입된 <code class="language-plaintext highlighter-rouge">EnvironmentConfig</code> Bean 사용을 위하여 <code class="language-plaintext highlighter-rouge">@PostConstruct</code>에서 초기화</li>
</ol>

<h4 id="query-상수-생성">Query 상수 생성</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ElasticConstants</span> <span class="o">{</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">URL_METRICBEAT_SEARCH</span> <span class="o">=</span> <span class="s">"/metricbeat-*/_search"</span><span class="o">;</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">URL_FILEBEAT_SEARCH</span> <span class="o">=</span> <span class="s">"/filebeat-*/_search"</span><span class="o">;</span>
	
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">QUERY_CHECKVM_VMLIST</span> <span class="o">=</span> <span class="s">"{\n"</span> <span class="o">+</span> 
			<span class="s">"  \"query\": {\n"</span> <span class="o">+</span> 
			<span class="s">"    \"bool\": {\n"</span> <span class="o">+</span> 
			<span class="s">"      \"must\": [\n"</span> <span class="o">+</span> 
			<span class="s">"        {\n"</span> <span class="o">+</span> 
			<span class="s">"          \"range\": {\n"</span> <span class="o">+</span> 
			<span class="s">"            \"@timestamp\": {\n"</span> <span class="o">+</span> 
			<span class="s">"              \"gte\": \"now-30s\"\n"</span> <span class="o">+</span> 
			<span class="s">"              , \"lte\": \"now\"\n"</span> <span class="o">+</span> 
			<span class="s">"              , \"boost\": 2\n"</span> <span class="o">+</span> 
			<span class="s">"            }\n"</span> <span class="o">+</span> 
			<span class="s">"          }\n"</span> <span class="o">+</span> 
			<span class="s">"        },\n"</span> <span class="o">+</span> 
			<span class="s">"        {\n"</span> <span class="o">+</span> 
			<span class="s">"          \"exists\": {\n"</span> <span class="o">+</span> 
			<span class="s">"            \"field\": \"host.name\"\n"</span> <span class="o">+</span> 
			<span class="s">"          }\n"</span> <span class="o">+</span> 
			<span class="s">"        }\n"</span> <span class="o">+</span> 
			<span class="s">"      ]\n"</span> <span class="o">+</span> 
			<span class="s">"    }\n"</span> <span class="o">+</span> 
			<span class="s">"  },\n"</span> <span class="o">+</span> 
			<span class="s">"  \"size\": 0,"</span> <span class="o">+</span> 
			<span class="s">"  \"aggs\": {\n"</span> <span class="o">+</span> 
			<span class="s">"    \"alive\": {\n"</span> <span class="o">+</span> 
			<span class="s">"      \"cardinality\": {\n"</span> <span class="o">+</span> 
			<span class="s">"        \"field\": \"host.name\"\n"</span> <span class="o">+</span> 
			<span class="s">"      }\n"</span> <span class="o">+</span> 
			<span class="s">"    },\n"</span> <span class="o">+</span> 
			<span class="s">"    \n"</span> <span class="o">+</span> 
			<span class="s">"    \"metric_count\": {\n"</span> <span class="o">+</span> 
			<span class="s">"      \"terms\": {\n"</span> <span class="o">+</span> 
			<span class="s">"        \"field\": \"host.name\"\n"</span> <span class="o">+</span> 
			<span class="s">"        , \"size\": 40\n"</span> <span class="o">+</span> 
			<span class="s">"        , \"order\": {\n"</span> <span class="o">+</span> 
			<span class="s">"          \"_key\": \"asc\"\n"</span> <span class="o">+</span> 
			<span class="s">"        }\n"</span> <span class="o">+</span> 
			<span class="s">"      }\n"</span> <span class="o">+</span> 
			<span class="s">"    }\n"</span> <span class="o">+</span> 
			<span class="s">"  }\n"</span> <span class="o">+</span> 
			<span class="s">"}"</span><span class="o">;</span>
	
	<span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="호출-예제">호출 예제</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.elasticsearch.client.Response</span><span class="o">;</span>

<span class="o">...</span>

		<span class="nc">Response</span> <span class="n">elasticResponse</span> <span class="o">=</span> <span class="nc">ElasticsearchRestClientUtil</span><span class="o">.</span><span class="na">request</span><span class="o">(</span><span class="s">"POST"</span>
				<span class="o">,</span> <span class="nc">ElasticConstants</span><span class="o">.</span><span class="na">URL_METRICBEAT_SEARCH</span> <span class="o">+</span> <span class="s">"?filter_path=hits.hits.fields"</span>
				<span class="o">,</span> <span class="kc">null</span>
				<span class="o">,</span> <span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="nc">ElasticConstants</span><span class="o">.</span><span class="na">QUERY_CHECKVM_LASTDOC</span><span class="o">,</span> <span class="n">vm</span><span class="o">));</span>

		<span class="k">if</span><span class="o">(</span><span class="nc">ObjectUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">elasticResponse</span><span class="o">))</span> <span class="o">{</span>
			<span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
		<span class="o">}</span>
		
		<span class="nc">JSONObject</span> <span class="n">json</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="nc">String</span> <span class="n">item</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="n">json</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JSONObject</span><span class="o">(</span><span class="nc">EntityUtils</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">elasticResponse</span><span class="o">.</span><span class="na">getEntity</span><span class="o">()));</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">JSONException</span> <span class="o">|</span> <span class="nc">ParseException</span> <span class="o">|</span> <span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
		<span class="o">}</span>
    
		<span class="k">if</span><span class="o">(!</span><span class="nc">ObjectUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">json</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">json</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
			<span class="n">item</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="na">getJSONObject</span><span class="o">(</span><span class="s">"hits"</span><span class="o">)</span>
					<span class="o">.</span><span class="na">getJSONArray</span><span class="o">(</span><span class="s">"hits"</span><span class="o">).</span><span class="na">getJSONObject</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
					<span class="o">.</span><span class="na">getJSONObject</span><span class="o">(</span><span class="s">"fields"</span><span class="o">)</span>
					<span class="o">.</span><span class="na">getJSONArray</span><span class="o">(</span><span class="s">"@timestamp"</span><span class="o">)</span>
					<span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="na">toString</span><span class="o">();</span>
		<span class="o">}</span>

</code></pre></div></div>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">#</span><span class="w"> </span><span class="err">쿼리</span><span class="w"> </span><span class="err">응답</span><span class="w"> </span><span class="err">예시</span><span class="w">
</span><span class="p">{</span><span class="w">
  </span><span class="nl">"hits"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"hits"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nl">"fields"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"@timestamp"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="s2">"1634172060569"</span><span class="w">
          </span><span class="p">]</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Elasticsearch API 쿼리 조회 후 받은 응답값 JSON 파싱</p>

<h2 id="spring-scheduler-설정">Spring Scheduler 설정</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@EnableScheduling</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RestScheduler</span> <span class="o">{</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">double</span> <span class="no">CHECKVM_RESOURCES_MEMORY_LIMIT</span> <span class="o">=</span> <span class="mf">0.8</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">double</span> <span class="no">CHECKVM_RESOURCES_CPU_LIMIT</span> <span class="o">=</span> <span class="mf">0.8</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">CHECKVM_RESOURCES_SCHEDULE_RATE_SEC</span> <span class="o">=</span> <span class="mi">30</span><span class="o">;</span>
	
	<span class="nd">@Autowired</span>
	<span class="nc">ElasticsearchService</span> <span class="n">elasticsearchService</span><span class="o">;</span>
	
	<span class="nd">@Autowired</span>
	<span class="nc">AlertService</span> <span class="n">alertService</span><span class="o">;</span>
	
	<span class="nd">@Autowired</span>
	<span class="nc">EnvironmentConfig</span> <span class="n">env</span><span class="o">;</span>
  
	<span class="nd">@Scheduled</span><span class="o">(</span><span class="n">fixedRate</span><span class="o">=</span><span class="no">CHECKVM_RESOURCES_SCHEDULE_RATE_SEC</span> <span class="o">*</span> <span class="mi">1000</span><span class="o">)</span>
	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">checkVMResourcesSchedule</span><span class="o">()</span> <span class="o">{</span>
		<span class="nc">ListResult</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;&gt;</span> <span class="n">response</span> <span class="o">=</span> <span class="n">elasticsearchService</span><span class="o">.</span><span class="na">checkVMResources</span><span class="o">(</span><span class="no">CHECKVM_RESOURCES_MEMORY_LIMIT</span><span class="o">,</span> <span class="no">CHECKVM_RESOURCES_CPU_LIMIT</span><span class="o">);</span>
		<span class="k">if</span><span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">getCode</span><span class="o">()</span> <span class="o">==</span> <span class="mi">200</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">return</span> <span class="mi">1</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">getList</span><span class="o">();</span>
		
		<span class="nc">StringBuilder</span> <span class="n">sb</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuilder</span><span class="o">()</span>
				<span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"서버 자원 알림"</span><span class="o">);</span>
		
		<span class="k">for</span><span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">:</span> <span class="n">list</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span><span class="o">(</span><span class="n">map</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
				<span class="k">continue</span><span class="o">;</span>
			<span class="o">}</span>
			<span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="nc">StringUtil</span><span class="o">.</span><span class="na">formatSafe</span><span class="o">(</span><span class="s">"\n%s:"</span><span class="o">,</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"key"</span><span class="o">)));</span>
			
			<span class="nc">Double</span> <span class="n">memory</span> <span class="o">=</span> <span class="nc">Double</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"memory"</span><span class="o">));</span>
			<span class="nc">Double</span> <span class="n">cpu</span> <span class="o">=</span> <span class="nc">Double</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"cpu"</span><span class="o">));</span>

			<span class="k">if</span><span class="o">(</span><span class="n">memory</span> <span class="o">&gt;</span> <span class="no">CHECKVM_RESOURCES_MEMORY_LIMIT</span> <span class="o">*</span> <span class="mi">100</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="nc">StringUtil</span><span class="o">.</span><span class="na">formatSafe</span><span class="o">(</span><span class="s">" mem: %.2f%%"</span><span class="o">,</span> <span class="n">memory</span><span class="o">));</span>
			<span class="o">}</span>
			
			<span class="k">if</span><span class="o">(</span><span class="n">cpu</span> <span class="o">&gt;</span> <span class="no">CHECKVM_RESOURCES_CPU_LIMIT</span> <span class="o">*</span> <span class="mi">100</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="nc">StringUtil</span><span class="o">.</span><span class="na">formatSafe</span><span class="o">(</span><span class="s">" cpu: %.2f%%"</span><span class="o">,</span> <span class="n">cpu</span><span class="o">));</span>
			<span class="o">}</span>
		<span class="o">}</span>
		
		<span class="nc">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">sb</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>

		<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">result1</span> <span class="o">=</span> <span class="n">alertService</span><span class="o">.</span><span class="na">sendSms</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
    <span class="kt">int</span> <span class="n">result2</span> <span class="o">=</span> <span class="n">alertService</span><span class="o">.</span><span class="na">sendSlackAlert</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">result1</span> <span class="o">&amp;</span> <span class="n">result2</span><span class="o">;</span>
		
		<span class="k">return</span> <span class="n">result</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<blockquote>
  <p>서비스 구현체의 상세한 비즈니스 로직은 생략</p>
</blockquote>

<ol>
  <li><code class="language-plaintext highlighter-rouge">@EnableScheduling</code> 어노테이션으로 Spring Scheduler 활성화</li>
  <li><code class="language-plaintext highlighter-rouge">@Scheduled(fixedRate=CHECKVM_RESOURCES_SCHEDULE_RATE_SEC * 1000)</code> 스케줄러 등록 및 주기 설정</li>
</ol>

<h3 id="slack-webhook-설정">Slack Webhook 설정</h3>

<p><a href="https://api.slack.com/messaging/webhooks">Incoming Webhooks</a> 참고</p>

<h4 id="호출-예시">호출 예시</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">String</span> <span class="n">uri</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="na">getSlackWebhookUrl</span><span class="o">;</span>
		
<span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">requestMap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
<span class="n">requestMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"text"</span><span class="o">,</span> <span class="n">message</span><span class="o">);</span>

<span class="nc">HttpRequestInfo</span> <span class="n">requestInfo</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HttpRequestInfo</span><span class="o">();</span>
<span class="n">requestInfo</span><span class="o">.</span><span class="na">setUri</span><span class="o">(</span><span class="n">uri</span><span class="o">);</span>
<span class="n">requestInfo</span><span class="o">.</span><span class="na">setMethod</span><span class="o">(</span><span class="s">"POST"</span><span class="o">);</span>
<span class="n">requestInfo</span><span class="o">.</span><span class="na">setConnTimeout</span><span class="o">(</span><span class="n">apiConnTimeout</span><span class="o">);</span>
<span class="n">requestInfo</span><span class="o">.</span><span class="na">setReadTimeout</span><span class="o">(</span><span class="n">apiReadTimeout</span><span class="o">);</span>
<span class="k">try</span> <span class="o">{</span>
  <span class="n">requestInfo</span><span class="o">.</span><span class="na">setSendData</span><span class="o">(</span><span class="nc">ObjectMapperUtil</span><span class="o">.</span><span class="na">toJsonString</span><span class="o">(</span><span class="n">requestMap</span><span class="o">));</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">JsonProcessingException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
<span class="o">}</span>
<span class="n">requestInfo</span><span class="o">.</span><span class="na">setResponseCode</span><span class="o">(</span><span class="nc">HttpURLConnection</span><span class="o">.</span><span class="na">HTTP_UNAVAILABLE</span><span class="o">);</span>

<span class="nc">String</span> <span class="n">responseInfo</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>

<span class="k">try</span> <span class="o">{</span>
  <span class="n">responseInfo</span> <span class="o">=</span> <span class="nc">RestTemplateUtil</span><span class="o">.</span><span class="na">http</span><span class="o">(</span><span class="n">requestInfo</span><span class="o">,</span> <span class="nc">MediaType</span><span class="o">.</span><span class="na">APPLICATION_JSON_VALUE</span><span class="o">);</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
<span class="o">}</span>

<span class="k">return</span> <span class="nc">StringUtils</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">responseInfo</span><span class="o">,</span> <span class="s">"ok"</span><span class="o">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="o">;</span>
</code></pre></div></div>

<p><img src="/assets/img/contents/jeaa-6.png" alt="jeaa-6.png" /></p>

<p>응답 확인</p>

<hr />

<h2 id="elasticsearch-query-dsl">Elasticsearch Query DSL</h2>

<p>쿼리의 경우 별도 문서에 따로 정리함</p>

<blockquote>
  <p><a href="/2021/10/06/elasticsearch-monitoring-query-sample">Elasticsearch 모니터링 쿼리 예제</a></p>
</blockquote>

<hr />

<h2 id="reference">Reference</h2>

<ol>
  <li><a href="https://www.elastic.co/guide/en/elasticsearch/client/java-rest/current/index.html">Java REST Client</a></li>
  <li><a href="https://api.slack.com/messaging/webhooks">Incoming Webhooks</a></li>
</ol>

    
  </section>

  <!-- Social media shares -->
  


   <!-- Tag list -->
  
  


  <div class="tag-list">
    <ul>
      
        <li class="meta">Tags</li>
      

      
        <li><a class="button" href="/tags#Elasticsearch">
          <p><i class="fas fa-tag fa-fw fa-sm"></i> Elasticsearch</p>
        </a></li>
      
        <li><a class="button" href="/tags#Java">
          <p><i class="fas fa-tag fa-fw fa-sm"></i> Java</p>
        </a></li>
      
        <li><a class="button" href="/tags#Kibana">
          <p><i class="fas fa-tag fa-fw fa-sm"></i> Kibana</p>
        </a></li>
      
        <li><a class="button" href="/tags#Scheduler">
          <p><i class="fas fa-tag fa-fw fa-sm"></i> Scheduler</p>
        </a></li>
      
        <li><a class="button" href="/tags#Slack">
          <p><i class="fas fa-tag fa-fw fa-sm"></i> Slack</p>
        </a></li>
      
        <li><a class="button" href="/tags#Spring">
          <p><i class="fas fa-tag fa-fw fa-sm"></i> Spring</p>
        </a></li>
      
        <li><a class="button" href="/tags#Spring+boot">
          <p><i class="fas fa-tag fa-fw fa-sm"></i> Spring boot</p>
        </a></li>
      
        <li><a class="button" href="/tags#Webhook">
          <p><i class="fas fa-tag fa-fw fa-sm"></i> Webhook</p>
        </a></li>
      
    </ul>
  </div>



</article>

<!-- Post navigation -->

<div id="post-nav">
    
    <div id="previous-post">
        <a alt="Kubernetes Pod 재시작 장애 확인하기" href="/2021/10/14/kubernetes-pod-fail-test.html">
            <p>Previous post</p>
            Kubernetes Pod 재시작 장애 확인하기
        </a>
    </div>
    

    
    <div id="next-post">
        <a alt="Elasticsearch 모니터링 쿼리 예제" href="/2021/10/06/elasticsearch-monitoring-query-sample.html">
            <p>Next post</p>
            Elasticsearch 모니터링 쿼리 예제
        </a>
    </div>
    
</div>



<!--Utterances-->
 <script src="https://utteranc.es/client.js"
        repo='csupreme19/csupreme19.github.io'
        issue-term="comment"
        theme="preferred-color-scheme"
		
        crossorigin="anonymous"
        async>
</script>
 

<!-- Cusdis -->


<!-- Disqus -->


<!-- To change color of links in the page -->
<style>
  header#main {
      background-size: cover;
      background-repeat: no-repeat;
      background-position: center;
  }
  
  
  
  
  header#main { background-image: url('/assets/img/titles/spring-logo.svg'); }
  
</style>

    </div>
    <footer class="site-footer">
    <p class="text">
        Powered by <a href="https://jekyllrb.com/">Jekyll</a> with <a href="https://github.com/sylhare/Type-on-Strap">Type on Strap</a>
</p>
            <div class="footer-icons">
                <ul>
                <!-- Social icons from Font Awesome, if enabled -->
                


    

    

    

    

    

    

    
        
        
        
        
        <li>
            <a href="https://github.com/csupreme19"
               title="Follow on Github"
               target="_blank"
               rel="me">
            <span class="fa-stack fa-lg">
              <i class="fas fa-circle fa-stack-2x"></i>
              <i class="fab fa-github fa-stack-1x fa-inverse"></i>
            </span>
            </a>
        </li>
    

    

    

    

    

    

    

    
        
        
        
        
        <li>
            <a href="mailto:csupreme19@gmail.com"
               title="Follow on Mail"
               target="_blank"
               rel="me">
            <span class="fa-stack fa-lg">
              <i class="fas fa-circle fa-stack-2x"></i>
              <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
            </span>
            </a>
        </li>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    


                </ul>
            </div>
</footer>



  </body>
</html>
