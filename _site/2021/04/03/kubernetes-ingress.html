<!DOCTYPE html>
<!--
    Type on Strap jekyll theme v2.3.9
    Theme free for personal and commercial use under the MIT license
    https://github.com/sylhare/Type-on-Strap/blob/master/LICENSE
-->
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=0.5, maximum-scale=5">

    <!-- Theme Mode-->
    
    <script>
        const isAutoTheme = false;
        document.documentElement.setAttribute('data-theme', "dark")
    </script>
    

    <!-- Main JS (navbar.js, katex_init.js and masonry_init.js)-->
    <script defer src="/assets/js/main.min.js"></script>
    
    <!-- CSS -->
    <link rel="stylesheet" href="/assets/css/main.css">

    <!--Favicon-->
    <link rel="shortcut icon" href="/assets/favicon.ico" type="image/x-icon">

    <!-- RSS -->
    <link rel="alternate" type="application/atom+xml" title="Seunghoon Choi" href="http://localhost:4000/feed.xml"/>

    

    <!-- KaTeX 0.13.9 -->
    
    <script defer src="/assets/js/vendor/katex.min.js"></script>
    <script defer src="/assets/js/vendor/auto-render.min.js" onload="renderMathInElement(document.body);"></script>
    

    <!-- Mermaid 8.9.2 -->
    
    <script defer src="/assets/js/vendor/mermaid.min.js" onload="mermaid.initialize({startOnLoad:true});"></script>
    

    <!-- Simple Jekyll Search 1.9.1 -->
    <script src="/assets/js/vendor/simple-jekyll-search.min.js" type="text/javascript"></script>

    <!-- Google Analytics / Cookie Consent -->
    <script>
      const cookieName = 'cookie-notice-dismissed-http://localhost:4000';
      const isCookieConsent = 'false';
      const analyticsName = '';
    </script>

    
    

    <!-- seo tags -->
    <meta property="og:image" content="http://localhost:4000/assets/img/contents/ki-1.png">
    
    <meta property="og:type" content="website" />
    
    <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Kubernetes Nginx Ingress 적용기 | Seunghoon Choi</title>
<meta name="generator" content="Jekyll v4.2.1" />
<meta property="og:title" content="Kubernetes Nginx Ingress 적용기" />
<meta name="author" content="csupreme19" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Kubernetes Nginx Ingress 적용기" />
<meta property="og:description" content="Kubernetes Nginx Ingress 적용기" />
<link rel="canonical" href="http://localhost:4000/2021/04/03/kubernetes-ingress.html" />
<meta property="og:url" content="http://localhost:4000/2021/04/03/kubernetes-ingress.html" />
<meta property="og:site_name" content="Seunghoon Choi" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-04-03T00:00:00+09:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Kubernetes Nginx Ingress 적용기" />
<script type="application/ld+json">
{"datePublished":"2021-04-03T00:00:00+09:00","description":"Kubernetes Nginx Ingress 적용기","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2021/04/03/kubernetes-ingress.html"},"url":"http://localhost:4000/2021/04/03/kubernetes-ingress.html","author":{"@type":"Person","name":"csupreme19"},"@type":"BlogPosting","headline":"Kubernetes Nginx Ingress 적용기","dateModified":"2021-04-03T00:00:00+09:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <!-- RSS -->
    <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Seunghoon Choi" />

    <!-- Twitter Cards -->
    <meta name="twitter:title" content="Kubernetes Nginx Ingress 적용기">
    <meta name="twitter:description" content="Kubernetes Nginx Ingress 적용기Kubernetes Ingress본 문서는 온프레미스 환경에서의 Ingress, SSL 인증서 적용 내용을 정리하였다.nginx ingress controller를 이용하여 jenkins 서비스에 연결하는 과정을 정리하였다.선행 사...">
    
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="http://localhost:4000/assets/img/contents/ki-1.png">
    <meta name="twitter:image:alt" content="Kubernetes Nginx Ingress 적용기">
</head>

  <body>
    <header class="site-header">

    <!-- Logo and title -->
	<div class="branding">
        
		<a href="/">
			<img alt="logo img" class="avatar" src="/assets/img/triangle.png" />
		</a>
        
        <a class="site-title" aria-label="Seunghoon Choi" href="/">
        Seunghoon Choi
		</a>
	</div>

    <!-- Toggle menu -->
    <nav class="clear">
    <a aria-label="pull" id="pull" class="toggle" href="#">
    <i class="fas fa-bars fa-lg"></i>
    </a>

    <!-- Menu -->
    <ul class="hide">
        

        
            
            
        
            
            <li class="separator"> | </li>
            <li>
                <a class="clear" aria-label="About" title="About" href="/about/">
                     About 
                </a>
            </li>
            
            
        
            
            <li class="separator"> | </li>
            <li>
                <a class="clear" aria-label="Gallery" title="Gallery" href="/gallery/">
                     Gallery 
                </a>
            </li>
            
            
        
            
            
        
            
            
        
            
            <li class="separator"> | </li>
            <li>
                <a class="clear" aria-label="Portfolio" title="Portfolio" href="/portfolio/">
                     Portfolio 
                </a>
            </li>
            
            
        
            
            
        
            
            <li class="separator"> | </li>
            <li>
                <a class="clear" aria-label="Search" title="Search" href="/search/">
                     <i class="fas fa-search" aria-hidden="true"></i>
                    
                </a>
            </li>
            
            
        
            
            <li class="separator"> | </li>
            <li>
                <a class="clear" aria-label="Tags" title="Tags" href="/tags/">
                     <i class="fas fa-tags" aria-hidden="true"></i>
                    
                </a>
            </li>
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
        
        
    </ul>

	</nav>
</header>

    <div class="content">
      <article class="feature-image" >
  <header id="main" style="">
    <div class="title-padder">
      
      <h1 id="Kubernetes+Nginx+Ingress+%EC%A0%81%EC%9A%A9%EA%B8%B0" class="title">Kubernetes Nginx Ingress 적용기</h1>
      


<div class="post-info"><a href="https://github.com/csupreme19" target="_blank">
      <img alt="Author's avatar" src="https://avatars.githubusercontent.com/u/76021703?s=400&v=4">
    
    <p class="meta">
      csupreme19 - 
      
      April 03, 2021
    </p></a></div>

      
    </div>
  </header>

  <section class="post-content">
  
      <h1 id="kubernetes-nginx-ingress-적용기">Kubernetes Nginx Ingress 적용기</h1>

<p><img src="/assets/img/titles/nginx-logo.svg" alt="nginx-logo.svg" /></p>

<p><a href="https://kubernetes.io/docs/concepts/services-networking/ingress/">Kubernetes Ingress</a></p>

<p>본 문서는 온프레미스 환경에서의 Ingress, SSL 인증서 적용 내용을 정리하였다.</p>

<p>nginx ingress controller를 이용하여 jenkins 서비스에 연결하는 과정을 정리하였다.</p>

<hr />
<h2 id="선행-사항">선행 사항</h2>
<ul>
  <li>Let’s Encrypt 인증서 발급</li>
  <li>Kubernetes 환경 구축</li>
  <li>Ingress controller 설치</li>
</ul>

<hr />
<h2 id="ingress-개요">Ingress 개요</h2>
<div class="mermaid">
flowchart LR
  A[User]
  subgraph Kubernetes Cluster
  subgraph Ingress
  B[Service: Ingress Contoller]
  J[Pod: Ingress Controller]
  F[Resource: Ingress]
  end
  subgraph Deployment1
  C[Service1]
  G[Pod1]
  end
  subgraph Deployment2
  D[Service2]
  H[Pod2]
  end
  subgraph Deployment3
  E[Service3]
  I[Pod3]
  end
  end
  A -.Ingress.-&gt; B
  B---J
  C---G
  D---H
  E---I
  B---F
  B --&gt; C &amp; D &amp; E
</div>

<p>외부에서 클러스터에 접근할 때 요청받는 것이 Ingress이다. 쉽게 얘기하면 일반적인 proxy, gateway라고 보면 된다.</p>

<p>동일하게 로드밸런서, 서비스 메쉬의 역할도 수행하며 경우에 따라서는 Blue Green 배포나 Canary 배포도 가능하다.</p>

<p>외부 → Ingress → Service → Pod</p>

<p>내부 서비스에 SSL 인증서를 적용하는 것이 아닌 Ingress에 인증서를 적용한다.</p>

<p>이와 같이 적용하면 서비스 종속성 없이 앞단에서 인증서 적용이 가능하므로 뒷단의 서비스가 추가되어도 쉽게 적용이 가능하다.</p>

<h3 id="ingress-controller와-ingress-resource의-차이"><code class="language-plaintext highlighter-rouge">Ingress Controller</code>와 <code class="language-plaintext highlighter-rouge">Ingress Resource</code>의 차이</h3>

<p><img src="/assets/img/contents/ki-2.png" alt="ki-2.png" /></p>

<h4 id="ingress-controller">Ingress Controller</h4>

<p><img src="/assets/img/contents/ki-1.png" alt="ki-1.png" /></p>

<blockquote>
  <p>이미지: <a href="https://www.udemy.com/course/certified-kubernetes-administrator-with-practice-tests/">Certified Kubernetes Administrator(CKA) with Practice Tests</a> 발췌</p>
</blockquote>

<ul>
  <li><code class="language-plaintext highlighter-rouge">80:31280/TCP</code>, <code class="language-plaintext highlighter-rouge">443:32443/TCP</code>등의 서비스와 함께 NodePort 형식으로 외부와의 연결을 담당</li>
  <li>보통 nginx, haproxy 등 proxy 서버로 구현되어 있다.</li>
  <li>Ingress Resource의 설정값(Ingress Rule)에 따라 클러스터 내의 Service로 연결한다.</li>
</ul>

<h4 id="ingress-resource">Ingress Resource</h4>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">networking.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Ingress</span>
<span class="na">metadata</span><span class="pi">:</span>
<span class="nn">...</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">rules</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">host</span><span class="pi">:</span> <span class="s">service.yourdomain.com</span> <span class="c1"># 이 부분 추가 (하이픈은 맨 위에만 있어야함)</span>
    <span class="na">http</span><span class="pi">:</span>
      <span class="na">paths</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">pathType</span><span class="pi">:</span> <span class="s">Prefix</span>
        <span class="na">path</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/service"</span>
        <span class="na">backend</span><span class="pi">:</span>
          <span class="na">service</span><span class="pi">:</span>
            <span class="na">name</span><span class="pi">:</span> <span class="s">service-name</span>
            <span class="na">port</span><span class="pi">:</span>
              <span class="na">number</span><span class="pi">:</span> <span class="m">8080</span>
</code></pre></div></div>

<ul>
  <li>Ingress Controller에서 어떤 서비스로 라우팅할 것인지 규칙을 명세한 Resource이다.</li>
  <li>path등의 값으로 어떤 service에 연결할 것인지에 대한 명세이다.</li>
  <li>Kubernetes secret 리소스를 참조하여 tls 연결을 설정할 수 있다.</li>
</ul>

<hr />
<h2 id="ingress-적용">Ingress 적용</h2>

<h3 id="인증서-파일-구성">인증서 파일 구성</h3>

<p>PEM 포맷의 RSA crt, key가 필요하다.</p>

<p>본 문서에서는 Let’s Encrypt의 DNS 포맷으로 발급된 *.yourdomain.com 도메인 인증서를 사용한다.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># yourdomain.com.crt</span>
<span class="nt">-----BEGIN</span> CERTIFICATE-----
MII...
<span class="nt">-----END</span> CERTIFICATE-----

<span class="c"># yourdomain.com.crt</span>
Private-Key: <span class="o">(</span>2048 bit<span class="o">)</span>
modulus:
...
<span class="nt">-----BEGIN</span> RSA PRIVATE KEY-----
MII...
<span class="nt">-----END</span> RSA PRIVATE KEY-----
</code></pre></div></div>

<h3 id="kubernetes-secret-생성">Kubernetes secret 생성</h3>

<p>kubernetes에서는 여러가지 시크릿 타입을 제공하는데</p>

<p>그 중 SSL 인증서에 대한 정보를 담고 있는 Secret 타입은 <code class="language-plaintext highlighter-rouge">kubernetes.io/tls</code> 이다.</p>

<p>secret 생성하는 두 가지 방법이 존재</p>

<h4 id="1-secret-yaml-파일-생성">1. secret yaml 파일 생성</h4>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>vim service-secret.yaml

apiVersion: v1
kind: Secret
metadata:
  name: secret-tls
<span class="nb">type</span>: kubernetes.io/tls
data:
  <span class="c"># the data is abbreviated in this example</span>
  tls.crt: |
        MIIC2DCCAcCgAwIBAgIBATANBgkqh ...
  tls.key: |
        MIIEpgIBAAKCAQEA7yn3bRHQ5FHMQ ...
</code></pre></div></div>

<p>이 경우 인증서 값은 —–BEGIN CERTIFICATE—–와 —–END CERTIFICATE—– 사이에 있는 인코딩값을 넣어야한다고 한다.</p>

<blockquote>
  <p>확인결과 .crt 안에 있는 인증서 값을 모두 포함하여야함</p>
</blockquote>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl create <span class="nt">-f</span> service-secret.yaml
</code></pre></div></div>

<p>kubernetes secret 생성</p>

<h4 id="2-직접-생성권장">2. 직접 생성(권장)</h4>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># kubectl create secret {type} {name} --cert {certPath} --key {keyPath}</span>
<span class="nv">$ </span>kubectl create secret tls secret-tls <span class="nt">--cert</span> ssl/yourdomain.com.crt <span class="nt">--key</span> ssl/yourdomain.com.key
</code></pre></div></div>

<p>Imperative 방식으로 생성</p>

<p>인증서 파일을 설정값으로 물고갈 수 있어서 권장</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># secret 생성 확인</span>
<span class="nv">$ </span>kubectl get secret
<span class="nv">$ </span>kubectl describe secret secret-tls
</code></pre></div></div>
<hr />
<h2 id="ingress-tls-적용">Ingress TLS 적용</h2>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">$ vim jenkins-ingress.yaml</span>

<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">networking.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Ingress</span>
<span class="na">metadata</span><span class="pi">:</span>
<span class="nn">...</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">rules</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">host</span><span class="pi">:</span> <span class="s">jenkins.yourdomain.com</span> <span class="c1"># 이 부분 추가 (하이픈은 맨 위에만 있어야함)</span>
    <span class="na">http</span><span class="pi">:</span> 
      <span class="na">paths</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">pathType</span><span class="pi">:</span> <span class="s">Prefix</span>
        <span class="na">path</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/jenkins"</span>
        <span class="na">backend</span><span class="pi">:</span>
          <span class="na">service</span><span class="pi">:</span>
            <span class="na">name</span><span class="pi">:</span> <span class="s">jenkins</span>
            <span class="na">port</span><span class="pi">:</span>
              <span class="na">number</span><span class="pi">:</span> <span class="m">8080</span>
  <span class="c1"># 아래 부분 추가</span>
  <span class="na">tls</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">hosts</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">jenkins.yourdomain.com</span>
    <span class="na">secretName</span><span class="pi">:</span> <span class="s">secret-tls</span>
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 적용</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> jenkins-ingress.yaml
</code></pre></div></div>
<p>위에서 생성한 Secret을 이용하면 Ingress에 인증서를 적용할 수 있다.</p>

<h3 id="인증서-적용-확인">인증서 적용 확인</h3>

<h4 id="1-ingress-controller-접속-확인">1. Ingress Controller 접속 확인</h4>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ingress-nginx 서비스 포트매핑 확인</span>
<span class="nv">$ </span>kubectl get svc <span class="nt">-A</span>

NAMESPACE       NAME                                 TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>                      AGE
ingress-nginx   ingress-nginx-controller             NodePort    10.104.33.237    &lt;none&gt;        80:31623/TCP,443:32452/TCP   29h

<span class="nv">$ </span>curl <span class="nt">-k</span> <span class="nt">-v</span> https://10.104.33.237:443
...
<span class="k">*</span> Connected to 10.104.33.237 <span class="o">(</span>10.104.33.237<span class="o">)</span> port 443 <span class="o">(</span><span class="c">#0)</span>
...
</code></pre></div></div>

<h4 id="2-외부-도메인-접속-확인">2. 외부 도메인 접속 확인</h4>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl <span class="nt">-k</span> <span class="nt">-v</span> https://jenkins.yourdomain.com:32452
...
<span class="k">*</span> Connected to jenkins.yourdomain.com <span class="o">(</span>...<span class="o">)</span> port 32452 <span class="o">(</span><span class="c">#0)</span>
...
</code></pre></div></div>

<h4 id="3-인증서-검증">3. 인증서 검증</h4>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>openssl s_client <span class="nt">-debug</span> <span class="nt">-connect</span> https://jenkins.yourdomain.com:32452

...
<span class="nv">subject</span><span class="o">=</span>CN <span class="o">=</span> <span class="k">*</span>.yourdomain.com

<span class="nv">issuer</span><span class="o">=</span>C <span class="o">=</span> US, O <span class="o">=</span> Let<span class="s1">'s Encrypt, CN = R3
...
---
</span></code></pre></div></div>

<h4 id="4-웹-브라우저로-접속하여-인증서-확인">4. 웹 브라우저로 접속하여 인증서 확인</h4>

<p><img src="/assets/img/contents/ki-3.png" alt="ki-3.png" /></p>

<hr />
<h3 id="ssl-redirect-끄기">SSL Redirect 끄기</h3>

<p>위처럼 Ingress 설정에 tls를 적용하면 https 접속이 강제되므로 기존에 http에 운영중인 서비스에 영향이 있다.</p>

<p>따라서 기존의 http 서비스는 https로 redirect 되지 않도록 설정하여야 한다.</p>

<h4 id="1-ingress-rule-변경">1. Ingress rule 변경</h4>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">$ vim jenkins-ingress.yaml</span>

<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">networking.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Ingress</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="s">...</span>
  <span class="s">namespace</span><span class="err">:</span> <span class="s">default</span>
  <span class="s"># 아래 annotations 추가</span>
  <span class="s">annotations</span><span class="err">:</span>
    <span class="na">kubernetes.io/ingress.class</span><span class="pi">:</span> <span class="s2">"</span><span class="s">nginx"</span>
    <span class="na">nginx.ingress.kubernetes.io/ssl-redirect</span><span class="pi">:</span> <span class="s2">"</span><span class="s">false"</span>
    <span class="na">nginx.ingress.kubernetes.io/force-ssl-redirect</span><span class="pi">:</span> <span class="s2">"</span><span class="s">false"</span>
</code></pre></div></div>

<blockquote>
  <p>Ingress rule의 <code class="language-plaintext highlighter-rouge">ssl-redirect</code> 설정은 host 주소와 port는 그대로 둔채 http 요청을 https로 리다이렉트한다.(서버에서 https redirect 응답)</p>

  <p>예시) http://jenkins.yourdomain.com:31623/jenkins → https://jenkins.yourdomain.com:31623/jenkins</p>
</blockquote>

<h4 id="2-configmap-설정-변경">2. ConfigMap 설정 변경</h4>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># vim ~/ingress-controller/ingress-nginx/deploy/static/provider/baremetal/deploy.yaml</span>

<span class="c1"># Source: ingress-nginx/templates/controller-configmap.yaml</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ConfigMap</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">helm.sh/chart</span><span class="pi">:</span> <span class="s">ingress-nginx-3.23.0</span>
    <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/version</span><span class="pi">:</span> <span class="s">0.44.0</span>
    <span class="na">app.kubernetes.io/managed-by</span><span class="pi">:</span> <span class="s">Helm</span>
    <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">controller</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ingress-nginx-controller</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
<span class="c1"># 아래 부분 추가</span>
<span class="na">data</span><span class="pi">:</span>
  <span class="na">hsts</span><span class="pi">:</span> <span class="s2">"</span><span class="s">false"</span>
  <span class="na">ssl-redirect</span><span class="pi">:</span> <span class="s2">"</span><span class="s">false"</span>
</code></pre></div></div>

<blockquote>
  <p>Ingress controller의 <code class="language-plaintext highlighter-rouge">ssl-redirect</code> 설정은 host 주소는 그대로지만 https의 default port인 443으로 redirect한다.</p>

  <p>예시) http://jenkins.yourdomain.com:31623/jenkins → https://jenkins.yourdomain.com/jenkins</p>
</blockquote>

<p>ingress-controller의 baremetal template에 있는 ConfigMap으로 띄워져 있으므로 해당 부분 수정</p>

<p>만약 다른 환경으로 인하여 ConfigMap이 없는 경우 새로 생성하여 적용할 것</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl apply <span class="nt">-f</span> deploy.yaml
</code></pre></div></div>
<p>설정 변경 적용</p>

<p>추가로 적용기간에는 http와 https의 포트를 서로 다르게하여 둘 다 접속 가능하도록 만드는 것이 옳다.</p>

<p>현재 http와 https를 동시 서비스 중이기 때문에 서로 다른 포트에서 접근을 한다.</p>

<p>따라서 수동으로 Host 주소와 port를 변경해주어야 한다.</p>

<h4 id="3-ingress-rule-변경">3. Ingress rule 변경</h4>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">$ vim jenkins-ingress.yaml</span>

<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">networking.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Ingress</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="s">...</span>
  <span class="s">namespace</span><span class="err">:</span> <span class="s">default</span>
  <span class="s"># 아래 annotations 추가</span>
  <span class="s">annotations</span><span class="err">:</span>
<span class="err">  	</span><span class="na">kubernetes.io/ingress.class</span><span class="pi">:</span> <span class="s2">"</span><span class="s">nginx"</span>
    <span class="na">nginx.ingress.kubernetes.io/proxy-redirect-from</span><span class="pi">:</span> <span class="s">http://jenkins.yourdomain.com:31623</span>
    <span class="na">nginx.ingress.kubernetes.io/proxy-redirect-to</span><span class="pi">:</span> <span class="s">https://jenkins.yourdomain.com:32452</span>
    <span class="na">nginx.ingress.kubernetes.io/ssl-redirect</span><span class="pi">:</span> <span class="s2">"</span><span class="s">false"</span>
    <span class="na">nginx.ingress.kubernetes.io/force-ssl-redirect</span><span class="pi">:</span> <span class="s2">"</span><span class="s">false"</span>
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl <span class="nt">-v</span> http://jenkins.jenkins.yourdomain.com:32452
<span class="k">*</span> About to connect<span class="o">()</span> to jenkins.yourdomain.com port 32452 <span class="o">(</span><span class="c">#0)</span>
<span class="k">*</span>   Trying ...
<span class="k">*</span> Connected to jenkins.yourdomain.com <span class="o">(</span>...<span class="o">)</span> port 32425 <span class="o">(</span><span class="c">#0)</span>
<span class="o">&gt;</span> GET /jenkins HTTP/1.1
<span class="o">&gt;</span> User-Agent: curl/7.29.0
<span class="o">&gt;</span> Host: jenkins.yourdomain.com:32452
<span class="o">&gt;</span> Accept: <span class="k">*</span>/<span class="k">*</span>
<span class="o">&gt;</span>
&lt; HTTP/1.1 302 Found
&lt; Date: Fri, 05 Mar 2021 04:51:59 GMT
&lt; Content-Length: 0
&lt; Connection: keep-alive
&lt; Location: https://jenkins.yourdomain.com:32452/
</code></pre></div></div>
<p>테스트해보면 redirect가 정상적으로 되는 것을 확인할 수 있다.</p>

<h3 id="크롬의-경우-hsts-기능-끄기">크롬의 경우 HSTS 기능 끄기</h3>

<p>위와 같이 설정해도 크롬과 같은 웹브라우저의 경우 HSTS 기능때문에 웹브라우저 레벨에서</p>

<p>위에서 설정한 proxy가 아니라 호스트와 포트는 그대로인 상태로 http → https 리다이렉션이 강제된다.</p>

<blockquote>
  <p>http 접속을 한 후에 서버에서 https 응답을 주는데 http 접속 이전에 브라우저에서 https로 변경하기 때문이다.</p>

</blockquote>

<p>시크릿 모드로 들어가서 테스트하거나 이미 크롬에 설정된 HSTS 설정을 제거해야한다.</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">chrome://net-internals/#hsts</code> 접속</li>
  <li>Query HSTS/PKP domain에서 HSTS 설정되어 있는지 검색
<img src="/assets/img/contents/ki-4.png" alt="ki-4.png" /></li>
  <li>Delete domain security policies에서 해당 도메인 HSTS 설정 지우기</li>
</ol>

<p>이후 크롬을 통해 재접속하면 https redirect가 성공적으로 되는 것을 확인할 수 있다.</p>

<hr />
<h2 id="참고사항">참고사항</h2>
<ol>
  <li>Ingress controller 기본 인증서를 가져간다?</li>
</ol>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span> successfully <span class="nb">set </span>certificate verify locations:
<span class="k">*</span>   CAfile: /etc/ssl/certs/ca-certificates.crt
  CApath: /etc/ssl/certs
</code></pre></div></div>

<p>위처럼 Ingress Controller에서 기본 설정 SSL Cert를 가져간다고 나오는데 Ingress Controller에서 SSL을 설정하는 것이 아닌 Ingress의 Secret 설정에 있는 인증서 파일을 적용하는 것이기 때문에 무시해도 된다.</p>

<hr />
<h2 id="troubleshooting">Troubleshooting</h2>

<h3 id="ingress-controller-기본-인증서를-가져간다">Ingress controller 기본 인증서를 가져간다?</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span> successfully <span class="nb">set </span>certificate verify locations:
<span class="k">*</span>   CAfile: /etc/ssl/certs/ca-certificates.crt
  CApath: /etc/ssl/certs
</code></pre></div></div>

<p>위처럼 Ingress Controller에서 기본 설정 SSL Cert를 가져간다고 나오는데 Ingress Controller에서 SSL을 설정하는 것이 아닌 Ingress의 Secret 설정에 있는 인증서 파일을 적용하는 것이기 때문에 무시해도 된다.</p>

<h3 id="kubernetes-ingress-controller-fake-certificate-인증서가-적용될-때">Kubernetes Ingress Controller Fake Certificate 인증서가 적용될 때</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Certificate:
    Data:
        Version: 3 <span class="o">(</span>0x2<span class="o">)</span>
        Serial Number:
            0a:2a:7b:52:02:51:fe:7d:ff:ad:65:ea:41:8a:95:44
        Signature Algorithm: sha256WithRSAEncryption
        Issuer: O <span class="o">=</span> Acme Co, CN <span class="o">=</span> Kubernetes Ingress Controller Fake Certificate
</code></pre></div></div>

<p>Ingress에 tls 설정을 추가할 경우 기본적으로 해당 서비스는 https를 사용하게 되며 인증서 설정을 별도로 해주지 않은 경우 Ingress Controller fake certificate를 기본적으로 사용하게 된다.</p>

<p>이 경우는 위에서 설정한 인증서 적용이 안 된 경우이다.</p>

<h4 id="1-kubernetes-secret에서-cert와-key를-잘-물고-갔는지-확인">1. kubernetes secret에서 cert와 key를 잘 물고 갔는지 확인</h4>

<h4 id="2-ingress-yaml-파일에-tls-적용이-제대로-되었는지-확인">2. Ingress yaml 파일에 tls 적용이 제대로 되었는지 확인</h4>

<ul>
  <li>ssl을 적용할 경우 연동되는 서비스와 tls 설정에 host 이름을 꼭 추가해주어야한다.</li>
</ul>

<hr />

<h2 id="reference">Reference</h2>

<ol>
  <li><a href="https://kubernetes.io/docs/concepts/services-networking/ingress/">Ingress</a></li>
  <li><a href="https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/">Ingress Controllers</a></li>
  <li><a href="https://kubernetes.io/docs/concepts/configuration/secret/">Secret</a></li>
  <li><a href="https://www.udemy.com/course/certified-kubernetes-administrator-with-practice-tests/">Certified Kubernetes Administrator(CKA) with Practice Tests</a></li>
</ol>

    
  </section>

  <!-- Social media shares -->
  


   <!-- Tag list -->
  
  


  <div class="tag-list">
    <ul>
      
        <li class="meta">Tags</li>
      

      
        <li><a class="button" href="/tags#Certificate">
          <p><i class="fas fa-tag fa-fw fa-sm"></i> Certificate</p>
        </a></li>
      
        <li><a class="button" href="/tags#Ingress">
          <p><i class="fas fa-tag fa-fw fa-sm"></i> Ingress</p>
        </a></li>
      
        <li><a class="button" href="/tags#Ingress+Controller">
          <p><i class="fas fa-tag fa-fw fa-sm"></i> Ingress Controller</p>
        </a></li>
      
        <li><a class="button" href="/tags#K8S">
          <p><i class="fas fa-tag fa-fw fa-sm"></i> K8S</p>
        </a></li>
      
        <li><a class="button" href="/tags#Kubernetes">
          <p><i class="fas fa-tag fa-fw fa-sm"></i> Kubernetes</p>
        </a></li>
      
        <li><a class="button" href="/tags#Nginx">
          <p><i class="fas fa-tag fa-fw fa-sm"></i> Nginx</p>
        </a></li>
      
        <li><a class="button" href="/tags#SSL">
          <p><i class="fas fa-tag fa-fw fa-sm"></i> SSL</p>
        </a></li>
      
        <li><a class="button" href="/tags#Security">
          <p><i class="fas fa-tag fa-fw fa-sm"></i> Security</p>
        </a></li>
      
        <li><a class="button" href="/tags#TLS">
          <p><i class="fas fa-tag fa-fw fa-sm"></i> TLS</p>
        </a></li>
      
    </ul>
  </div>



</article>

<!-- Post navigation -->

<div id="post-nav">
    
    <div id="previous-post">
        <a alt="SonarQube 설치 및 Jenkins pipeline 연동하기" href="/2021/05/07/sonarqube-jenkins.html">
            <p>Previous post</p>
            SonarQube 설치 및 Jenkins pipeline 연동하기
        </a>
    </div>
    

    
    <div id="next-post">
        <a alt="Kubernetes Dashboard 설치 및 외부접속 설정" href="/2021/03/04/kubernetes-dashboard.html">
            <p>Next post</p>
            Kubernetes Dashboard 설치 및 외부접속 설정
        </a>
    </div>
    
</div>



<!--Utterances-->
 <script src="https://utteranc.es/client.js"
        repo='csupreme19/csupreme19.github.io'
        issue-term="comment"
        theme="preferred-color-scheme"
		
        crossorigin="anonymous"
        async>
</script>
 

<!-- Cusdis -->


<!-- Disqus -->


<!-- To change color of links in the page -->
<style>
  header#main {
      background-size: cover;
      background-repeat: no-repeat;
      background-position: center;
  }
  
  
  
  
  header#main { background-image: url('/assets/img/titles/nginx-logo.svg'); }
  
</style>

    </div>
    <footer class="site-footer">
    <p class="text">
        Powered by <a href="https://jekyllrb.com/">Jekyll</a> with <a href="https://github.com/sylhare/Type-on-Strap">Type on Strap</a>
</p>
            <div class="footer-icons">
                <ul>
                <!-- Social icons from Font Awesome, if enabled -->
                


    

    

    

    

    

    

    
        
        
        
        
        <li>
            <a href="https://github.com/csupreme19"
               title="Follow on Github"
               target="_blank"
               rel="me">
            <span class="fa-stack fa-lg">
              <i class="fas fa-circle fa-stack-2x"></i>
              <i class="fab fa-github fa-stack-1x fa-inverse"></i>
            </span>
            </a>
        </li>
    

    

    

    

    

    

    

    
        
        
        
        
        <li>
            <a href="mailto:csupreme19@gmail.com"
               title="Follow on Mail"
               target="_blank"
               rel="me">
            <span class="fa-stack fa-lg">
              <i class="fas fa-circle fa-stack-2x"></i>
              <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
            </span>
            </a>
        </li>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    


                </ul>
            </div>
</footer>



  </body>
</html>
