<!DOCTYPE html>
<!--
    Type on Strap jekyll theme v2.3.9
    Theme free for personal and commercial use under the MIT license
    https://github.com/sylhare/Type-on-Strap/blob/master/LICENSE
-->
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=0.5, maximum-scale=5">

    <!-- Theme Mode-->
    
    <script>
        const isAutoTheme = false;
        document.documentElement.setAttribute('data-theme', "dark")
    </script>
    

    <!-- Main JS (navbar.js, katex_init.js and masonry_init.js)-->
    <script defer src="/assets/js/main.min.js"></script>
    
    <!-- CSS -->
    <link rel="stylesheet" href="/assets/css/main.css">

    <!--Favicon-->
    <link rel="shortcut icon" href="/assets/favicon.ico" type="image/x-icon">

    <!-- RSS -->
    <link rel="alternate" type="application/atom+xml" title="Seunghoon Choi" href="http://localhost:4000/feed.xml"/>

    

    <!-- KaTeX 0.13.9 -->
    
    <script defer src="/assets/js/vendor/katex.min.js"></script>
    <script defer src="/assets/js/vendor/auto-render.min.js" onload="renderMathInElement(document.body);"></script>
    

    <!-- Mermaid 8.9.2 -->
    
    <script defer src="/assets/js/vendor/mermaid.min.js" onload="mermaid.initialize({startOnLoad:true});"></script>
    

    <!-- Simple Jekyll Search 1.9.1 -->
    <script src="/assets/js/vendor/simple-jekyll-search.min.js" type="text/javascript"></script>

    <!-- Google Analytics / Cookie Consent -->
    <script>
      const cookieName = 'cookie-notice-dismissed-http://localhost:4000';
      const isCookieConsent = 'false';
      const analyticsName = '';
    </script>

    
    

    <!-- seo tags -->
    <meta property="og:image" content="http://localhost:4000/assets/img/contents/gc-1.png">
    
    <meta property="og:type" content="website" />
    
    <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>GitLab 백업 및 기타 설정 그리고 트러블슈팅 | Seunghoon Choi</title>
<meta name="generator" content="Jekyll v4.2.1" />
<meta property="og:title" content="GitLab 백업 및 기타 설정 그리고 트러블슈팅" />
<meta name="author" content="csupreme19" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="GitLab 백업 및 기타 설정 그리고 트러블슈팅" />
<meta property="og:description" content="GitLab 백업 및 기타 설정 그리고 트러블슈팅" />
<link rel="canonical" href="http://localhost:4000/2021/02/25/gitlab-config.html" />
<meta property="og:url" content="http://localhost:4000/2021/02/25/gitlab-config.html" />
<meta property="og:site_name" content="Seunghoon Choi" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-02-25T00:00:00+09:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="GitLab 백업 및 기타 설정 그리고 트러블슈팅" />
<script type="application/ld+json">
{"datePublished":"2021-02-25T00:00:00+09:00","description":"GitLab 백업 및 기타 설정 그리고 트러블슈팅","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2021/02/25/gitlab-config.html"},"url":"http://localhost:4000/2021/02/25/gitlab-config.html","author":{"@type":"Person","name":"csupreme19"},"@type":"BlogPosting","headline":"GitLab 백업 및 기타 설정 그리고 트러블슈팅","dateModified":"2021-02-25T00:00:00+09:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <!-- RSS -->
    <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Seunghoon Choi" />

    <!-- Twitter Cards -->
    <meta name="twitter:title" content="GitLab 백업 및 기타 설정 그리고 트러블슈팅">
    <meta name="twitter:description" content="GitLab 백업 및 기타 설정 그리고 트러블슈팅Configuring Omnibus GitLabGitLab 백업, SSH, 메일 서버 등 설정Backup 설정Backup 플랜  백업 주기: 3일  백업 범위(기본값)          db (database)      uploads ...">
    
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="http://localhost:4000/assets/img/contents/gc-1.png">
    <meta name="twitter:image:alt" content="GitLab 백업 및 기타 설정 그리고 트러블슈팅">
</head>

  <body>
    <header class="site-header">

    <!-- Logo and title -->
	<div class="branding">
        
		<a href="/">
			<img alt="logo img" class="avatar" src="/assets/img/profile-icon.jpeg" />
		</a>
        
        <a class="site-title" aria-label="Seunghoon Choi" href="/">
        Seunghoon Choi
		</a>
	</div>

    <!-- Toggle menu -->
    <nav class="clear">
    <a aria-label="pull" id="pull" class="toggle" href="#">
    <i class="fas fa-bars fa-lg"></i>
    </a>

    <!-- Menu -->
    <ul class="hide">
        

        
            
            
        
            
            <li class="separator"> | </li>
            <li>
                <a class="clear" aria-label="About" title="About" href="/about/">
                     About 
                </a>
            </li>
            
            
        
            
            <li class="separator"> | </li>
            <li>
                <a class="clear" aria-label="Gallery" title="Gallery" href="/gallery/">
                     Gallery 
                </a>
            </li>
            
            
        
            
            
        
            
            
        
            
            <li class="separator"> | </li>
            <li>
                <a class="clear" aria-label="Portfolio" title="Portfolio" href="/portfolio/">
                     Portfolio 
                </a>
            </li>
            
            
        
            
            
        
            
            <li class="separator"> | </li>
            <li>
                <a class="clear" aria-label="Search" title="Search" href="/search/">
                     <i class="fas fa-search" aria-hidden="true"></i>
                    
                </a>
            </li>
            
            
        
            
            <li class="separator"> | </li>
            <li>
                <a class="clear" aria-label="Tags" title="Tags" href="/tags/">
                     <i class="fas fa-tags" aria-hidden="true"></i>
                    
                </a>
            </li>
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
        
        
    </ul>

	</nav>
</header>

    <div class="content">
      <article class="feature-image" >
  <header id="main" style="">
    <div class="title-padder">
      
      <h1 id="GitLab+%EB%B0%B1%EC%97%85+%EB%B0%8F+%EA%B8%B0%ED%83%80+%EC%84%A4%EC%A0%95+%EA%B7%B8%EB%A6%AC%EA%B3%A0+%ED%8A%B8%EB%9F%AC%EB%B8%94%EC%8A%88%ED%8C%85" class="title">GitLab 백업 및 기타 설정 그리고 트러블슈팅</h1>
      


<div class="post-info"><a href="https://github.com/csupreme19" target="_blank">
      <img alt="Author's avatar" src="https://avatars.githubusercontent.com/u/76021703?s=400&v=4">
    
    <p class="meta">
      csupreme19 - 
      
      February 25, 2021
    </p></a></div>

      
    </div>
  </header>

  <section class="post-content">
  
      <h1 id="gitlab-백업-및-기타-설정-그리고-트러블슈팅">GitLab 백업 및 기타 설정 그리고 트러블슈팅</h1>

<p><img src="/assets/img/titles/gitlab-horizontal-color.png" alt="gitlab-horizontal-color.png" /></p>

<p><a href="https://docs.gitlab.com/omnibus/settings/README.html">Configuring Omnibus GitLab</a></p>

<p>GitLab 백업, SSH, 메일 서버 등 설정</p>

<hr />
<h2 id="backup-설정">Backup 설정</h2>
<h3 id="backup-플랜">Backup 플랜</h3>

<ul>
  <li>백업 주기: 3일</li>
  <li>백업 범위(기본값)
    <ul>
      <li><code class="language-plaintext highlighter-rouge">db</code> (database)</li>
      <li><code class="language-plaintext highlighter-rouge">uploads</code> (attachments)</li>
      <li><code class="language-plaintext highlighter-rouge">builds</code> (CI job output logs)</li>
      <li><code class="language-plaintext highlighter-rouge">artifacts</code> (CI job artifacts)</li>
      <li><code class="language-plaintext highlighter-rouge">lfs</code> (LFS objects)</li>
      <li><code class="language-plaintext highlighter-rouge">registry</code> (Container Registry images)</li>
      <li><code class="language-plaintext highlighter-rouge">pages</code> (Pages content)</li>
      <li><code class="language-plaintext highlighter-rouge">repositories</code> (Git repositories data)</li>
    </ul>
  </li>
  <li>백업 위치: GitLab 로컬, nas의 nfs</li>
  <li>백업 실행: 3일마다 새벽 2시</li>
  <li>보관 주기: 30일</li>
</ul>

<blockquote>
  <p><code class="language-plaintext highlighter-rouge">gitlab.rb</code>, <code class="language-plaintext highlighter-rouge">gitlab-secrets.json</code>과 같은 설정파일들은 기본적으로 백업되지 않으며 필요시 별도로 백업 실행</p>
</blockquote>

<h3 id="수동-backup">수동 Backup</h3>

<h4 id="1-백업-실행">1. 백업 실행</h4>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> gitlab-ce bash <span class="c"># -t: 실행 쉘 확인 용도</span>
<span class="nv">$ </span>gitlab-backup create

<span class="c"># 12.1 이하 버전인 경우</span>
<span class="nv">$ </span>gitlab-rake gitlab:backup:create
</code></pre></div></div>

<h4 id="2-백업-파일-확인">2. 백업 파일 확인</h4>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># cd {docker_volume}/gitlab/data/backups</span>
<span class="nv">$ </span><span class="nb">cd</span> /data/docker_volumes/gitlab/data/backups
</code></pre></div></div>

<p>[TIMESTAMP]_gitlab_backup.tar 생성 확인</p>

<h4 id="3-설정-파일-백업시">3. 설정 파일 백업시</h4>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/data/docker_volumes/gitlab/config/gitlab-secrets.json
/data/docker_volumes/gitlab/config/gitlab.rb
</code></pre></div></div>

<p>위 두 파일 별도로 백업할 것</p>

<h3 id="수동-restore">수동 Restore</h3>

<h4 id="1-복구-준비">1. 복구 준비</h4>

<ol>
  <li>
    <h5 id="복구된-버전과-복구하려는-gitlab-버전이-같아야함">복구된 버전과 복구하려는 gitlab 버전이 같아야함</h5>
  </li>
  <li>
    <h5 id="gitlab-reconfigure-실행-필요">gitlab reconfigure 실행 필요</h5>
  </li>
  <li>
    <h5 id="gitlab이-실행되고-있어야함">gitlab이 실행되고 있어야함</h5>
  </li>
  <li>
    <h5 id="복구할-파일tar-위치는-varoptgitlabbackups-에-있다고-가정">복구할 파일(.tar) 위치는 /var/opt/gitlab/backups 에 있다고 가정</h5>
  </li>
</ol>

<p>DB 접근하는 프로세스 종료</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># gitlab shell 진입</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> gitlab-ce bash

<span class="c"># process 정지 처리</span>
<span class="nv">$ </span>gitlab-ctl stop unicorn
<span class="nv">$ </span>gitlab-ctl stop puma
<span class="nv">$ </span>gitlab-ctl stop sidekiq

<span class="c"># 종료 확인</span>
<span class="nv">$ </span>gitlab-ctl status 
</code></pre></div></div>

<h4 id="2-복구-실행">2. 복구 실행</h4>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">chmod </span>0644 1612940314_2021_092_10_13.8.1_gitlab_backup.tar	<span class="c"># 모든 사용자 읽기 권한 추가</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-t</span> gitlab-ce gitlab-backup restore <span class="nv">BACKUP</span><span class="o">={</span>TIMESTAMP<span class="o">}</span> <span class="nv">force</span><span class="o">=</span><span class="nb">yes</span>

<span class="c"># 12.1 이하 버전인 경우</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-t</span> gitlab-ce gitlab-rake gitlab:backup:restore <span class="nv">BACKUP</span><span class="o">={</span>TIMESTAMP<span class="o">}</span> <span class="nv">force</span><span class="o">=</span><span class="nb">yes</span>
</code></pre></div></div>

<p>예를 들어 파일명이 1612940314_2021_092_10_13.8.1_gitlab_backup.tar이라면</p>

<p>[TIMESTAMP]_gitlab_backup.tar 이므로 TIMESTAMP는 1612940314_2021_092_10_13.8.1</p>

<p>복구 시점에 psql must be owner of 관련 오류는 정상임</p>

<h4 id="3-서비스-재구동-및-점검">3. 서비스 재구동 및 점검</h4>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> gitlab-ce bash
<span class="nv">$ </span>gitlab-ctl reconfigure
<span class="nv">$ </span>gitlab-ctl restart

<span class="nv">$ </span>gitlab-rake gitlab:check <span class="nv">SANITIZE</span><span class="o">=</span><span class="nb">true</span>
</code></pre></div></div>

<h3 id="자동-backup-설정">자동 Backup 설정</h3>

<h4 id="1-nfs-설정">1. NFS 설정</h4>

<p>mount 및 권한 설정은 완료되었다는 가정하에 작성하였습니다.</p>

<p>GitLab 백업 폴더 생성</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># mkdir -p {nfs 볼륨 경로}/gitlab/data/backups</span>
<span class="nv">$ </span><span class="nb">mkdir</span> <span class="nt">-p</span> /nfs_nas/volumes/gitlab/data/backups
</code></pre></div></div>

<h4 id="2-docker-compose-설정">2. docker compose 설정</h4>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># docker_compose yaml 설정 파일</span>
<span class="nv">$ </span>vim ~/gitlab-ce/docker-compose.yml
</code></pre></div></div>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">...</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="na">GITLAB_OMNIBUS_CONFIG</span><span class="pi">:</span> <span class="pi">|</span>
        <span class="s">gitlab_rails['backup_keep_time'] = 2592000</span>
<span class="s">...</span>
</code></pre></div></div>

<p>gitlab_rails 설정값 변경(추가)</p>

<ul>
  <li>backup_path: 백업 경로(local)</li>
  <li>backup_keep_time: 백업 파일 보관 주기 (2592000초 = 30일)</li>
</ul>

<p>gitlab이 설치된 volume의  gitlab.rb 설정파일 수정해도 됨</p>

<h4 id="3-백업-스크립트-작성">3. 백업 스크립트 작성</h4>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>vim ~/gitlab-ce/gitlab_backup.sh
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="c">#!/bin/sh</span>
 <span class="nv">BACKUP_DIR</span><span class="o">=</span><span class="s1">'/data/docker_volumes/gitlab/data/backups'</span>
 <span class="nv">BACKUP_REMOTE_DIR</span><span class="o">=</span><span class="s1">'/nfs_nas1/volumes/gitlab/data/backups'</span>
 <span class="nv">BACKUP_REMOTE_DIR2</span><span class="o">=</span><span class="s1">'/nfs_nas2/backups/gitlab'</span>
 <span class="nv">BACKUP_LIFETIME</span><span class="o">=</span>30
 docker <span class="nb">exec </span>gitlab-ce gitlab-backup create <span class="nv">CRON</span><span class="o">=</span>1
 <span class="nv">BACKUP_FILE</span><span class="o">=</span><span class="sb">`</span><span class="nb">ls</span> <span class="nt">-t</span> <span class="nv">$BACKUP_DIR</span> | <span class="nb">head</span> <span class="nt">-n</span> 1<span class="sb">`</span>
 <span class="nb">echo</span> <span class="s2">"gitlab-backup create::: </span><span class="nv">$BACKUP_DIR</span><span class="s2">/</span><span class="nv">$BACKUP_FILE</span><span class="s2"> "</span>

 <span class="nv">BACKUP_REMOVE_FILES</span><span class="o">=</span><span class="sb">`</span>find <span class="nv">$BACKUP_DIR</span> <span class="nt">-name</span> <span class="s2">"*_gitlab_backup.tar"</span> <span class="nt">-mtime</span> +<span class="nv">$BACKUP_LIFETIME</span> <span class="nt">-type</span> f<span class="sb">`</span>
 <span class="k">if</span> <span class="o">[</span> <span class="nt">-n</span> <span class="s2">"</span><span class="nv">$BACKUP_REMOVE_FILES</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
 </span><span class="nb">echo</span> <span class="s2">"gitlab-backup remove old backups::: </span><span class="nv">$BACKUP_REMOVE_FILES</span><span class="s2">"</span>
 <span class="nb">rm</span> <span class="nt">-rf</span> <span class="nv">$BACKUP_REMOVE_FILES</span>
 <span class="k">fi

 </span><span class="nv">BACKUP_REMOTE_REMOVE_FILES</span><span class="o">=</span><span class="sb">`</span>find <span class="nv">$BACKUP_REMOTE_DIR</span> <span class="nt">-name</span> <span class="s2">"*_gitlab_backup.tar"</span> <span class="nt">-mtime</span> +<span class="nv">$BACKUP_LIFETIME</span> <span class="nt">-type</span> f<span class="sb">`</span>
 <span class="k">if</span> <span class="o">[</span> <span class="nt">-n</span> <span class="s2">"</span><span class="nv">$BACKUP_REMOTE_REMOVE_FILES</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
 </span><span class="nb">echo</span> <span class="s2">"gitlab-backup remove old backups::: </span><span class="nv">$BACKUP_REMOTE_REMOVE_FILES</span><span class="s2">"</span>
 <span class="nb">rm</span> <span class="nt">-rf</span> <span class="nv">$BACKUP_REMOTE_REMOVE_FILES</span>
 <span class="k">fi

 </span><span class="nv">BACKUP_REMOTE_REMOVE_FILES2</span><span class="o">=</span><span class="sb">`</span>find <span class="nv">$BACKUP_REMOTE_DIR2</span> <span class="nt">-name</span> <span class="s2">"*_gitlab_backup.tar"</span> <span class="nt">-mtime</span> +<span class="nv">$BACKUP_LIFETIME</span> <span class="nt">-type</span> f<span class="sb">`</span>
 <span class="k">if</span> <span class="o">[</span> <span class="nt">-n</span> <span class="s2">"</span><span class="nv">$BACKUP_REMOTE_REMOVE_FILES2</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
 </span><span class="nb">echo</span> <span class="s2">"gitlab-backup remove old backups::: </span><span class="nv">$BACKUP_RETMOE_REMOVE_FILES2</span><span class="s2">"</span>
 <span class="nb">rm</span> <span class="nt">-rf</span> <span class="nv">$BACKUP_REMOTE_REMOVE_FILES2</span>
 <span class="k">fi

 </span><span class="nb">cp</span> <span class="nv">$BACKUP_DIR</span>/<span class="nv">$BACKUP_FILE</span> <span class="nv">$BACKUP_REMOTE_DIR</span>
 <span class="nb">echo</span> <span class="s2">"gitlab-backup copy to storage::: </span><span class="nv">$BACKUP_REMOTE_DIR</span><span class="s2">/</span><span class="nv">$BACKUP_FILE</span><span class="s2"> </span><span class="nv">$BACKUP_REMOTE_DIR</span><span class="s2">/</span><span class="nv">$BACKUP_FILE</span><span class="s2">"</span>
 <span class="nb">cp</span> <span class="nv">$BACKUP_DIR</span>/<span class="nv">$BACKUP_FILE</span> <span class="nv">$BACKUP_REMOTE_DIR2</span>
 <span class="nb">echo</span> <span class="s2">"gitlab-backup copy to storage::: </span><span class="nv">$BACKUP_REMOTE_DIR2</span><span class="s2">/</span><span class="nv">$BACKUP_FILE</span><span class="s2"> </span><span class="nv">$BACKUP_REMOTE_DIR2</span><span class="s2">/</span><span class="nv">$BACKUP_FILE</span><span class="s2">"</span>
 <span class="nb">echo</span> <span class="s2">"gitlab-backup done."</span>
</code></pre></div></div>

<blockquote>
  <p>위 스크립트는 백업 명령 실행 후 백업 파일을 mv, rm 하는 간단한 스크립트이며 상황별로 다를 수 있음</p>
</blockquote>

<h4 id="4-백업-cron-등록">4. 백업 cron 등록</h4>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>crontab <span class="nt">-e</span>
0 2 <span class="k">*</span>/3 <span class="k">*</span> <span class="k">*</span> /root/gitlab-ce/gitlab_backup.sh <span class="o">&gt;</span> /root/gitlab-ce/gitlab_backup.sh.log
</code></pre></div></div>

<p>gitlab 컨테이너 내부에서 crontab 설정도 가능</p>

<ul>
  <li>CRON=1: 에러가 발생한 경우에만 출력</li>
</ul>

<h4 id="5-cron-테스트">5. cron 테스트</h4>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>run-parts /var/spool/cron <span class="nt">-v</span>
</code></pre></div></div>

<hr />
<h2 id="email-설정smtp">Email 설정(SMTP)</h2>

<blockquote>
  <p>docker container 환경에서 gitlab의 email 설정</p>
</blockquote>

<h3 id="사전-준비-사항">사전 준비 사항</h3>
<ul>
  <li>mail server 정보 확인: gmail 또는 별도 무료 사용 가능한 mail server 확보</li>
  <li>
    <p>본 문서에서는 mailgun 서버를 적용</p>
  </li>
  <li><a href="https://docs.gitlab.com/omnibus/settings/smtp.html#mailgun">SMTP Settings#Mailgun</a></li>
</ul>

<h3 id="smtp-설정">SMTP 설정</h3>

<h4 id="1-gitlab의-설정파일-수정">1. gitlab의 설정파일 수정</h4>
<p>docker-compose.yml의 gitlab environment에 추가 또는 gitlab 설치된 volume에서 gitlab.rb 파일 찾아 수정</p>

<p>해당 파일 내용 중 mailgun 메일서버 정보를 추가</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># mailgun smtp 설정</span>
gitlab_rails[<span class="s1">'smtp_enable'</span><span class="o">]</span> <span class="o">=</span> <span class="nb">true
</span>gitlab_rails[<span class="s1">'smtp_address'</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"smtp.mailgun.org"</span>
gitlab_rails[<span class="s1">'smtp_port'</span><span class="o">]</span> <span class="o">=</span> 587
gitlab_rails[<span class="s1">'smtp_authentication'</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"plain"</span>
gitlab_rails[<span class="s1">'smtp_enable_starttls_auto'</span><span class="o">]</span> <span class="o">=</span> <span class="nb">true
</span>gitlab_rails[<span class="s1">'smtp_user_name'</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"mail서버 발급받은 id"</span>
gitlab_rails[<span class="s1">'smtp_password'</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"암호"</span>
gitlab_rails[<span class="s1">'smtp_domain'</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"mg.gitlab.com"</span>
</code></pre></div></div>

<h4 id="2-docker-container-재기동">2. docker container 재기동</h4>

<h4 id="3-mail-보내기-테스트">3. mail 보내기 테스트</h4>

<p>gitlab의 shell로 진입</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> &lt;container <span class="nb">id</span><span class="o">&gt;</span> bash
</code></pre></div></div>
<p>gitlab-rails console 실행</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>gitlab-rails console
</code></pre></div></div>
<p>gitlab-rails console 상에서 mail 보내기 테스트</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>Notify.test_email<span class="o">(</span><span class="s1">'&lt;받는 email address&gt;'</span>, <span class="s1">'&lt;email 제목&gt;'</span>, <span class="s1">'&lt;email 내용&gt;'</span><span class="o">)</span>.deliver_now
</code></pre></div></div>
<p>email이 왔는지 확인</p>

<hr />
<h2 id="ssh-key-설정">SSH Key 설정</h2>

<h3 id="ssh-key-등록">SSH Key 등록</h3>

<h4 id="1-접속하고자-하는-사용자에서-ssh-key-발급">1. 접속하고자 하는 사용자에서 SSH Key 발급</h4>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ssh-keygen <span class="nt">-t</span> rsa
</code></pre></div></div>

<p>RSA 키 발급, passphrase는 일반적으로 비워둠(Enter)</p>

<h4 id="2-발급된-public-key-확인">2. 발급된 Public key 확인</h4>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">chmod </span>755 ~/.ssh/id_rsa.pub
vi ~/.ssh/id_rsa.pub
</code></pre></div></div>

<p>id_rsa.pub안의 퍼블릭키 복사해두기</p>

<h4 id="3-gitlab-계정에-public-key-등록">3. GitLab 계정에 public key 등록</h4>

<p><img src="/assets/img/contents/gc-1.png" alt="gc-1.png" /></p>

<p>User Settings - SSH Keys</p>

<p>id_rsa.pub에 있는 전체 키 내용 복사하여 붙여넣기</p>

<p>Title은 자신이 구분할  수 있는 제목 아무거나</p>

<p>만료일은 해당 키의 만료일로 설정</p>

<h4 id="4-git-계정-설정">4. git 계정 설정</h4>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git config <span class="nt">--global</span> user.name <span class="s2">"{USERNAME}"</span>
git config <span class="nt">--global</span> user.email <span class="o">{</span>USER_EMAIL<span class="o">}</span>
</code></pre></div></div>

<p>USERNAME: gitlab 계정명
USER_EMAIL: gitlab 계정의 이메일 주소</p>

<h4 id="5-ssh-접속-확인">5. SSH 접속 확인</h4>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ssh -T git@{host} -p {port} -v</span>
<span class="nv">$ </span>ssh <span class="nt">-T</span> git@gitlab.yourdomain.com <span class="nt">-p</span> 20722 <span class="nt">-v</span>
Welcome to GitLab, @csupreme!
</code></pre></div></div>

<p>-p: 포트 설정</p>

<p>-v: 디버그 로그 확인</p>

<p>처음 접속시 호스트 키 저장 여부를 물으면 yes</p>

<h4 id="6-git-clone-확인">6. Git clone 확인</h4>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># git clone ssh://git@{host}:{port}/{repository}.git</span>
git clone ssh://git@gitlab.yourdomain.com:20722/csupreme/commit-test.git
</code></pre></div></div>

<p>별도의 사용자, 암호 입력 없이 SSH Key를 이용하여 clone 확인</p>

<hr />
<h2 id="nginx-ssl-설정">Nginx SSL 설정</h2>
<h3 id="선행사항">선행사항</h3>

<ul>
  <li>Docker Container 환경(GitLab Omnibus)</li>
  <li>Let’s Encrypt Key 발급 완료</li>
</ul>

<h3 id="nginx-설정">Nginx 설정</h3>

<h4 id="1-docker_composeyml-수정">1. docker_compose.yml 수정</h4>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="na">environment</span><span class="pi">:</span>
      <span class="na">GITLAB_OMNIBUS_CONFIG</span><span class="pi">:</span> <span class="pi">|</span>
        <span class="s">letsencrypt['enable'] = false</span>
        <span class="s">external_url 'https://gitlab.yourdomain.com:20443'</span>
        <span class="s">nginx['redirect_http_to_https'] = true</span>
    <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s1">'</span><span class="s">20780:20443'</span>
        <span class="pi">-</span> <span class="s1">'</span><span class="s">20443:20443'</span>
        <span class="pi">-</span> <span class="s1">'</span><span class="s">20722:22'</span>
</code></pre></div></div>

<p>letsencrypt[‘enable’] = false로 설정하는 이유</p>

<p>gitlab-ctl reconfigure시 자동으로 인증서를 갱신하여 덮어쓰기 때문</p>

<p>수동으로 발급한 인증서이므로 letsencrypt의 자동 갱신 기능을 비활성화 하기 위해</p>

<h4 id="2-ssl-인증서-복사">2. SSL 인증서 복사</h4>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 참고) 컨테이너 /etc/gitlab에 마운트된 경로</span>
<span class="nv">$ </span><span class="nb">sudo mkdir</span> <span class="nt">-p</span> /data/docker_volumes/gitlab/config/ssl
<span class="nv">$ </span><span class="nb">sudo chmod </span>755 /data/docker_volumes/gitlab/config/ssl
<span class="nv">$ </span><span class="nb">cp</span> /etc/letsencrypt/live/yourdomain.com/privkey.pem /data/docker_volumes/gitlab_2/config/ssl
<span class="nv">$ </span><span class="nb">cp</span> /etc/letsencrypt/live/yourdomain.com/fullchain.pem /data/docker_volumes/gitlab_2/config/ssl
</code></pre></div></div>

<h4 id="3-pem-변환">3. PEM 변환</h4>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>openssl rsa <span class="nt">-in</span> privkey.pem <span class="nt">-text</span> <span class="o">&gt;</span> gitlab.yourdomain.com.key
<span class="nv">$ </span>openssl x509 <span class="nt">-inform</span> PEM <span class="nt">-in</span> fullchain.pem <span class="nt">-out</span> gitlab.yourdomain.com.crt
</code></pre></div></div>

<h4 id="4-gitlab-재설정">4. GitLab 재설정</h4>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-t</span> gitlab-ce gitlab-ctl reconfigure

<span class="c"># 도커 포트 매핑이 변경된 경우 컨테이너 재실행 필요</span>
<span class="nv">$ </span>docker-compose down
<span class="nv">$ </span>docker-compose up <span class="nt">-d</span>
</code></pre></div></div>

<h4 id="5-https-접속-확인-및-인증서-확인">5. Https 접속 확인 및 인증서 확인</h4>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat</span> /data/docker_volumes/gitlab/logs/nginx/gitlab_access.log
</code></pre></div></div>
<p><img src="/assets/img/contents/gc-2.png" alt="gc-2.png" /></p>

<hr />

<h2 id="troubleshooting">Troubleshooting</h2>

<h3 id="1-ssh-connection은-성공이지만-서버에서-connection을-닫을-때">1. SSH Connection은 성공이지만 서버에서 Connection을 닫을 때</h3>

<p><img src="/assets/img/contents/gc-3.png" alt="gc-3.png" /></p>

<p>로그 확인</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat</span> /data/docker_volumes/gitlab/logs/sshd/current
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2021-02-10_01:55:53.62004 @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
2021-02-10_01:55:53.62005 @         WARNING: UNPROTECTED PRIVATE KEY FILE!          @
2021-02-10_01:55:53.62005 @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
2021-02-10_01:55:53.62005 Permissions 0755 <span class="k">for</span> <span class="s1">'/etc/gitlab/ssh_host_rsa_key'</span> are too open.
2021-02-10_01:55:53.62006 It is required that your private key files are NOT accessible by others.
2021-02-10_01:55:53.62006 This private key will be ignored.
2021-02-10_01:55:53.62006 key_load_private: bad permissions
2021-02-10_01:55:53.62006 Could not load host key: /etc/gitlab/ssh_host_rsa_key
2021-02-10_01:55:53.62007 @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
2021-02-10_01:55:53.62007 @         WARNING: UNPROTECTED PRIVATE KEY FILE!          @
2021-02-10_01:55:53.62007 @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
2021-02-10_01:55:53.62007 Permissions 0755 <span class="k">for</span> <span class="s1">'/etc/gitlab/ssh_host_ecdsa_key'</span> are too open.
2021-02-10_01:55:53.62007 It is required that your private key files are NOT accessible by others.
2021-02-10_01:55:53.62007 This private key will be ignored.
2021-02-10_01:55:53.62007 key_load_private: bad permissions
2021-02-10_01:55:53.62014 Could not load host key: /etc/gitlab/ssh_host_ecdsa_key
2021-02-10_01:55:53.62014 @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
2021-02-10_01:55:53.62015 @         WARNING: UNPROTECTED PRIVATE KEY FILE!          @
2021-02-10_01:55:53.62015 @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
2021-02-10_01:55:53.62019 Permissions 0755 <span class="k">for</span> <span class="s1">'/etc/gitlab/ssh_host_ed25519_key'</span> are too open.
2021-02-10_01:55:53.62019 It is required that your private key files are NOT accessible by others.
2021-02-10_01:55:53.62019 This private key will be ignored.
2021-02-10_01:55:53.62020 key_load_private: bad permissions
2021-02-10_01:55:53.62020 Could not load host key: /etc/gitlab/ssh_host_ed25519_key

</code></pre></div></div>

<p>Private Key 파일 권한이 755로 되어 있어 SSHD에서 자체적으로 Bad Permission을 리턴</p>

<h4 id="권한-수정">권한 수정</h4>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">chmod </span>600 ssh_host_ecdsa_key
<span class="nv">$ </span><span class="nb">chmod </span>600 ssh_host_ed25519_key
<span class="nv">$ </span><span class="nb">chmod </span>600 ssh_host_rsa_key
<span class="nv">$ </span><span class="nb">chmod </span>644 ssh_host_ecdsa_key.pub
<span class="nv">$ </span><span class="nb">chmod </span>644 ssh_host_ed25519_key.pub
<span class="nv">$ </span><span class="nb">chmod </span>644 ssh_host_rsa_key.pub
</code></pre></div></div>

<h4 id="접속-및-커밋-확인">접속 및 커밋 확인</h4>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ssh <span class="nt">-T</span> git@gitlab.yourdomain.com <span class="nt">-p</span> 20722
Welcome to GitLab, @csupreme!
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>git clone ssh://git@gitlab.yourdomain.com:20722/csupreme/commit-test.git
</code></pre></div></div>

<h3 id="2-ssh-접속시-아래와-같이-host-정보가-변경되었다고-나올-때">2. ssh 접속시 아래와 같이 Host 정보가 변경되었다고 나올 때</h3>

<p><img src="/assets/img/contents/gc-4.png" alt="gc-4.png" /></p>

<p>기존 서버의 IP는 동일하지만 서버의 SHA256 fingerprint가 바뀐 상황</p>

<p>ssh의 known_host에 있는 해당 서버의 RSA Host key키 부분을 삭제한 뒤 접속하면 된다.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>vim /Users/<span class="o">{</span>USERNAME<span class="o">}</span>/.ssh/known_hosts
</code></pre></div></div>

<p><img src="/assets/img/contents/gc-5.png" alt="gc-5.png" /></p>

<p>접속시 바뀐 호스트 키 등록 yes후 진행</p>

<hr />

<h2 id="reference">Reference</h2>

<ol>
  <li><a href="https://docs.gitlab.com/omnibus/settings/README.html">Configuring Omnibus GitLab</a></li>
  <li><a href="https://docs.gitlab.com/omnibus/settings/smtp.html#mailgun">SMTP Settings#Mailgun</a></li>
</ol>

    
  </section>

  <!-- Social media shares -->
  


   <!-- Tag list -->
  
  


  <div class="tag-list">
    <ul>
      
        <li class="meta">Tags</li>
      

      
        <li><a class="button" href="/tags#Backup">
          <p><i class="fas fa-tag fa-fw fa-sm"></i> Backup</p>
        </a></li>
      
        <li><a class="button" href="/tags#Docker">
          <p><i class="fas fa-tag fa-fw fa-sm"></i> Docker</p>
        </a></li>
      
        <li><a class="button" href="/tags#Git">
          <p><i class="fas fa-tag fa-fw fa-sm"></i> Git</p>
        </a></li>
      
        <li><a class="button" href="/tags#Gitlab">
          <p><i class="fas fa-tag fa-fw fa-sm"></i> Gitlab</p>
        </a></li>
      
        <li><a class="button" href="/tags#Nginx">
          <p><i class="fas fa-tag fa-fw fa-sm"></i> Nginx</p>
        </a></li>
      
        <li><a class="button" href="/tags#Restore">
          <p><i class="fas fa-tag fa-fw fa-sm"></i> Restore</p>
        </a></li>
      
        <li><a class="button" href="/tags#SMTP">
          <p><i class="fas fa-tag fa-fw fa-sm"></i> SMTP</p>
        </a></li>
      
        <li><a class="button" href="/tags#SSH">
          <p><i class="fas fa-tag fa-fw fa-sm"></i> SSH</p>
        </a></li>
      
        <li><a class="button" href="/tags#SSL">
          <p><i class="fas fa-tag fa-fw fa-sm"></i> SSL</p>
        </a></li>
      
        <li><a class="button" href="/tags#TLS">
          <p><i class="fas fa-tag fa-fw fa-sm"></i> TLS</p>
        </a></li>
      
    </ul>
  </div>



</article>

<!-- Post navigation -->

<div id="post-nav">
    
    <div id="previous-post">
        <a alt="Let's Encrypt 인증서 발급 및 갱신" href="/2021/02/25/letsencrypt-renew.html">
            <p>Previous post</p>
            Let's Encrypt 인증서 발급 및 갱신
        </a>
    </div>
    

    
    <div id="next-post">
        <a alt="CentOS 파티션 생성 및 마운트" href="/2021/02/25/centos-partition-mount.html">
            <p>Next post</p>
            CentOS 파티션 생성 및 마운트
        </a>
    </div>
    
</div>



<!--Utterances-->
 <script src="https://utteranc.es/client.js"
        repo='csupreme19/csupreme19.github.io'
        issue-term="comment"
        theme="preferred-color-scheme"
		
        crossorigin="anonymous"
        async>
</script>
 

<!-- Cusdis -->


<!-- Disqus -->


<!-- To change color of links in the page -->
<style>
  header#main {
      background-size: cover;
      background-repeat: no-repeat;
      background-position: center;
  }
  
  
  
  
  header#main { background-image: url('/assets/img/titles/gitlab-horizontal-color.png'); }
  
</style>

    </div>
    <footer class="site-footer">
    <p class="text">
        Powered by <a href="https://jekyllrb.com/">Jekyll</a> with <a href="https://github.com/sylhare/Type-on-Strap">Type on Strap</a>
</p>
            <div class="footer-icons">
                <ul>
                <!-- Social icons from Font Awesome, if enabled -->
                


    

    

    

    

    

    

    
        
        
        
        
        <li>
            <a href="https://github.com/csupreme19"
               title="Follow on Github"
               target="_blank"
               rel="me">
            <span class="fa-stack fa-lg">
              <i class="fas fa-circle fa-stack-2x"></i>
              <i class="fab fa-github fa-stack-1x fa-inverse"></i>
            </span>
            </a>
        </li>
    

    

    

    

    

    

    

    
        
        
        
        
        <li>
            <a href="mailto:csupreme19@gmail.com"
               title="Follow on Mail"
               target="_blank"
               rel="me">
            <span class="fa-stack fa-lg">
              <i class="fas fa-circle fa-stack-2x"></i>
              <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
            </span>
            </a>
        </li>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    


                </ul>
            </div>
</footer>



  </body>
</html>
