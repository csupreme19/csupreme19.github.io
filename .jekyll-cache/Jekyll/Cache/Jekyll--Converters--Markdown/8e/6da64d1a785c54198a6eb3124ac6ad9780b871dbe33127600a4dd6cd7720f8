I"9Ê<h1 id="tomcat-session-clustering-ì ìš©ê¸°">Tomcat session clustering ì ìš©ê¸°</h1>

<p><img src="/assets/img/titles/tomcat-logo.svg" alt="tomcat-logo.png" /></p>

<p><a href="http://tomcat.apache.org/tomcat-9.0-doc/cluster-howto.html">Clustering/Session Replication How-To</a></p>

<p>ë³¸ ë¬¸ì„œì—ì„œëŠ” Kubernetes í™˜ê²½ì—ì„œì˜ Tomcatê°„ ì„¸ì…˜ ê³µìœ ë¥¼ ìœ„í•œ session clustering ì ìš©ê¸°ë¥¼ ë‹¤ë£¬ë‹¤.</p>

<hr />

<h2 id="ë¬¸ì œì ">ë¬¸ì œì </h2>

<div class="mermaid">
  flowchart LR
  subgraph k8s
  subgraph Node A
  A[Tomcat A]
  end
  subgraph Node B
  B[Tomcat B]
  end
  C[Service]
  end
  D[User]
  D--&gt;C
  C--&gt;A &amp; B
  A x-.session.-x B
</div>

<p>Spring boot ê¸°ë°˜ Tomcat  ì„œë¹„ìŠ¤ëŠ” í´ë¼ì´ì–¸íŠ¸ì—ì„œ ìš”ì²­ì‹œ ì„¸ì…˜ì„ Tomcatì´ ì˜¬ë¼ê°€ ìˆëŠ” ë…¸ë“œì—ë§Œ local ì €ì¥ëœë‹¤.</p>

<p>ì´ ê²½ìš° Pod replication, crash/shutdown ë“±ìœ¼ë¡œ ì¸í•˜ì—¬ ë…¸ë“œê°„ ì„¸ì…˜ì´ ê³µìœ ë˜ì§€ ì•Šì•„ ì ‘ì†ì´ ëŠê¸°ëŠ” ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆìŒ</p>

<hr />

<h2 id="ìš”êµ¬ì‚¬í•­">ìš”êµ¬ì‚¬í•­</h2>

<p>Kubernetes í´ëŸ¬ìŠ¤í„° ë‚´ì—ì„œ Pod ê°„ ì„¸ì…˜ì„ ìœ ì§€í•  ìˆ˜ ìˆëŠ” ë°©ë²• ìˆ˜ë¦½</p>

<ol>
  <li>ìœ ì§€ë³´ìˆ˜ê°€ ì‰¬ìš¸ ê²ƒ(ê´€ë¦¬ í¬ì¸íŠ¸ ì ì„ ê²ƒ)</li>
  <li>ì–´í”Œë¦¬ì¼€ì´ì…˜(ì„œë¹„ìŠ¤) ì½”ë“œì— ì˜í–¥ì´ ì—†ì„ ê²ƒ</li>
  <li>êµ¬ì„±í•˜ëŠ”ë° ì¶”ê°€ì ì¸ ë¦¬ì†ŒìŠ¤ê°€ ë“¤ì–´ê°€ì§€ ì•Šì„ ê²ƒ</li>
</ol>

<hr />

<h2 id="ë°©ë²•">ë°©ë²•</h2>

<h3 id="1-sticky-session">1. Sticky session</h3>

<p><img src="/assets/img/contents/tsc-1.png" alt="tsc-1.png" /></p>

<p>í´ë¼ì´ì–¸íŠ¸ê°€ ì„¸ì…˜ì„ ë§ºì€ ì„œë²„ë‘ë§Œ í†µì‹ í•˜ëŠ” ê²ƒ</p>

<p>ì‚¬ìš©ì ì…ì¥ì—ì„œëŠ” ì„¸ì…˜ì´ ëŠê¸°ì§€ ì•Šê³  ìœ ì§€ë˜ëŠ” ì¥ì ì´ ìˆìœ¼ë‚˜</p>

<p>pod crash, shutdown ë“±ì˜ ë¬¸ì œë¡œ pod ì¬ì‹œì‘, ì¤‘ì§€ì‹œ ì„¸ì…˜ì´ ëŠê¸°ëŠ” ë¬¸ì œê°€ ìˆë‹¤.</p>

<p>kubernetes session affinity ì„¤ì •ìœ¼ë¡œ ë¹„êµì  ê°„ë‹¨íˆ ì„¤ì •ì´ ê°€ëŠ¥í•˜ë‚˜</p>

<p>ì™„ë²½í•œ session replicationì´ ì•„ë‹ˆë‹¤.</p>

<h3 id="2-tomcat-session-in-memory-replicationmulticast">2. Tomcat session in-memory replication(Multicast)</h3>

<p>Tomcatì—ì„œ ê¸°ë³¸ì ìœ¼ë¡œ ì œê³µí•˜ëŠ” í´ëŸ¬ìŠ¤í„°ë§</p>

<p>ì„œë²„ ì¸ë©”ëª¨ë¦¬ì— ì €ì¥í•˜ê³  SimpleTCPClusterì™€ ê°™ì€ í´ë˜ìŠ¤ë¥¼ ì´ìš©í•˜ì—¬ ë¦¬í”Œë¦¬ì¼€ì´ì…˜í•˜ëŠ” ë°©ë²•</p>

<p>tomcat xml(server.xml, pom.xml) ìˆ˜ì •ì´ í•„ìš”í•˜ì—¬ spring bootì—ì„œ ê¸°ë³¸ìœ¼ë¡œ ì œê³µí•˜ëŠ” embedded tomcatì—ì„œ ì‚¬ìš©ì´ ì•ˆëœë‹¤ê³  í•˜ë‚˜ java configë¥¼ ì´ìš©í•˜ì—¬ embedded tomcatë„ ì„¤ì • ê°€ëŠ¥í•œ ê²ƒìœ¼ë¡œ ë³´ì¸ë‹¤.</p>

<p>multicast ê¸°ëŠ¥ì„ ì§€ì›í•´ì•¼í•˜ì§€ë§Œ multicastëŠ” ëŒ€ë¶€ë¶„ì˜ cloud í™˜ê²½ì—ì„œëŠ” ì œê³µí•˜ì§€ ì•ŠìŒ</p>

<p>Tomcat ì„¤ì • íŒŒì¼ì„ ë°”ê¾¸ë ¤ë©´ Spring bootì˜ ê²½ìš° <code class="language-plaintext highlighter-rouge">@Configuration</code> ì„¤ì •ì„ í†µí•˜ì—¬ Beanì„ ì£¼ì…í•´ì•¼í•˜ì—¬ ì†ŒìŠ¤ì½”ë“œ ì¶”ê°€ê°€ í•„ìš”í•˜ë‹¤.</p>

<h3 id="3-tomcat-session-persistence-replication">3. Tomcat session persistence replication</h3>

<p>redis, dynamoDBì™€ ê°™ì€ DBì— ì„¸ì…˜ ì •ë³´ë¥¼ ì €ì¥í•˜ê³  ê° ì„œë²„ë¡œ í´ëŸ¬ìŠ¤í„°ë§ í•˜ëŠ” ë°©ë²•</p>

<p>sessionì´ ë³„ë„ì˜ ì €ì¥ì†Œì— ì €ì¥ë˜ì–´ ì‚¬ìš©ë˜ëŠ” ì¥ì ì´ ìˆìŒ</p>

<hr />
<h2 id="tomcat-session-in-memory-replicationmulticast-í…ŒìŠ¤íŠ¸">Tomcat session in-memory replication(Multicast) í…ŒìŠ¤íŠ¸</h2>

<p><a href="http://tomcat.apache.org/tomcat-9.0-doc/cluster-howto.html">Clustering/Session Replication How-To</a></p>

<h3 id="epc-multicast-ì§€ì›-í…ŒìŠ¤íŠ¸">EPC Multicast ì§€ì› í…ŒìŠ¤íŠ¸</h3>

<p>í˜„ì¬ ì‚¬ë‚´ì—ì„œ ì‚¬ìš©ì¤‘ì¸ í´ë¼ìš°ë“œ(EPC)ì—ì„œ Multicast ê¸°ëŠ¥ì„ ì§€ì›í•˜ëŠ”ì§€ í…ŒìŠ¤íŠ¸í•œë‹¤.</p>

<p>ë©€í‹°ìºìŠ¤íŠ¸ IP ëŒ€ì—­ì€ ì‚¬ì„¤ 224.0.1.0 ~ 238.255.255.255ì˜ ëŒ€ì—­ IPê°€ ì˜ˆì•½ë˜ì–´ ìˆìœ¼ë©°</p>

<p>ë©€í‹°ìºìŠ¤íŠ¸ ì‚¬ìš©ì„ ìœ„í•´ì„œëŠ” L2 ì¥ë¹„ê°€ IGMP í”„ë¡œí† ì½œì„ ì§€ì›í•´ì•¼í•œë‹¤ê³  í•œë‹¤.</p>

<blockquote>
  <p>AWSì™€ ê°™ì€ ë©”ì´ì € í´ë¼ìš°ë“œì—ì„œëŠ” ì§€ì›ì„ ì•ˆí•œë‹¤ê³  í•˜ë‹ˆ í™•ì¸ í•„ìš”</p>
</blockquote>

<p><strong>iperf</strong>ë¼ëŠ” ë„¤íŠ¸ì›Œí¬ í…ŒìŠ¤íŠ¸ íˆ´ì„ ì´ìš©í•˜ì—¬ EPCì—ì„œ ë©€í‹°ìºìŠ¤íŠ¸ IP ëŒ€ì—­ ì‚¬ìš©ì´ ê°€ëŠ¥í•œì§€ í…ŒìŠ¤íŠ¸í•œë‹¤.</p>

<h4 id="kubernetes-worker-ë…¸ë“œì—ì„œ-ì§„í–‰">kubernetes worker ë…¸ë“œì—ì„œ ì§„í–‰</h4>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># iperf ì„¤ì¹˜ (root ì§„í–‰)</span>
<span class="nv">$ </span>wget <span class="nt">-O</span> /usr/bin/iperf https://iperf.fr/download/ubuntu/iperf_2.0.9
<span class="nv">$ </span><span class="nb">chmod</span> +x /usr/bin/iperf

<span class="c"># Server side</span>
<span class="nv">$ </span>iperf <span class="nt">-s</span> <span class="nt">-u</span> <span class="nt">-B</span> 228.0.0.4 <span class="nt">-i</span> 1 <span class="nt">-p</span> 45564
<span class="nt">------------------------------------------------------------</span>
Server listening on UDP port 45564
Binding to <span class="nb">local </span>address 228.0.0.4
Joining multicast group  228.0.0.4
Receiving 1470 byte datagrams
UDP buffer size:  208 KByte <span class="o">(</span>default<span class="o">)</span>
<span class="nt">------------------------------------------------------------</span>
<span class="o">[</span>  3] <span class="nb">local </span>228.0.0.4 port 45564 connected with 10.213.196.14 port 49293
<span class="o">[</span> ID] Interval       Transfer     Bandwidth        Jitter   Lost/Total Datagrams
<span class="o">[</span>  3]  0.0- 1.0 sec   129 KBytes  1.06 Mbits/sec   0.006 ms    0/   90 <span class="o">(</span>0%<span class="o">)</span>
<span class="o">[</span>  3]  1.0- 2.0 sec   128 KBytes  1.05 Mbits/sec   0.011 ms    0/   89 <span class="o">(</span>0%<span class="o">)</span>
<span class="o">[</span>  3]  2.0- 3.0 sec   128 KBytes  1.05 Mbits/sec   0.007 ms    0/   89 <span class="o">(</span>0%<span class="o">)</span>
<span class="o">[</span>  3]  0.0- 3.0 sec   386 KBytes  1.05 Mbits/sec   0.007 ms    0/  269 <span class="o">(</span>0%<span class="o">)</span>

<span class="c"># Client side (ë‹¤ë¥¸ ë…¸ë“œì—ì„œ ì‹¤í–‰)</span>
<span class="nv">$ </span>iperf <span class="nt">-c</span> 228.0.0.4 <span class="nt">-u</span> <span class="nt">-T</span> 32 <span class="nt">-t</span> 3 <span class="nt">-i</span> 1 <span class="nt">-p</span> 45564
<span class="nt">------------------------------------------------------------</span>
Client connecting to 228.0.0.4, UDP port 45564
Sending 1470 byte datagrams, IPG target: 11215.21 us <span class="o">(</span>kalman adjust<span class="o">)</span>
Setting multicast TTL to 32
UDP buffer size:  208 KByte <span class="o">(</span>default<span class="o">)</span>
<span class="nt">------------------------------------------------------------</span>
<span class="o">[</span>  3] <span class="nb">local </span>10.213.196.14 port 49293 connected with 228.0.0.5 port 45564
<span class="o">[</span> ID] Interval       Transfer     Bandwidth
<span class="o">[</span>  3]  0.0- 1.0 sec   131 KBytes  1.07 Mbits/sec
<span class="o">[</span>  3]  1.0- 2.0 sec   128 KBytes  1.05 Mbits/sec
<span class="o">[</span>  3]  2.0- 3.0 sec   128 KBytes  1.05 Mbits/sec
<span class="o">[</span>  3]  0.0- 3.0 sec   386 KBytes  1.05 Mbits/sec
<span class="o">[</span>  3] Sent 269 datagrams
</code></pre></div></div>

<blockquote>
  <p>Tomcatì˜ ê²½ìš° ê¸°ë³¸ multicast ì£¼ì†ŒëŠ” <code class="language-plaintext highlighter-rouge">228.0.0.4</code>ì— í¬íŠ¸ëŠ” <code class="language-plaintext highlighter-rouge">45564</code> ì‚¬ìš©</p>
</blockquote>

<p>ì„œë²„ì—ì„œ í´ë¼ì´ì–¸íŠ¸ ê°ê° ì‹¤í–‰í•˜ì—¬ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì†¡ì‹ í•˜ëŠ” ë©”ì‹œì§€ê°€ ì„œë²„ì— ë©€í‹°ìºìŠ¤íŠ¸ ë˜ëŠ”ì§€ í™•ì¸</p>

<p>ë‹¤ë¥¸ ë…¸ë“œì—ì„œ ì‹¤í–‰ì‹œ ì •ìƒ ì†¡ìˆ˜ì‹ ì„ í™•ì¸í•˜ì˜€ë‹¤. (Zone: Prd-private)</p>

<hr />

<h3 id="tomcat-session-clustering-ìƒ˜í”Œ-í”„ë¡œì íŠ¸-ì‘ì„±">Tomcat session clustering ìƒ˜í”Œ í”„ë¡œì íŠ¸ ì‘ì„±</h3>

<h4 id="buildgradle-ì‘ì„±"><code class="language-plaintext highlighter-rouge">build.gradle</code> ì‘ì„±</h4>

<div class="language-gradle highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plugins</span> <span class="o">{</span>
	<span class="n">id</span> <span class="s1">'org.springframework.boot'</span> <span class="n">version</span> <span class="s1">'2.5.0'</span>
	<span class="n">id</span> <span class="s1">'io.spring.dependency-management'</span> <span class="n">version</span> <span class="s1">'1.0.11.RELEASE'</span>
	<span class="n">id</span> <span class="s1">'java'</span>
<span class="o">}</span>

<span class="n">group</span> <span class="o">=</span> <span class="s1">'com.example'</span>
<span class="n">version</span> <span class="o">=</span> <span class="s1">'0.0.1-SNAPSHOT'</span>
<span class="n">sourceCompatibility</span> <span class="o">=</span> <span class="s1">'1.8'</span>

<span class="k">repositories</span> <span class="o">{</span>
	<span class="n">mavenCentral</span><span class="o">()</span>
<span class="o">}</span>

<span class="k">dependencies</span> <span class="o">{</span>
	<span class="n">implementation</span> <span class="s1">'org.springframework.boot:spring-boot-starter-web'</span>
	<span class="n">implementation</span> <span class="s1">'org.projectlombok:lombok:1.18.12'</span>
	<span class="n">annotationProcessor</span> <span class="s1">'org.projectlombok:lombok:1.18.12'</span>
	<span class="n">implementation</span> <span class="s1">'org.apache.tomcat:tomcat-catalina-ha:9.0.46'</span>
	<span class="n">testImplementation</span> <span class="s1">'org.springframework.boot:spring-boot-starter-test'</span>
<span class="o">}</span>

<span class="n">test</span> <span class="o">{</span>
	<span class="n">useJUnitPlatform</span><span class="o">()</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="ì„¸ì…˜-ì •ë³´-í™•ì¸ì„-ìœ„í•œ-ê°„ë‹¨í•œ-controller-ì‘ì„±">ì„¸ì…˜ ì •ë³´ í™•ì¸ì„ ìœ„í•œ ê°„ë‹¨í•œ <code class="language-plaintext highlighter-rouge">Controller</code> ì‘ì„±</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RestController</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainController</span> <span class="o">{</span>
	<span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/"</span><span class="o">)</span>
	<span class="kd">public</span> <span class="nc">String</span> <span class="nf">getSession</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">HttpSession</span> <span class="n">session</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getSession</span><span class="o">();</span>
		<span class="nc">String</span> <span class="n">result</span> <span class="o">=</span> <span class="s">"session ID: "</span> <span class="o">+</span> <span class="n">session</span><span class="o">.</span><span class="na">getId</span><span class="o">()</span> <span class="o">+</span> <span class="s">"\n\nsession created: "</span> <span class="o">+</span> <span class="n">session</span><span class="o">.</span><span class="na">getCreationTime</span><span class="o">()</span> <span class="o">+</span> <span class="s">"\n\nsession accessed: "</span> <span class="o">+</span> <span class="n">session</span><span class="o">.</span><span class="na">getLastAccessedTime</span><span class="o">();</span>
		<span class="k">return</span> <span class="n">result</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="tomcat-config-ì„¤ì •">Tomcat config ì„¤ì •</h4>

<h4 id="tomcatclustercontextcustomizer"><code class="language-plaintext highlighter-rouge">TomcatClusterContextCustomizer</code></h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TomcatClusterContextCustomizer</span> <span class="kd">implements</span> <span class="nc">TomcatContextCustomizer</span> <span class="o">{</span>
	<span class="nd">@Value</span><span class="o">(</span><span class="s">"${env.multicast.receiver.port}"</span><span class="o">)</span>
	<span class="kd">private</span> <span class="nc">Integer</span> <span class="n">receiverPort</span><span class="o">;</span>
	
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">customize</span><span class="o">(</span><span class="kd">final</span> <span class="nc">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">context</span><span class="o">.</span><span class="na">setDistributable</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>	<span class="c1">// web.xml &lt;distribute/&gt;</span>
		<span class="c1">// Manager setting</span>
		<span class="nc">BackupManager</span> <span class="n">manager</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BackupManager</span><span class="o">();</span>
		<span class="n">manager</span><span class="o">.</span><span class="na">setNotifyListenersOnReplication</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
		<span class="n">context</span><span class="o">.</span><span class="na">setManager</span><span class="o">(</span><span class="n">manager</span><span class="o">);</span>
		<span class="n">configureCluster</span><span class="o">((</span><span class="nc">Engine</span><span class="o">)</span><span class="n">context</span><span class="o">.</span><span class="na">getParent</span><span class="o">().</span><span class="na">getParent</span><span class="o">());</span>
	<span class="o">}</span>
	
	<span class="kd">private</span> <span class="kt">void</span> <span class="nf">configureCluster</span><span class="o">(</span><span class="nc">Engine</span> <span class="n">engine</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// Cluster setting</span>
		<span class="nc">SimpleTcpCluster</span> <span class="n">cluster</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SimpleTcpCluster</span><span class="o">();</span>
		<span class="n">cluster</span><span class="o">.</span><span class="na">setChannelSendOptions</span><span class="o">(</span><span class="mi">8</span><span class="o">);</span>
		<span class="c1">// Channel setting</span>
		<span class="nc">GroupChannel</span> <span class="n">channel</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">GroupChannel</span><span class="o">();</span>
		<span class="c1">// Membership setting</span>
		<span class="nc">McastService</span> <span class="n">mcastService</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">McastService</span><span class="o">();</span>
		<span class="n">mcastService</span><span class="o">.</span><span class="na">setAddress</span><span class="o">(</span><span class="s">"228.0.0.4"</span><span class="o">);</span>
		<span class="n">mcastService</span><span class="o">.</span><span class="na">setPort</span><span class="o">(</span><span class="mi">45564</span><span class="o">);</span>
		<span class="n">mcastService</span><span class="o">.</span><span class="na">setFrequency</span><span class="o">(</span><span class="mi">500</span><span class="o">);</span>
		<span class="n">mcastService</span><span class="o">.</span><span class="na">setDropTime</span><span class="o">(</span><span class="mi">3000</span><span class="o">);</span>
		<span class="n">channel</span><span class="o">.</span><span class="na">setMembershipService</span><span class="o">(</span><span class="n">mcastService</span><span class="o">);</span>
		<span class="c1">// Receiver setting</span>
		<span class="nc">NioReceiver</span> <span class="n">receiver</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioReceiver</span><span class="o">();</span>
		<span class="n">receiver</span><span class="o">.</span><span class="na">setAddress</span><span class="o">(</span><span class="s">"auto"</span><span class="o">);</span>	<span class="c1">// tomcatì˜ LAN ì£¼ì†Œë¥¼ ê°€ì ¸ì˜¨ë‹¤. Ipv4ë¡œ ì„¤ì •í•´ì•¼í•¨</span>
		<span class="n">receiver</span><span class="o">.</span><span class="na">setPort</span><span class="o">(</span><span class="mi">4000</span><span class="o">);</span>
<span class="c1">//		receiver.setPort(receiverPort);   í†°ìº£ì´ ê°™ì€ nodeì—ì„œ replication êµ¬ë™ì‹œ ë¦¬ì‹œë²„ í¬íŠ¸ëŠ” ì„œë¡œ ë‹¬ë¼ì•¼í•¨ ì´ ê²½ìš° ë³„ë„ í¬íŠ¸ ì§€ì •</span>
		<span class="n">receiver</span><span class="o">.</span><span class="na">setAutoBind</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>
		<span class="n">receiver</span><span class="o">.</span><span class="na">setSelectorTimeout</span><span class="o">(</span><span class="mi">5000</span><span class="o">);</span>
		<span class="n">receiver</span><span class="o">.</span><span class="na">setMaxThreads</span><span class="o">(</span><span class="mi">6</span><span class="o">);</span>
		<span class="n">channel</span><span class="o">.</span><span class="na">setChannelReceiver</span><span class="o">(</span><span class="n">receiver</span><span class="o">);</span>
		<span class="c1">// Sender setting</span>
		<span class="nc">ReplicationTransmitter</span> <span class="n">sender</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReplicationTransmitter</span><span class="o">();</span>
		<span class="n">sender</span><span class="o">.</span><span class="na">setTransport</span><span class="o">(</span><span class="k">new</span> <span class="nc">PooledParallelSender</span><span class="o">());</span>
		<span class="n">channel</span><span class="o">.</span><span class="na">setChannelSender</span><span class="o">(</span><span class="n">sender</span><span class="o">);</span>
		<span class="c1">// Intercepter setting</span>
		<span class="n">channel</span><span class="o">.</span><span class="na">addInterceptor</span><span class="o">(</span><span class="k">new</span> <span class="nc">TcpPingInterceptor</span><span class="o">());</span>
		<span class="n">channel</span><span class="o">.</span><span class="na">addInterceptor</span><span class="o">(</span><span class="k">new</span> <span class="nc">TcpFailureDetector</span><span class="o">());</span>
		<span class="n">channel</span><span class="o">.</span><span class="na">addInterceptor</span><span class="o">(</span><span class="k">new</span> <span class="nc">MessageDispatchInterceptor</span><span class="o">());</span>
		<span class="n">cluster</span><span class="o">.</span><span class="na">addValve</span><span class="o">(</span><span class="k">new</span> <span class="nc">ReplicationValve</span><span class="o">());</span>
		<span class="n">cluster</span><span class="o">.</span><span class="na">addValve</span><span class="o">(</span><span class="k">new</span> <span class="nc">JvmRouteBinderValve</span><span class="o">());</span>
		<span class="n">cluster</span><span class="o">.</span><span class="na">setChannel</span><span class="o">(</span><span class="n">channel</span><span class="o">);</span>
		<span class="n">cluster</span><span class="o">.</span><span class="na">addClusterListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">ClusterSessionListener</span><span class="o">());</span>
		<span class="n">engine</span><span class="o">.</span><span class="na">setCluster</span><span class="o">(</span><span class="n">cluster</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="tomcatclusterutil-ì‘ì„±"><code class="language-plaintext highlighter-rouge">TomcatClusterUtil</code> ì‘ì„±</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TomcatClusterUtil</span> <span class="kd">implements</span> <span class="nc">WebServerFactoryCustomizer</span><span class="o">&lt;</span><span class="nc">TomcatServletWebServerFactory</span><span class="o">&gt;{</span>
	<span class="nd">@Autowired</span>
	<span class="nc">TomcatClusterContextCustomizer</span> <span class="n">tomcatClusterContextCustomizer</span><span class="o">;</span>
	
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">customize</span><span class="o">(</span><span class="kd">final</span> <span class="nc">TomcatServletWebServerFactory</span> <span class="n">factory</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">factory</span><span class="o">.</span><span class="na">addContextCustomizers</span><span class="o">(</span><span class="n">tomcatClusterContextCustomizer</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>spring bootì™€ ê°™ì´ ì„¤ì¹˜í˜• tomcatì´ ì•„ë‹Œ embedded tomcatì—ì„œëŠ” server.xml, web.xmlê³¼ ê°™ì€ ì„¤ì • íŒŒì¼ì˜ ì§ì ‘ ìˆ˜ì •ì´ ë¶ˆê°€ëŠ¥í•˜ë¯€ë¡œ</p>

<p><code class="language-plaintext highlighter-rouge">TomcatContextCustomizer</code>ë¥¼ ì´ìš©í•˜ì—¬ Contextì— ì„¤ì •í•œë‹¤.</p>

<blockquote>
  <p>í•­ëª©ë³„ ìì„¸í•œ ì„¤ëª…ì€ <a href="http://tomcat.apache.org/tomcat-9.0-doc/cluster-howto.html">ê³µì‹ë¬¸ì„œ</a> ì°¸ì¡°</p>
</blockquote>

<h4 id="ì¸ìŠ¤í„´ìŠ¤ë³„-í¬íŠ¸-ì„¤ì •ì„-ìœ„í•œ-applicationyaml-ì‘ì„±">ì¸ìŠ¤í„´ìŠ¤ë³„ í¬íŠ¸ ì„¤ì •ì„ ìœ„í•œ <code class="language-plaintext highlighter-rouge">application.yaml</code> ì‘ì„±</h4>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">spring</span><span class="pi">:</span>
  <span class="na">profiles</span><span class="pi">:</span>
    <span class="na">active</span><span class="pi">:</span> <span class="s">instance1</span>

<span class="nn">---</span>
<span class="na">spring</span><span class="pi">:</span>
  <span class="na">config</span><span class="pi">:</span>
    <span class="na">activate</span><span class="pi">:</span>
      <span class="na">on-profile</span><span class="pi">:</span> <span class="s">instance1</span>
<span class="na">server</span><span class="pi">:</span>
  <span class="na">port</span><span class="pi">:</span> <span class="m">8080</span>
<span class="na">env</span><span class="pi">:</span>
  <span class="na">multicast.receiver.port</span><span class="pi">:</span> <span class="m">4000</span>

<span class="nn">---</span>
<span class="na">spring</span><span class="pi">:</span>
  <span class="na">config</span><span class="pi">:</span>
    <span class="na">activate</span><span class="pi">:</span>
      <span class="na">on-profile</span><span class="pi">:</span> <span class="s">instance2</span>
<span class="na">server</span><span class="pi">:</span>
  <span class="na">port</span><span class="pi">:</span> <span class="m">8081</span>
<span class="na">env</span><span class="pi">:</span>
  <span class="na">multicast.receiver.port</span><span class="pi">:</span> <span class="m">4001</span>
</code></pre></div></div>

<blockquote>
  <p>ë¡œì»¬ í…ŒìŠ¤íŠ¸ì‹œ ê°™ì€ í¬íŠ¸ë¡œ í†°ìº£ ì¸ìŠ¤í„´ìŠ¤ ì‹¤í–‰ì´ ë¶ˆê°€ëŠ¥í•˜ë¯€ë¡œ í¬íŠ¸ ì„¤ì •ì„ í•˜ê¸° ìœ„í•¨</p>
</blockquote>

<h4 id="spring-boot-run-configuration-ì„¤ì •">spring boot Run configuration ì„¤ì •</h4>

<ol>
  <li>
    <h5 id="tomcat-session-replication-test1">tomcat-session-replication-test1</h5>

    <ul>
      <li>Profile: instance1</li>
      <li>JVM Arguments: -Djava.net.preferIPv4Stack=true</li>
    </ul>
  </li>
  <li>
    <h5 id="tomcat-session-replication-test2">tomcat-session-replication-test2</h5>

    <ul>
      <li>Profile: instance2</li>
      <li>JVM Arguments: -Djava.net.preferIPv4Stack=true</li>
    </ul>
  </li>
</ol>

<blockquote>
  <p>preferIPv4Stack <code class="language-plaintext highlighter-rouge">true</code>ë¡œ ì„¤ì •í•´ì•¼ ìœ„ì—ì„œ Receiverì£¼ì†Œ ì„¤ì •ê°’ <code class="language-plaintext highlighter-rouge">receiver.setAddress("auto");</code>ê°€ ì‘ë™í•œë‹¤.</p>
</blockquote>

<h4 id="ë¡œë“œë°¸ëŸ°ì„œ-ì„¤ì •">ë¡œë“œë°¸ëŸ°ì„œ ì„¤ì •</h4>

<p>Tomcatì—ì„œ ì§€ì›í•˜ëŠ” session clusteringì„ ì‚¬ìš©í•˜ë ¤ë©´ ë¡œë“œë°¸ëŸ°ì„œë¥¼ í†µí•´ ê°™ì€ ë„ë©”ì¸ì´ë¦„ì„ ì‚¬ìš©í•˜ì—¬ì•¼ ì„¸ì…˜ì´ ê³µìœ ëœë‹¤.</p>

<p>ì„œë¡œ ë‹¤ë¥¸ ë„ë©”ì¸ì„ ì‚¬ìš©í•˜ê±°ë‚˜ ë‹¤ë¥¸ ì„œë²„ì¸ ê²½ìš° ê¸°ë³¸ì ìœ¼ë¡œ ê°™ì€ sessionì„ ê°€ì§€ê³  ìˆë‹¤ê³  íŒë‹¨í•˜ì§€ ì•ŠëŠ” ê²ƒ ê°™ë‹¤.</p>

<p>ë”°ë¼ì„œ ê°™ì€ ë„ë©”ì¸ ì„¤ì •ì„ ìœ„í•œ ë¡œë“œë°¸ëŸ°ì„œ ì—­í• ì„ í•  nginxë¥¼ ì‚¬ìš©í•˜ì—¬ ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ ì„¤ì •ì„í•œë‹¤.</p>

<h4 id="ë§¥-ë¡œì»¬-ê¸°ì¤€-ì‘ì„±">ë§¥ ë¡œì»¬ ê¸°ì¤€ ì‘ì„±</h4>

<h4 id="nginx-ì„¤ì¹˜-ë°-ì„¤ì •">nginx ì„¤ì¹˜ ë° ì„¤ì •</h4>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>brew <span class="nb">install </span>nginx	<span class="c"># nginx ì„¤ì¹˜</span>
<span class="nv">$ </span>vim /usr/local/etc/nginx/nginx.conf	<span class="c"># ë¡œë“œë°¸ëŸ°ì„œ ì„¤ì •</span>
 17   http <span class="o">{</span>
 18     include       mime.types<span class="p">;</span>
 19     default_type  application/octet-stream<span class="p">;</span>
 ...
 35     upstream myproject <span class="o">{</span>
 36       server 127.0.0.1:8080<span class="p">;</span>
 37       server 127.0.0.1:8081<span class="p">;</span>
 38     <span class="o">}</span>
 39
 40     server <span class="o">{</span>
 41         listen       80<span class="p">;</span>
 42         server_name  localhost<span class="p">;</span>
 ...
 48         location / <span class="o">{</span>
 49           proxy_pass http://myproject<span class="p">;</span>
 50         <span class="o">}</span>
 <span class="nv">$ </span>nginx	<span class="c"># local nginx êµ¬ë™</span>
</code></pre></div></div>

<p>localhost:80 ì ‘ì†ì‹œ <code class="language-plaintext highlighter-rouge">127.0.0.1:8080</code>, <code class="language-plaintext highlighter-rouge">127.0.0.1:8081</code>ë¡œ ê°ê° ë¡œë“œë°¸ëŸ°ì‹±</p>

<hr />

<h3 id="í…ŒìŠ¤íŠ¸local">í…ŒìŠ¤íŠ¸(Local)</h3>

<h4 id="í…ŒìŠ¤íŠ¸-ìˆœì„œ">í…ŒìŠ¤íŠ¸ ìˆœì„œ</h4>
<ol>
  <li>tomcat-session-replication-test1 êµ¬ë™</li>
  <li>localhost ì ‘ì†</li>
  <li>session í™•ì¸</li>
  <li>tomcat-session-replication-test2 êµ¬ë™</li>
  <li>tomcat-session-replication-test1 ì¤‘ì§€</li>
  <li>localhost ì ‘ì†</li>
  <li>session í™•ì¸</li>
</ol>

<h4 id="í…ŒìŠ¤íŠ¸-ì§„í–‰">í…ŒìŠ¤íŠ¸ ì§„í–‰</h4>

<ol>
  <li>tomcat-session-replication-test1 êµ¬ë™
<img src="/assets/img/contents/tsc-2.png" alt="tsc-2.png" /></li>
  <li>localhost ì ‘ì†</li>
  <li>session í™•ì¸
<img src="/assets/img/contents/tsc-3.png" alt="tsc-3.png" /></li>
  <li>tomcat-session-replication-test2 êµ¬ë™</li>
  <li>tomcat-session-replication-test1 ì¤‘ì§€
<img src="/assets/img/contents/tsc-4.png" alt="tsc-4.png" /></li>
  <li>localhost ì ‘ì†</li>
  <li>session í™•ì¸
<img src="/assets/img/contents/tsc-5.png" alt="tsc-5.png" /></li>
</ol>

<p>session IDë¥¼ 1ë²ˆ ì¸ìŠ¤í„´ìŠ¤ì—ì„œ ìƒì„±í–ˆìŒì—ë„ 2ë²ˆ tomcatìœ¼ë¡œ ì ‘ì†ì‹œ session IDê°€ ì„œë¡œ ë™ì¼í•œ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.</p>

<hr />

<h3 id="í…ŒìŠ¤íŠ¸dev-epc">í…ŒìŠ¤íŠ¸(Dev EPC)</h3>

<p>í˜„ì‹œì  ê¸°ì¤€ 172.x ëŒ€ì—­ì˜ ê°œë°œ í´ëŸ¬ìŠ¤í„°ì— ì„¤ì •í•˜ì—¬ ì„¸ì…˜ ê³µìœ ê°€ kubernetes í™˜ê²½ì—ì„œë„ ì ìš©ë˜ëŠ”ì§€ í…ŒìŠ¤íŠ¸í•œë‹¤.</p>

<h4 id="kubernetes-ë°°í¬">kubernetes ë°°í¬</h4>
<ol>
  <li>gitlab í”„ë¡œì íŠ¸ ìƒì„± ë° commit</li>
  <li>ë°°í¬ë¥¼ ìœ„í•œ Dockerfile, yaml ì‘ì„±
    <ol>
      <li>Dockerfile
```Dockerfile
FROM openjdk:8-jdk-alpine</li>
    </ol>

    <p>ADD build/libs/tomcat-session-replication-test-0.0.1-SNAPSHOT.jar TomcatSessionClusteringTest.jar
 RUN apk â€“no-cache add tzdata &amp;&amp; <br />
         cp /usr/share/zoneinfo/Asia/Seoul /etc/localtime &amp;&amp; <br />
         echo â€œAsia/Seoulâ€ &gt; /etc/timezone</p>

    <p>ENTRYPOINT [â€œjavaâ€, â€œ-Duser.timezone=Asia/Seoulâ€, â€œ-Djava.net.preferIPv4Stack=trueâ€, â€œ-jarâ€, â€œ/TomcatSessionClusteringTest.jarâ€, â€œâ€“spring.profiles.active=instance1â€]</p>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2. kubernetes.yaml
```yaml
 apiVersion: apps/v1
 kind: Deployment
 metadata:
   namespace: robotdev
   name: tomcatsessionclustertest-deploy
   labels:
     app: tomcatsessionclustertest
 spec:
   replicas: 2	# podë¥¼ 2ê°œ ë„ì›€
   minReadySeconds: 10
   strategy:
     type: RollingUpdate
     rollingUpdate:
       maxUnavailable: 40%
   selector:
     matchLabels:
       app: tomcatsessionclustertest
   template:
     metadata:
       labels:
         app: tomcatsessionclustertest
     spec:
       containers:
       - name: tomcatsessionclustertest
         image: gitlab.ccpinfra.xyz:28082/tomcatsessionclustertest:latest
         volumeMounts:
         - name: tz-seoul
           mountPath: /etc/localtime
         ports: 
         - containerPort: 8080
         imagePullPolicy: Always
         resources:
           requests:
             memory: "256Mi"
             cpu: "200m"
           limits:
             memory: "1Gi"
             cpu: "500m"
       imagePullSecrets:
       - name: regdedi
       volumes:
       - name: tz-seoul
         hostPath: 
           path: /usr/share/zoneinfo/Asia/Seoul
       affinity:
         podAntiAffinity:
           requiredDuringSchedulingIgnoredDuringExecution:
           - labelSelector:
               matchExpressions:
               - key: app.kubernetes.io/name
                 operator: In
                 values:
                 - tomcatsessionclustertest	# ê°™ì€ nodeì— ëœ¨ì§€ ì•Šê²Œ í•´ì¤Œ
              topologyKey: kubernetes.io/hostname
   
 ---
 apiVersion: v1
 kind: Service
 metadata:
   namespace: robotdev
   name: tomcatsessionclustertest-svc
   labels:
     app: tomcatsessionclustertest
 spec:
   ports:
   - port: 8080
     nodePort: 32599
     targetPort: 8099
   selector:
     app: tomcatsessionclustertest
   type: NodePort
 ---
   
</code></pre></div>    </div>
  </li>
  <li>Jenkins ë“±ë¡
ê¸°ì¡´ robotdev jenkins jobì—ì„œ copy</li>
</ol>

<p>íŒŒì´í”„ë¼ì¸ ì•„ë˜ì™€ ê°™ì´ ìˆ˜ì •</p>
<div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">node</span> <span class="o">(</span><span class="s1">'jenkins-slave'</span><span class="o">){</span>
    <span class="kt">def</span> <span class="n">gitBranch</span> <span class="o">=</span> <span class="s1">'master'</span>
    <span class="kt">def</span> <span class="n">gitCredId</span> <span class="o">=</span> <span class="s1">'gitlab-ssh-key'</span>
    <span class="kt">def</span> <span class="n">gitUrl</span> <span class="o">=</span> <span class="s1">'ssh://git@gitlab.ccpinfra.xyz:20722/group_infra/'</span>
    <span class="kt">def</span> <span class="n">projectUrl</span> <span class="o">=</span> <span class="n">gitUrl</span> <span class="o">+</span> <span class="s1">'tomcat-session-clustering-test.git'</span>
    <span class="kt">def</span> <span class="n">dockerRepoUrl</span> <span class="o">=</span> <span class="s1">'http://192.168.90.6:12000'</span>
    <span class="kt">def</span> <span class="n">imageName</span> <span class="o">=</span> <span class="s1">'tomcatsessionclustertest'</span>
    <span class="kt">def</span> <span class="n">defaultYaml</span> <span class="o">=</span> <span class="s1">'kubernetes.yaml'</span>
    <span class="kt">def</span> <span class="n">deployYaml</span> <span class="o">=</span> <span class="s1">'kubernetes_deploy.yaml'</span>

    <span class="n">stage</span><span class="o">(</span><span class="s1">'Checkout'</span><span class="o">)</span>    <span class="o">{</span>
        <span class="c1">// Get some code from a GitLab repository</span>
         <span class="n">git</span><span class="o">(</span>
            <span class="nl">url:</span> <span class="n">projectUrl</span><span class="o">,</span>
            <span class="nl">credentialsId:</span> <span class="n">gitCredId</span><span class="o">,</span>
            <span class="nl">branch:</span> <span class="n">gitBranch</span>
        <span class="o">)</span>
    <span class="o">}</span>
    
    <span class="n">stage</span><span class="o">(</span><span class="s1">'Build'</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">sh</span> <span class="s2">"chmod +x ./gradlew"</span>
        <span class="n">sh</span> <span class="s2">"./gradlew clean build -x test"</span>
    <span class="o">}</span>

    <span class="n">stage</span><span class="o">(</span><span class="s1">'Analysis &amp; Push'</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">parallel</span> <span class="o">(</span>
            <span class="s1">'Docker Build'</span><span class="o">:</span> <span class="o">{</span>
                <span class="kt">def</span> <span class="n">dockerfile</span> <span class="o">=</span> <span class="s1">'Dockerfile'</span>
                <span class="n">app</span> <span class="o">=</span> <span class="n">docker</span><span class="o">.</span><span class="na">build</span><span class="o">(</span><span class="s2">"${imageName}:${env.BUILD_ID}"</span><span class="o">,</span><span class="s2">"-f ${dockerfile} ./"</span><span class="o">)</span>
            <span class="o">}</span>
        <span class="o">)</span>
        
        <span class="n">parallel</span> <span class="o">(</span>
            <span class="s1">'Registry Push'</span><span class="o">:</span> <span class="o">{</span>
                <span class="n">docker</span><span class="o">.</span><span class="na">withRegistry</span><span class="o">(</span><span class="s2">"${dockerRepoUrl}"</span><span class="o">,</span> <span class="s2">"dockerhub"</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">app</span><span class="o">.</span><span class="na">push</span><span class="o">(</span><span class="s2">"$BUILD_ID"</span><span class="o">)</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">)</span>
    <span class="o">}</span>
    
    <span class="n">stage</span><span class="o">(</span><span class="s1">'Kube Deploy'</span><span class="o">){</span>
        
        <span class="n">sh</span> <span class="s2">"cat ${defaultYaml} | sed 's/latest/${env.BUILD_ID}/g' &gt; ${deployYaml}"</span>

        <span class="n">withKubeConfig</span><span class="o">(</span><span class="nl">credentialsId:</span> <span class="s1">'epc-rm-jenkins-builder'</span><span class="o">,</span> <span class="nl">serverUrl:</span> <span class="s1">'https://211.184.190.64:36443'</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">sh</span> <span class="s2">"kubectl apply -f ${deployYaml}"</span>
        <span class="o">}</span>
    <span class="o">}</span>
    
<span class="o">}</span>
</code></pre></div></div>

<ol>
  <li>kubernetes ë°°í¬ í™•ì¸
<a href="https://k8sdash.robotmakers.xyz:30443/#/pod?namespace=robotdev">kubernetes ëŒ€ì‹œë³´ë“œ</a> ì ‘ì† ë˜ëŠ” ëª…ë ¹ì–´ í™•ì¸</li>
</ol>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl get po <span class="nt">-n</span> robotdev
<span class="nv">$ </span>kubectl get svc <span class="nt">-n</span> robotdev
</code></pre></div></div>

<h4 id="ì™¸ë¶€-ì ‘ì†-ì„¤ì •">ì™¸ë¶€ ì ‘ì† ì„¤ì •</h4>
<ol>
  <li>ë°©í™”ë²½ ì˜¤í”ˆ
    <ul>
      <li>ì™¸ë¶€ -&gt; kubernetes 32599 NodePort</li>
    </ul>
  </li>
  <li>ì ‘ì† í™•ì¸
<a href="https://bookstack.ccpinfra.xyz:23443/uploads/images/gallery/2021-05/tomcatsessionclusteringtest1.png"><img src="https://bookstack.ccpinfra.xyz:23443/uploads/images/gallery/2021-05/scaled-1680-/tomcatsessionclusteringtest1.png" alt="tomcatsessionclusteringtest1.png" /></a></li>
  <li>ì ‘ì† ë¡œê·¸ í™•ì¸
<a href="https://bookstack.ccpinfra.xyz:23443/uploads/images/gallery/2021-05/tomcatsessionclusteringtest2.png"><img src="https://bookstack.ccpinfra.xyz:23443/uploads/images/gallery/2021-05/scaled-1680-/tomcatsessionclusteringtest2.png" alt="tomcatsessionclusteringtest2.png" /></a></li>
  <li>ì ‘ì†ëœ íŒŒë“œ ì¤‘ì§€
    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl delete pod tomcatsessionclustertest-deploy-7d75d5548b-rknfh <span class="nt">-n</span> robotdev
</code></pre></div>    </div>
  </li>
  <li>ì¬ì ‘ì†
<a href="https://bookstack.ccpinfra.xyz:23443/uploads/images/gallery/2021-05/tomcatsessionclusteringtest3.png"><img src="https://bookstack.ccpinfra.xyz:23443/uploads/images/gallery/2021-05/scaled-1680-/tomcatsessionclusteringtest3.png" alt="tomcatsessionclusteringtest3.png" /></a></li>
</ol>

<p>kubernetes í™˜ê²½ì—ì„œ host ì„œë²„ê°„ multicast í†µì‹ ì€ ë˜ëŠ” ê²ƒìœ¼ë¡œ íŒë‹¨ë˜ë‚˜ íŒŒë“œê°„ multicast í†µì‹ ì„ ìœ„í•´ì„œëŠ” <code class="language-plaintext highlighter-rouge">multus-cni</code>ë¥¼ ì‚¬ìš©í•˜ì—¬ NICë¡œ í˜¸ìŠ¤íŠ¸ì™€ ì—°ê²°í•´ì•¼í•¨</p>

<p>ì°¸ì¡°: <a href="https://stackoverflow.com/a/61234801/15263734">https://stackoverflow.com/a/61234801/15263734</a></p>

<blockquote>
  <p>ê²°ë¡ : Code dependencyë„ ë†’ê³  kubernetes í™˜ê²½ì— ë³„ë„ì˜ CNI ì„¤ì¹˜ë¥¼ ìš”êµ¬í•˜ë¯€ë¡œ ë³µì¡ë„ ì¡´ì¬</p>
</blockquote>

<hr />
<h3 id="3-tomcat-session-persistence-replication-í…ŒìŠ¤íŠ¸">3. Tomcat session persistence replication í…ŒìŠ¤íŠ¸</h3>

<p>Redis, dynamoDB, hazelcast ë“±ì˜ in-memory DBë¥¼ ì´ìš©í•˜ì—¬ ì„¸ì…˜ì„ ì €ì¥í•˜ê³  ê³µìœ í•˜ëŠ” ë°©ë²• í…ŒìŠ¤íŠ¸</p>

<p>í˜„ì¬ EPCì—ì„œ Redisë¥¼ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— redisë¥¼ ì´ìš©í•˜ì—¬ ì„¸ì…˜ ì €ì¥í•˜ëŠ” ë°©ë²• í…ŒìŠ¤íŠ¸</p>

<h4 id="í…ŒìŠ¤íŠ¸local-1">í…ŒìŠ¤íŠ¸(LOCAL)</h4>

<p><strong>ë§¥ ë¡œì»¬ ê¸°ì¤€ ì‘ì„±</strong></p>

<h5 id="1-redis-ì„¤ì¹˜">1. Redis ì„¤ì¹˜</h5>

<p>[https://hub.docker.com/<em>/redis/](https://hub.docker.com/</em>/redis/)</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker pull redis
<span class="nv">$ </span>docker run <span class="nt">--name</span> redis <span class="nt">-p</span> 6379:6379 <span class="nt">-d</span> redis
<span class="nv">$ </span>docker ps
CONTAINER ID   IMAGE     COMMAND                  CREATED         STATUS         PORTS                                       NAMES
2e96b0e93c0a   redis     <span class="s2">"docker-entrypoint.sâ€¦"</span>   4 seconds ago   Up 2 seconds   0.0.0.0:6379-&gt;6379/tcp, :::6379-&gt;6379/tcp   redis
</code></pre></div></div>

<h5 id="2-ìƒ˜í”Œ-í”„ë¡œì íŠ¸-ì‘ì„±">2. ìƒ˜í”Œ í”„ë¡œì íŠ¸ ì‘ì„±</h5>

<p><code class="language-plaintext highlighter-rouge">build.gradle</code></p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">dependencies</span> <span class="o">{</span>
	<span class="n">implementation</span> <span class="err">'</span><span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">boot</span><span class="o">:</span><span class="n">spring</span><span class="o">-</span><span class="n">boot</span><span class="o">-</span><span class="n">starter</span><span class="o">-</span><span class="n">web</span><span class="err">'</span>
	<span class="n">testImplementation</span> <span class="err">'</span><span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">boot</span><span class="o">:</span><span class="n">spring</span><span class="o">-</span><span class="n">boot</span><span class="o">-</span><span class="n">starter</span><span class="o">-</span><span class="n">test</span><span class="err">'</span>
	<span class="n">implementation</span> <span class="err">'</span><span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">boot</span><span class="o">:</span><span class="n">spring</span><span class="o">-</span><span class="n">boot</span><span class="o">-</span><span class="n">starter</span><span class="o">-</span><span class="n">data</span><span class="o">-</span><span class="n">redis</span><span class="err">'</span>
	<span class="n">implementation</span> <span class="err">'</span><span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">session</span><span class="o">:</span><span class="n">spring</span><span class="o">-</span><span class="n">session</span><span class="o">-</span><span class="n">data</span><span class="o">-</span><span class="n">redis</span><span class="err">'</span>
<span class="o">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">application.yaml</code></p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">spring</span><span class="pi">:</span>
  <span class="na">profiles</span><span class="pi">:</span>
    <span class="na">active</span><span class="pi">:</span> <span class="s">local</span>

<span class="nn">---</span>
<span class="na">spring</span><span class="pi">:</span>
  <span class="na">config</span><span class="pi">:</span>
    <span class="na">activate</span><span class="pi">:</span>
      <span class="na">on-profile</span><span class="pi">:</span> <span class="s">local</span>
  <span class="na">redis</span><span class="pi">:</span>
    <span class="na">host</span><span class="pi">:</span> <span class="s">127.0.0.1</span>
    <span class="na">port</span><span class="pi">:</span> <span class="m">6379</span>
<span class="na">server</span><span class="pi">:</span>
  <span class="na">port</span><span class="pi">:</span> <span class="m">8080</span>

<span class="nn">---</span>
<span class="na">spring</span><span class="pi">:</span>
  <span class="na">config</span><span class="pi">:</span>
    <span class="na">activate</span><span class="pi">:</span>
      <span class="na">on-profile</span><span class="pi">:</span> <span class="s">robotdev</span>
  <span class="na">redis</span><span class="pi">:</span>
    <span class="na">host</span><span class="pi">:</span> <span class="s">172.25.0.163</span>
    <span class="na">port</span><span class="pi">:</span> <span class="m">6379</span>
<span class="na">server</span><span class="pi">:</span>
  <span class="na">port</span><span class="pi">:</span> <span class="m">8080</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">MainController.java</code></p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RestController</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainController</span> <span class="o">{</span>
	
	<span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/hello"</span><span class="o">)</span>
	<span class="kd">public</span> <span class="nc">String</span> <span class="nf">hello</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="s">"hello"</span><span class="o">;</span>
	<span class="o">}</span>
	
	<span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/"</span><span class="o">)</span>
	<span class="kd">public</span> <span class="nc">String</span> <span class="nf">getSession</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">HttpSession</span> <span class="n">session</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getSession</span><span class="o">();</span>
		<span class="nc">String</span> <span class="n">result</span> <span class="o">=</span> <span class="s">"session ID: "</span> <span class="o">+</span> <span class="n">session</span><span class="o">.</span><span class="na">getId</span><span class="o">()</span> <span class="o">+</span> <span class="s">"\n\nsession created: "</span> <span class="o">+</span> <span class="n">session</span><span class="o">.</span><span class="na">getCreationTime</span><span class="o">()</span> <span class="o">+</span> <span class="s">"\n\nsession accessed: "</span> <span class="o">+</span> <span class="n">session</span><span class="o">.</span><span class="na">getLastAccessedTime</span><span class="o">();</span>
      	<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getLocalPort</span><span class="o">());</span>
		<span class="k">return</span> <span class="n">result</span><span class="o">;</span>
	<span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<p>SpringBootApplicationì— <code class="language-plaintext highlighter-rouge">@EnableRedisHttpSession</code> ì¶”ê°€</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@SpringBootApplication</span>
<span class="nd">@EnableRedisHttpSession</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TomcatSessionReplicationTestApplication</span> <span class="o">{</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="nc">TomcatSessionReplicationTestApplication</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Spring boot Run configuration ì„¤ì •</p>

<ol>
  <li>tomcat-session-replication-test1
    <ul>
      <li>JVM Arguments: -Djava.net.preferIPv4Stack=true</li>
      <li>Program Arguments: â€“server.port=8080</li>
    </ul>
  </li>
  <li>tomcat-session-replication-test2
    <ul>
      <li>JVM Arguments: -Djava.net.preferIPv4Stack=true</li>
      <li>Program Arguments: â€“server.port=8081</li>
    </ul>
  </li>
</ol>

<h4 id="í…ŒìŠ¤íŠ¸-ìˆœì„œ-1">í…ŒìŠ¤íŠ¸ ìˆœì„œ</h4>
<ol>
  <li>tomcat-session-replication-test1 êµ¬ë™</li>
  <li>localhost ì ‘ì†</li>
  <li>session í™•ì¸</li>
  <li>tomcat-session-replication-test2 êµ¬ë™</li>
  <li>tomcat-session-replication-test1 ì¤‘ì§€</li>
  <li>localhost ì ‘ì†</li>
  <li>session í™•ì¸</li>
  <li>redis key í™•ì¸</li>
</ol>

<h4 id="í…ŒìŠ¤íŠ¸-ì§„í–‰-1">í…ŒìŠ¤íŠ¸ ì§„í–‰</h4>
<ol>
  <li>tomcat-session-replication-test1 êµ¬ë™
<a href="https://bookstack.ccpinfra.xyz:23443/uploads/images/gallery/2021-05/tomcat-session-test-1.png"><img src="https://bookstack.ccpinfra.xyz:23443/uploads/images/gallery/2021-05/scaled-1680-/tomcat-session-test-1.png" alt="tomcat-session-test-1.png" /></a></li>
  <li>localhost ì ‘ì†</li>
  <li>session í™•ì¸
<a href="https://bookstack.ccpinfra.xyz:23443/uploads/images/gallery/2021-06/tomcat-session-test-5.png"><img src="https://bookstack.ccpinfra.xyz:23443/uploads/images/gallery/2021-06/scaled-1680-/tomcat-session-test-5.png" alt="tomcat-session-test-5.png" /></a></li>
  <li>tomcat-session-replication-test2 êµ¬ë™</li>
  <li>tomcat-session-replication-test1 ì¤‘ì§€
<a href="https://bookstack.ccpinfra.xyz:23443/uploads/images/gallery/2021-05/tomcat-session-test-3.png"><img src="https://bookstack.ccpinfra.xyz:23443/uploads/images/gallery/2021-05/scaled-1680-/tomcat-session-test-3.png" alt="tomcat-session-test-3.png" /></a></li>
  <li>localhost ì ‘ì†</li>
  <li>session í™•ì¸
<a href="https://bookstack.ccpinfra.xyz:23443/uploads/images/gallery/2021-06/tomcat-session-test-6.png"><img src="https://bookstack.ccpinfra.xyz:23443/uploads/images/gallery/2021-06/scaled-1680-/tomcat-session-test-6.png" alt="tomcat-session-test-6.png" /></a></li>
  <li>redis key í™•ì¸
    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker run <span class="nt">-it</span> redis bash
root@c5aeb4bf0493:/data# redis-cli <span class="nt">-h</span> 192.168.0.56		<span class="c"># host local ip</span>
192.168.0.56:6379&gt; keys <span class="k">*</span>
1<span class="o">)</span> <span class="s2">"spring:session:expirations:1622602500000"</span>
2<span class="o">)</span> <span class="s2">"spring:session:sessions:expires:063e4085-0cfc-4c49-b0c9-65a334327e13"</span>
3<span class="o">)</span> <span class="s2">"spring:session:sessions:063e4085-0cfc-4c49-b0c9-65a334327e13"</span>
</code></pre></div>    </div>
  </li>
</ol>

<p>session IDë¥¼ 1ë²ˆ ì¸ìŠ¤í„´ìŠ¤ì—ì„œ ìƒì„±í–ˆìŒì—ë„ 2ë²ˆ tomcatìœ¼ë¡œ ì ‘ì†ì‹œ session IDê°€ ì„œë¡œ ë™ì¼í•œ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
redisì— session ì •ë³´ê°€ ì €ì¥ì´ ë˜ëŠ” ê²ƒì„ í™•ì¸ ê°€ëŠ¥</p>

<h3 id="í…ŒìŠ¤íŠ¸dev-epc-1">í…ŒìŠ¤íŠ¸(Dev EPC)</h3>

<h4 id="epc-ë°°í¬">EPC ë°°í¬</h4>

<p>2ë²ˆ í…ŒìŠ¤íŠ¸ í•­ëª©ì˜ EPC ë°°í¬ ê³¼ì •ê³¼ ë˜‘ê°™ìŒ</p>

<p>Dockerfile <code class="language-plaintext highlighter-rouge">"--spring.profiles.active=robotdev"</code>ë¡œ ìˆ˜ì •</p>

<h4 id="í…ŒìŠ¤íŠ¸-ì§„í–‰pod-fail">í…ŒìŠ¤íŠ¸ ì§„í–‰(Pod fail)</h4>
<ol>
  <li>ì ‘ì† í™•ì¸
<a href="https://bookstack.ccpinfra.xyz:23443/uploads/images/gallery/2021-06/tomcat-session-test-7.png"><img src="https://bookstack.ccpinfra.xyz:23443/uploads/images/gallery/2021-06/scaled-1680-/tomcat-session-test-7.png" alt="tomcat-session-test-7.png" /></a></li>
  <li>ì ‘ì† ë¡œê·¸ í™•ì¸
<a href="https://bookstack.ccpinfra.xyz:23443/uploads/images/gallery/2021-06/tomcat-session-test-8.png"><img src="https://bookstack.ccpinfra.xyz:23443/uploads/images/gallery/2021-06/scaled-1680-/tomcat-session-test-8.png" alt="tomcat-session-test-8.png" /></a></li>
  <li>ì ‘ì†ëœ íŒŒë“œ ì¤‘ì§€
    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl delete pod tomcatsessionclustertest-deploy-79d5796f9c-dwxv2 <span class="nt">-n</span> robotdev
</code></pre></div>    </div>
  </li>
  <li>ì¬ì ‘ì†
<a href="https://bookstack.ccpinfra.xyz:23443/uploads/images/gallery/2021-06/tomcat-session-test-9.png"><img src="https://bookstack.ccpinfra.xyz:23443/uploads/images/gallery/2021-06/scaled-1680-/tomcat-session-test-9.png" alt="tomcat-session-test-9.png" /></a></li>
</ol>

<p>í†°ìº£ ì„¸ì…˜ì´ ëŠê¸°ì§€ ì•Šì€ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.</p>

<blockquote>
  <p>Redisê°€ ì£½ìœ¼ë©´ ì„¸ì…˜ ì ‘ì† ì‹œì ì— redisì— ì ‘ì†í•˜ë¯€ë¡œ ê³„ì† reconnectingí•´ ì„œë¹„ìŠ¤ê°€ ì£½ëŠ” ë¬¸ì œê°€ ì¡´ì¬í•œë‹¤.</p>
</blockquote>

<hr />

<h2 id="reference">Reference</h2>

<ol>
  <li><a href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/">Using RBAC Authorization</a></li>
  <li><a href="https://kubernetes.io/docs/reference/access-authn-authz/node/">Using Node Authorization</a></li>
  <li><a href="https://kubernetes.io/docs/reference/access-authn-authz/node/">Using ABAC Authorization</a></li>
  <li><a href="https://www.udemy.com/course/certified-kubernetes-administrator-with-practice-tests/">Certified Kubernetes Administrator(CKA) with Practice Tests</a></li>
</ol>
:ET