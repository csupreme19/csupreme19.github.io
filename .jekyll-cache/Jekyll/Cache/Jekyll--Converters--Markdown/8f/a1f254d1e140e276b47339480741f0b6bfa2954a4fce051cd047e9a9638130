I"<h1 id="elastic-stack-monitoring-with-metricbeat">Elastic Stack Monitoring with Metricbeat</h1>

<p><img src="/assets/img/titles/kubernetes-logo.png" alt="kubernetes-logo.png" /></p>

<p>Kubernetes 클러스터, 노드, 파드의 메트릭 정보 수집을 위한 <code class="language-plaintext highlighter-rouge">kube-state-metrics</code>와 metricbeat를 배포하여 메트릭 정보를 수집, 모니터링한다.</p>

<hr />

<h2 id="개요">개요</h2>

<p>Kubernetes 메트릭 정보 수집을 위해 Metricbeat를 DaemonSet 형태로 띄워 메트릭 수집</p>

<hr />
<h2 id="kube-state-metrics"><code class="language-plaintext highlighter-rouge">kube-state-metrics</code></h2>
<p>kube-system의 <code class="language-plaintext highlighter-rouge">kube-state-metrics</code> deployment 필요</p>

<p>helm-chart를 이용하여 구성할 것임</p>

<p>GitOps인 ArgoCD를 활용하여 구성한다고 가정</p>

<p>아닌 경우 일반 디렉토리 생성하여 구성하여도 동일함</p>

<h3 id="kube-state-metrics-using-helm"><code class="language-plaintext highlighter-rouge">kube-state-metrics</code> using helm</h3>

<p><a href="https://github.com/prometheus-community/helm-charts/tree/main/charts/kube-state-metrics">helm-charts/kube-state-metrics</a></p>

<h4 id="1-gitlab-argocd-repo에-kube-system-디렉토리-생성새-네임스페이스이므로">1. GitLab ArgoCD repo에 kube-system 디렉토리 생성(새 네임스페이스이므로)</h4>

<h4 id="2-kube-systemkube-state-metrics-디렉토리-생성">2. kube-system/kube-state-metrics 디렉토리 생성</h4>

<h4 id="3-위-helm-링크에서-helm-chart-다운받아-kube-state-metrics에-넣기">3. 위 helm 링크에서 helm chart 다운받아 kube-state-metrics에 넣기</h4>

<h4 id="4-valuesyaml-수정">4. <code class="language-plaintext highlighter-rouge">values.yaml</code> 수정</h4>

<p>worker 노드에 파드를 띄우기 위해 아래 nodeSelector 지정</p>

<p>(zone과 role에 대한 label이 노드에 이미 지정되어 있다고 가정)</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">nodeSelector</span><span class="pi">:</span>
 <span class="na">zone</span><span class="pi">:</span> <span class="s">private</span>
 <span class="na">role</span><span class="pi">:</span> <span class="s">kong</span>
</code></pre></div></div>

<h4 id="5-argocd-new-app-생성kube-system">5. ArgoCD New App 생성(kube-system)</h4>

<h4 id="6-argocd-sync-진행">6. ArgoCD sync 진행</h4>

<h4 id="7-배포-확인">7. 배포 확인</h4>

<hr />
<h2 id="metricbeat-kubernetes">Metricbeat-kubernetes</h2>

<p>kubernetes 메트릭을 모니터링하기위해 metricbeat를 DaemonSet 형태로 k8s cluster에 띄워야함</p>

<h3 id="metricbeat-kubernetes-daemonset-배포">Metricbeat-kubernetes DaemonSet 배포</h3>

<h4 id="1-gitlab-argocd-repo-kube-systemmetricbeat-kubernetes-생성">1. GitLab ArgoCD repo kube-system/metricbeat-kubernetes 생성</h4>

<h4 id="2-metricbeat-kubernetesyaml-다운로드">2. <code class="language-plaintext highlighter-rouge">metricbeat-kubernetes.yaml</code> 다운로드</h4>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 현재 ELK 버전 7.12.1이므로 버전을 맞춘다.</span>
<span class="nv">$ </span>curl <span class="nt">-L</span> <span class="nt">-O</span>    https://raw.githubusercontent.com/elastic/beats/7.12/deploy/kubernetes/metricbeat-kubernetes.yaml
</code></pre></div></div>

<h4 id="3-위에서-받은-metricbeat-kubernetesyaml-gitlab-repo에-파일-추가">3. 위에서 받은 <code class="language-plaintext highlighter-rouge">metricbeat-kubernetes.yaml</code> gitlab repo에 파일 추가</h4>

<h4 id="4-valuesyaml-수정-1">4. <code class="language-plaintext highlighter-rouge">values.yaml</code> 수정</h4>

<p>elastic search 호스트 지정</p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">ELASTICSEARCH_HOST</span>
   <span class="na">value</span><span class="pi">:</span> <span class="s">elasticsearch</span>
 <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">ELASTICSEARCH_PORT</span>
   <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">9200"</span>
 <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">ELASTICSEARCH_USERNAME</span>
   <span class="na">value</span><span class="pi">:</span> <span class="s">elastic</span>
 <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">ELASTICSEARCH_PASSWORD</span>
   <span class="na">value</span><span class="pi">:</span> <span class="s">changeme</span>
</code></pre></div></div>

<h4 id="5-argocd-sync-진행">5. ArgoCD sync 진행</h4>

<h4 id="6-배포-확인">6. 배포 확인</h4>

<hr />
<h2 id="kibana-대시보드-확인">Kibana 대시보드 확인</h2>

<p><img src="/assets/img/contents/km-1.png" alt="km-1.png" /></p>

<hr />
<h2 id="참고사항">참고사항</h2>

<h3 id="수집-영역">수집 영역</h3>
<ul>
  <li>kubelet</li>
  <li>kube-state-metrics</li>
  <li>apiserver</li>
  <li>controller-manager</li>
  <li>scheduler</li>
  <li>proxy</li>
</ul>

<h3 id="metricsets">Metricsets</h3>
<p>사용 가능한 Metricset들 리스트</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    apiserver
    container
    controllermanager
    event
    node
    pod
    proxy
    scheduler
    state_container
    state_cronjob
    state_daemonset
    state_deployment
    state_node
    state_persistentvolumeclaim
    state_pod
    state_replicaset
    state_resourcequota
    state_service
    state_statefulset
    state_storageclass
    system
    volume
</code></pre></div></div>

<hr />

<h2 id="reference">Reference</h2>

<ol>
  <li>
    <p><a href="https://www.elastic.co/guide/en/beats/metricbeat/current/running-on-kubernetes.html">Run Metricbeat on Kubernetes</a></p>
  </li>
  <li><a href="https://www.elastic.co/kr/blog/kubernetes-observability-tutorial-k8s-metrics-collection-and-analysis">Kubernetes 통합 가시성 자습서: 메트릭 수집 및 분석</a></li>
  <li><a href="https://github.com/kubernetes/kube-state-metrics#kubernetes-deployment">kube-state-metrics</a></li>
  <li><a href="https://github.com/prometheus-community/helm-charts/tree/main/charts/kube-state-metrics">helm-charts/kube-state-metrics</a></li>
</ol>
:ET