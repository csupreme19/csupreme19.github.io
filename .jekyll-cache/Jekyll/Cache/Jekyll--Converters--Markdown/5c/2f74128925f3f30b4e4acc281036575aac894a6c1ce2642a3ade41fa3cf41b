I"ë[<h1 id="kubernetes-nginx-ingress-ì ìš©">Kubernetes Nginx Ingress ì ìš©</h1>

<p><img src="/assets/img/titles/nginx-logo.svg" alt="nginx-logo.svg" /></p>

<p><a href="https://kubernetes.io/docs/concepts/services-networking/ingress/">Kubernetes Ingress</a></p>

<p>ë³¸ ë¬¸ì„œëŠ” ì˜¨í”„ë ˆë¯¸ìŠ¤ í™˜ê²½ì—ì„œì˜ Ingress, SSL ì¸ì¦ì„œ ì ìš© ë‚´ìš©ì„ ì •ë¦¬í•˜ì˜€ë‹¤.</p>

<p>nginx ingress controllerë¥¼ ì´ìš©í•˜ì—¬ jenkins ì„œë¹„ìŠ¤ì— ì—°ê²°í•˜ëŠ” ê³¼ì •ì„ ì •ë¦¬í•˜ì˜€ë‹¤.</p>

<hr />
<h2 id="ì„ í–‰-ì‚¬í•­">ì„ í–‰ ì‚¬í•­</h2>
<ul>
  <li>Letâ€™s Encrypt ì¸ì¦ì„œ ë°œê¸‰</li>
  <li>Kubernetes í™˜ê²½ êµ¬ì¶•</li>
  <li>Ingress controller ì„¤ì¹˜</li>
</ul>

<hr />
<h2 id="ingress-ê°œìš”">Ingress ê°œìš”</h2>
<div class="mermaid">
flowchart LR
  A[User]
  subgraph Kubernetes Cluster
  subgraph Ingress
  B[Service: Ingress Contoller]
  J[Pod: Ingress Controller]
  F[Resource: Ingress]
  end
  subgraph Deployment1
  C[Service1]
  G[Pod1]
  end
  subgraph Deployment2
  D[Service2]
  H[Pod2]
  end
  subgraph Deployment3
  E[Service3]
  I[Pod3]
  end
  end
  A -.Ingress.-&gt; B
  B---J
  C---G
  D---H
  E---I
  B---F
  B --&gt; C &amp; D &amp; E
</div>

<p>ì™¸ë¶€ì—ì„œ í´ëŸ¬ìŠ¤í„°ì— ì ‘ê·¼í•  ë•Œ ìš”ì²­ë°›ëŠ” ê²ƒì´ Ingressì´ë‹¤. ì‰½ê²Œ ì–˜ê¸°í•˜ë©´ ì¼ë°˜ì ì¸ proxy, gatewayë¼ê³  ë³´ë©´ ëœë‹¤.</p>

<p>ë™ì¼í•˜ê²Œ ë¡œë“œë°¸ëŸ°ì„œ, ì„œë¹„ìŠ¤ ë©”ì‰¬ì˜ ì—­í• ë„ ìˆ˜í–‰í•˜ë©° ê²½ìš°ì— ë”°ë¼ì„œëŠ” Blue Green ë°°í¬ë‚˜ Canary ë°°í¬ë„ ê°€ëŠ¥í•˜ë‹¤.</p>

<p>ì™¸ë¶€ â†’ Ingress â†’ Service â†’ Pod</p>

<p>ë‚´ë¶€ ì„œë¹„ìŠ¤ì— SSL ì¸ì¦ì„œë¥¼ ì ìš©í•˜ëŠ” ê²ƒì´ ì•„ë‹Œ Ingressì— ì¸ì¦ì„œë¥¼ ì ìš©í•œë‹¤.</p>

<p>ì´ì™€ ê°™ì´ ì ìš©í•˜ë©´ ì„œë¹„ìŠ¤ ì¢…ì†ì„± ì—†ì´ ì•ë‹¨ì—ì„œ ì¸ì¦ì„œ ì ìš©ì´ ê°€ëŠ¥í•˜ë¯€ë¡œ ë’·ë‹¨ì˜ ì„œë¹„ìŠ¤ê°€ ì¶”ê°€ë˜ì–´ë„ ì‰½ê²Œ ì ìš©ì´ ê°€ëŠ¥í•˜ë‹¤.</p>

<h3 id="ingress-controllerì™€-ingress-resourceì˜-ì°¨ì´"><code class="language-plaintext highlighter-rouge">Ingress Controller</code>ì™€ <code class="language-plaintext highlighter-rouge">Ingress Resource</code>ì˜ ì°¨ì´</h3>

<p><img src="/assets/img/contents/ki-2.png" alt="ki-2.png" /></p>

<h4 id="ingress-controller">Ingress Controller</h4>

<p><img src="/assets/img/contents/ki-1.png" alt="ki-1.png" /></p>

<blockquote>
  <p>ì´ë¯¸ì§€: <a href="https://www.udemy.com/course/certified-kubernetes-administrator-with-practice-tests/">Certified Kubernetes Administrator(CKA) with Practice Tests</a> ë°œì·Œ</p>
</blockquote>

<ul>
  <li><code class="language-plaintext highlighter-rouge">80:31280/TCP</code>, <code class="language-plaintext highlighter-rouge">443:32443/TCP</code>ë“±ì˜ ì„œë¹„ìŠ¤ì™€ í•¨ê»˜ NodePort í˜•ì‹ìœ¼ë¡œ ì™¸ë¶€ì™€ì˜ ì—°ê²°ì„ ë‹´ë‹¹</li>
  <li>ë³´í†µ nginx, haproxy ë“± proxy ì„œë²„ë¡œ êµ¬í˜„ë˜ì–´ ìˆë‹¤.</li>
  <li>Ingress Resourceì˜ ì„¤ì •ê°’(Ingress Rule)ì— ë”°ë¼ í´ëŸ¬ìŠ¤í„° ë‚´ì˜ Serviceë¡œ ì—°ê²°í•œë‹¤.</li>
</ul>

<h4 id="ingress-resource">Ingress Resource</h4>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">networking.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Ingress</span>
<span class="na">metadata</span><span class="pi">:</span>
<span class="nn">...</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">rules</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">host</span><span class="pi">:</span> <span class="s">service.yourdomain.com</span> <span class="c1"># ì´ ë¶€ë¶„ ì¶”ê°€ (í•˜ì´í”ˆì€ ë§¨ ìœ„ì—ë§Œ ìˆì–´ì•¼í•¨)</span>
    <span class="na">http</span><span class="pi">:</span>
      <span class="na">paths</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">pathType</span><span class="pi">:</span> <span class="s">Prefix</span>
        <span class="na">path</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/service"</span>
        <span class="na">backend</span><span class="pi">:</span>
          <span class="na">service</span><span class="pi">:</span>
            <span class="na">name</span><span class="pi">:</span> <span class="s">service-name</span>
            <span class="na">port</span><span class="pi">:</span>
              <span class="na">number</span><span class="pi">:</span> <span class="m">8080</span>
</code></pre></div></div>

<ul>
  <li>Ingress Controllerì—ì„œ ì–´ë–¤ ì„œë¹„ìŠ¤ë¡œ ë¼ìš°íŒ…í•  ê²ƒì¸ì§€ ê·œì¹™ì„ ëª…ì„¸í•œ Resourceì´ë‹¤.</li>
  <li>pathë“±ì˜ ê°’ìœ¼ë¡œ ì–´ë–¤ serviceì— ì—°ê²°í•  ê²ƒì¸ì§€ì— ëŒ€í•œ ëª…ì„¸ì´ë‹¤.</li>
  <li>Kubernetes secret ë¦¬ì†ŒìŠ¤ë¥¼ ì°¸ì¡°í•˜ì—¬ tls ì—°ê²°ì„ ì„¤ì •í•  ìˆ˜ ìˆë‹¤.</li>
</ul>

<hr />
<h2 id="ingress-ì ìš©">Ingress ì ìš©</h2>

<h3 id="ì¸ì¦ì„œ-íŒŒì¼-êµ¬ì„±">ì¸ì¦ì„œ íŒŒì¼ êµ¬ì„±</h3>

<p>PEM í¬ë§·ì˜ RSA crt, keyê°€ í•„ìš”í•˜ë‹¤.</p>

<p>ë³¸ ë¬¸ì„œì—ì„œëŠ” Letâ€™s Encryptì˜ DNS í¬ë§·ìœ¼ë¡œ ë°œê¸‰ëœ *.yourdomain.com ë„ë©”ì¸ ì¸ì¦ì„œë¥¼ ì‚¬ìš©í•œë‹¤.</p>

<h4 id="ì˜ˆì‹œ"><strong>ì˜ˆì‹œ</strong>)</h4>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># yourdomain.com.crt</span>
<span class="nt">-----BEGIN</span> CERTIFICATE-----
MII...
<span class="nt">-----END</span> CERTIFICATE-----

<span class="c"># yourdomain.com.crt</span>
Private-Key: <span class="o">(</span>2048 bit<span class="o">)</span>
modulus:
...
<span class="nt">-----BEGIN</span> RSA PRIVATE KEY-----
MII...
<span class="nt">-----END</span> RSA PRIVATE KEY-----
</code></pre></div></div>

<h3 id="kubernetes-secret-ìƒì„±">Kubernetes secret ìƒì„±</h3>

<p>kubernetesì—ì„œëŠ” ì—¬ëŸ¬ê°€ì§€ ì‹œí¬ë¦¿ íƒ€ì…ì„ ì œê³µí•˜ëŠ”ë°</p>

<p>ê·¸ ì¤‘ SSL ì¸ì¦ì„œì— ëŒ€í•œ ì •ë³´ë¥¼ ë‹´ê³  ìˆëŠ” Secret íƒ€ì…ì€ <code class="language-plaintext highlighter-rouge">kubernetes.io/tls</code> ì´ë‹¤.</p>

<p>secret ìƒì„±í•˜ëŠ” ë‘ ê°€ì§€ ë°©ë²•ì´ ì¡´ì¬</p>

<h4 id="1-secret-yaml-íŒŒì¼-ìƒì„±">1. secret yaml íŒŒì¼ ìƒì„±</h4>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>vim service-secret.yaml

apiVersion: v1
kind: Secret
metadata:
  name: secret-tls
<span class="nb">type</span>: kubernetes.io/tls
data:
  <span class="c"># the data is abbreviated in this example</span>
  tls.crt: |
        MIIC2DCCAcCgAwIBAgIBATANBgkqh ...
  tls.key: |
        MIIEpgIBAAKCAQEA7yn3bRHQ5FHMQ ...
</code></pre></div></div>

<p>ì´ ê²½ìš° ì¸ì¦ì„œ ê°’ì€ â€”â€“BEGIN CERTIFICATEâ€”â€“ì™€ â€”â€“END CERTIFICATEâ€”â€“ ì‚¬ì´ì— ìˆëŠ” ì¸ì½”ë”©ê°’ì„ ë„£ì–´ì•¼í•œë‹¤ê³  í•œë‹¤.</p>

<blockquote>
  <p>í™•ì¸ê²°ê³¼ .crt ì•ˆì— ìˆëŠ” ì¸ì¦ì„œ ê°’ì„ ëª¨ë‘ í¬í•¨í•˜ì—¬ì•¼í•¨</p>
</blockquote>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl create <span class="nt">-f</span> service-secret.yaml
</code></pre></div></div>

<p>kubernetes secret ìƒì„±</p>

<h4 id="2-ì§ì ‘-ìƒì„±ê¶Œì¥">2. ì§ì ‘ ìƒì„±(ê¶Œì¥)</h4>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># kubectl create secret {type} {name} --cert {certPath} --key {keyPath}</span>
<span class="nv">$ </span>kubectl create secret tls secret-tls <span class="nt">--cert</span> ssl/yourdomain.com.crt <span class="nt">--key</span> ssl/yourdomain.com.key
</code></pre></div></div>

<p>Imperative ë°©ì‹ìœ¼ë¡œ ìƒì„±</p>

<p>ì¸ì¦ì„œ íŒŒì¼ì„ ì„¤ì •ê°’ìœ¼ë¡œ ë¬¼ê³ ê°ˆ ìˆ˜ ìˆì–´ì„œ ê¶Œì¥</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># secret ìƒì„± í™•ì¸</span>
<span class="nv">$ </span>kubectl get secret
<span class="nv">$ </span>kubectl describe secret secret-tls
</code></pre></div></div>
<hr />
<h2 id="ingress-tls-ì ìš©">Ingress TLS ì ìš©</h2>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">$ vim jenkins-ingress.yaml</span>

<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">networking.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Ingress</span>
<span class="na">metadata</span><span class="pi">:</span>
<span class="nn">...</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">rules</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">host</span><span class="pi">:</span> <span class="s">jenkins.yourdomain.com</span> <span class="c1"># ì´ ë¶€ë¶„ ì¶”ê°€ (í•˜ì´í”ˆì€ ë§¨ ìœ„ì—ë§Œ ìˆì–´ì•¼í•¨)</span>
    <span class="na">http</span><span class="pi">:</span> 
      <span class="na">paths</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">pathType</span><span class="pi">:</span> <span class="s">Prefix</span>
        <span class="na">path</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/jenkins"</span>
        <span class="na">backend</span><span class="pi">:</span>
          <span class="na">service</span><span class="pi">:</span>
            <span class="na">name</span><span class="pi">:</span> <span class="s">jenkins</span>
            <span class="na">port</span><span class="pi">:</span>
              <span class="na">number</span><span class="pi">:</span> <span class="m">8080</span>
  <span class="c1"># ì•„ë˜ ë¶€ë¶„ ì¶”ê°€</span>
  <span class="na">tls</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">hosts</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">jenkins.yourdomain.com</span>
    <span class="na">secretName</span><span class="pi">:</span> <span class="s">secret-tls</span>
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ì ìš©</span>
<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> jenkins-ingress.yaml
</code></pre></div></div>
<p>ìœ„ì—ì„œ ìƒì„±í•œ Secretì„ ì´ìš©í•˜ë©´ Ingressì— ì¸ì¦ì„œë¥¼ ì ìš©í•  ìˆ˜ ìˆë‹¤.</p>

<h3 id="ì¸ì¦ì„œ-ì ìš©-í™•ì¸">ì¸ì¦ì„œ ì ìš© í™•ì¸</h3>

<h4 id="1-ingress-controller-ì ‘ì†-í™•ì¸">1. Ingress Controller ì ‘ì† í™•ì¸</h4>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ingress-nginx ì„œë¹„ìŠ¤ í¬íŠ¸ë§¤í•‘ í™•ì¸</span>
<span class="nv">$ </span>kubectl get svc <span class="nt">-A</span>

NAMESPACE       NAME                                 TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>                      AGE
ingress-nginx   ingress-nginx-controller             NodePort    10.104.33.237    &lt;none&gt;        80:31623/TCP,443:32452/TCP   29h

<span class="nv">$ </span>curl <span class="nt">-k</span> <span class="nt">-v</span> https://10.104.33.237:443
...
<span class="k">*</span> Connected to 10.104.33.237 <span class="o">(</span>10.104.33.237<span class="o">)</span> port 443 <span class="o">(</span><span class="c">#0)</span>
...
</code></pre></div></div>

<h4 id="2-ì™¸ë¶€-ë„ë©”ì¸-ì ‘ì†-í™•ì¸">2. ì™¸ë¶€ ë„ë©”ì¸ ì ‘ì† í™•ì¸</h4>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl <span class="nt">-k</span> <span class="nt">-v</span> https://jenkins.yourdomain.com:32452
...
<span class="k">*</span> Connected to jenkins.yourdomain.com <span class="o">(</span>...<span class="o">)</span> port 32452 <span class="o">(</span><span class="c">#0)</span>
...
</code></pre></div></div>

<h4 id="3-ì¸ì¦ì„œ-ê²€ì¦">3. ì¸ì¦ì„œ ê²€ì¦</h4>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>openssl s_client <span class="nt">-debug</span> <span class="nt">-connect</span> https://jenkins.yourdomain.com:32452

...
<span class="nv">subject</span><span class="o">=</span>CN <span class="o">=</span> <span class="k">*</span>.yourdomain.com

<span class="nv">issuer</span><span class="o">=</span>C <span class="o">=</span> US, O <span class="o">=</span> Let<span class="s1">'s Encrypt, CN = R3
...
---
</span></code></pre></div></div>

<h4 id="4-ì›¹-ë¸Œë¼ìš°ì €ë¡œ-ì ‘ì†í•˜ì—¬-ì¸ì¦ì„œ-í™•ì¸">4. ì›¹ ë¸Œë¼ìš°ì €ë¡œ ì ‘ì†í•˜ì—¬ ì¸ì¦ì„œ í™•ì¸</h4>

<p><img src="/assets/img/contents/ki-3.png" alt="ki-3.png" /></p>

<hr />
<h3 id="ssl-redirect-ë„ê¸°">SSL Redirect ë„ê¸°</h3>

<p>ìœ„ì²˜ëŸ¼ Ingress ì„¤ì •ì— tlsë¥¼ ì ìš©í•˜ë©´ https ì ‘ì†ì´ ê°•ì œë˜ë¯€ë¡œ ê¸°ì¡´ì— httpì— ìš´ì˜ì¤‘ì¸ ì„œë¹„ìŠ¤ì— ì˜í–¥ì´ ìˆë‹¤.</p>

<p>ë”°ë¼ì„œ ê¸°ì¡´ì˜ http ì„œë¹„ìŠ¤ëŠ” httpsë¡œ redirect ë˜ì§€ ì•Šë„ë¡ ì„¤ì •í•˜ì—¬ì•¼ í•œë‹¤.</p>

<h4 id="1-ingress-rule-ë³€ê²½">1. Ingress rule ë³€ê²½</h4>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">$ vim jenkins-ingress.yaml</span>

<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">networking.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Ingress</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="s">...</span>
  <span class="s">namespace</span><span class="err">:</span> <span class="s">default</span>
  <span class="s"># ì•„ë˜ annotations ì¶”ê°€</span>
  <span class="s">annotations</span><span class="err">:</span>
    <span class="na">kubernetes.io/ingress.class</span><span class="pi">:</span> <span class="s2">"</span><span class="s">nginx"</span>
    <span class="na">nginx.ingress.kubernetes.io/ssl-redirect</span><span class="pi">:</span> <span class="s2">"</span><span class="s">false"</span>
    <span class="na">nginx.ingress.kubernetes.io/force-ssl-redirect</span><span class="pi">:</span> <span class="s2">"</span><span class="s">false"</span>
</code></pre></div></div>

<blockquote>
  <p>Ingress ruleì˜ <code class="language-plaintext highlighter-rouge">ssl-redirect</code> ì„¤ì •ì€ host ì£¼ì†Œì™€ portëŠ” ê·¸ëŒ€ë¡œ ë‘”ì±„ http ìš”ì²­ì„ httpsë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸í•œë‹¤.(ì„œë²„ì—ì„œ https redirect ì‘ë‹µ)</p>

  <p>ì˜ˆì‹œ) http://jenkins.yourdomain.com:31623/jenkins â†’ https://jenkins.yourdomain.com:31623/jenkins</p>
</blockquote>

<h4 id="2-configmap-ì„¤ì •-ë³€ê²½">2. ConfigMap ì„¤ì • ë³€ê²½</h4>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># vim ~/ingress-controller/ingress-nginx/deploy/static/provider/baremetal/deploy.yaml</span>

<span class="c1"># Source: ingress-nginx/templates/controller-configmap.yaml</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ConfigMap</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">helm.sh/chart</span><span class="pi">:</span> <span class="s">ingress-nginx-3.23.0</span>
    <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
    <span class="na">app.kubernetes.io/version</span><span class="pi">:</span> <span class="s">0.44.0</span>
    <span class="na">app.kubernetes.io/managed-by</span><span class="pi">:</span> <span class="s">Helm</span>
    <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">controller</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ingress-nginx-controller</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">ingress-nginx</span>
<span class="c1"># ì•„ë˜ ë¶€ë¶„ ì¶”ê°€</span>
<span class="na">data</span><span class="pi">:</span>
  <span class="na">hsts</span><span class="pi">:</span> <span class="s2">"</span><span class="s">false"</span>
  <span class="na">ssl-redirect</span><span class="pi">:</span> <span class="s2">"</span><span class="s">false"</span>
</code></pre></div></div>

<blockquote>
  <p>Ingress controllerì˜ <code class="language-plaintext highlighter-rouge">ssl-redirect</code> ì„¤ì •ì€ host ì£¼ì†ŒëŠ” ê·¸ëŒ€ë¡œì§€ë§Œ httpsì˜ default portì¸ 443ìœ¼ë¡œ redirectí•œë‹¤.</p>

  <p>ì˜ˆì‹œ) http://jenkins.yourdomain.com:31623/jenkins â†’ https://jenkins.yourdomain.com/jenkins</p>
</blockquote>

<p>ingress-controllerì˜ baremetal templateì— ìˆëŠ” ConfigMapìœ¼ë¡œ ë„ì›Œì ¸ ìˆìœ¼ë¯€ë¡œ í•´ë‹¹ ë¶€ë¶„ ìˆ˜ì •</p>

<p>ë§Œì•½ ë‹¤ë¥¸ í™˜ê²½ìœ¼ë¡œ ì¸í•˜ì—¬ ConfigMapì´ ì—†ëŠ” ê²½ìš° ìƒˆë¡œ ìƒì„±í•˜ì—¬ ì ìš©í•  ê²ƒ</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl apply <span class="nt">-f</span> deploy.yaml
</code></pre></div></div>
<p>ì„¤ì • ë³€ê²½ ì ìš©</p>

<p>ì¶”ê°€ë¡œ ì ìš©ê¸°ê°„ì—ëŠ” httpì™€ httpsì˜ í¬íŠ¸ë¥¼ ì„œë¡œ ë‹¤ë¥´ê²Œí•˜ì—¬ ë‘˜ ë‹¤ ì ‘ì† ê°€ëŠ¥í•˜ë„ë¡ ë§Œë“œëŠ” ê²ƒì´ ì˜³ë‹¤.</p>

<p>í˜„ì¬ httpì™€ httpsë¥¼ ë™ì‹œ ì„œë¹„ìŠ¤ ì¤‘ì´ê¸° ë•Œë¬¸ì— ì„œë¡œ ë‹¤ë¥¸ í¬íŠ¸ì—ì„œ ì ‘ê·¼ì„ í•œë‹¤.</p>

<p>ë”°ë¼ì„œ ìˆ˜ë™ìœ¼ë¡œ Host ì£¼ì†Œì™€ portë¥¼ ë³€ê²½í•´ì£¼ì–´ì•¼ í•œë‹¤.</p>

<h4 id="3-ingress-rule-ë³€ê²½">3. Ingress rule ë³€ê²½</h4>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">$ vim jenkins-ingress.yaml</span>

<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">networking.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Ingress</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="s">...</span>
  <span class="s">namespace</span><span class="err">:</span> <span class="s">default</span>
  <span class="s"># ì•„ë˜ annotations ì¶”ê°€</span>
  <span class="s">annotations</span><span class="err">:</span>
<span class="err">  	</span><span class="na">kubernetes.io/ingress.class</span><span class="pi">:</span> <span class="s2">"</span><span class="s">nginx"</span>
    <span class="na">nginx.ingress.kubernetes.io/proxy-redirect-from</span><span class="pi">:</span> <span class="s">http://jenkins.yourdomain.com:31623</span>
    <span class="na">nginx.ingress.kubernetes.io/proxy-redirect-to</span><span class="pi">:</span> <span class="s">https://jenkins.yourdomain.com:32452</span>
    <span class="na">nginx.ingress.kubernetes.io/ssl-redirect</span><span class="pi">:</span> <span class="s2">"</span><span class="s">false"</span>
    <span class="na">nginx.ingress.kubernetes.io/force-ssl-redirect</span><span class="pi">:</span> <span class="s2">"</span><span class="s">false"</span>
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl <span class="nt">-v</span> http://jenkins.jenkins.yourdomain.com:32452
<span class="k">*</span> About to connect<span class="o">()</span> to jenkins.yourdomain.com port 32452 <span class="o">(</span><span class="c">#0)</span>
<span class="k">*</span>   Trying ...
<span class="k">*</span> Connected to jenkins.yourdomain.com <span class="o">(</span>...<span class="o">)</span> port 32425 <span class="o">(</span><span class="c">#0)</span>
<span class="o">&gt;</span> GET /jenkins HTTP/1.1
<span class="o">&gt;</span> User-Agent: curl/7.29.0
<span class="o">&gt;</span> Host: jenkins.yourdomain.com:32452
<span class="o">&gt;</span> Accept: <span class="k">*</span>/<span class="k">*</span>
<span class="o">&gt;</span>
&lt; HTTP/1.1 302 Found
&lt; Date: Fri, 05 Mar 2021 04:51:59 GMT
&lt; Content-Length: 0
&lt; Connection: keep-alive
&lt; Location: https://jenkins.yourdomain.com:32452/
</code></pre></div></div>
<p>í…ŒìŠ¤íŠ¸í•´ë³´ë©´ redirectê°€ ì •ìƒì ìœ¼ë¡œ ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.</p>

<h3 id="í¬ë¡¬ì˜-ê²½ìš°-hsts-ê¸°ëŠ¥-ë„ê¸°">í¬ë¡¬ì˜ ê²½ìš° HSTS ê¸°ëŠ¥ ë„ê¸°</h3>

<p>ìœ„ì™€ ê°™ì´ ì„¤ì •í•´ë„ í¬ë¡¬ê³¼ ê°™ì€ ì›¹ë¸Œë¼ìš°ì €ì˜ ê²½ìš° HSTS ê¸°ëŠ¥ë•Œë¬¸ì— ì›¹ë¸Œë¼ìš°ì € ë ˆë²¨ì—ì„œ</p>

<p>ìœ„ì—ì„œ ì„¤ì •í•œ proxyê°€ ì•„ë‹ˆë¼ í˜¸ìŠ¤íŠ¸ì™€ í¬íŠ¸ëŠ” ê·¸ëŒ€ë¡œì¸ ìƒíƒœë¡œ http â†’ https ë¦¬ë‹¤ì´ë ‰ì…˜ì´ ê°•ì œëœë‹¤.</p>

<blockquote>
  <p>http ì ‘ì†ì„ í•œ í›„ì— ì„œë²„ì—ì„œ https ì‘ë‹µì„ ì£¼ëŠ”ë° http ì ‘ì† ì´ì „ì— ë¸Œë¼ìš°ì €ì—ì„œ httpsë¡œ ë³€ê²½í•˜ê¸° ë•Œë¬¸ì´ë‹¤.</p>

</blockquote>

<p>ì‹œí¬ë¦¿ ëª¨ë“œë¡œ ë“¤ì–´ê°€ì„œ í…ŒìŠ¤íŠ¸í•˜ê±°ë‚˜ ì´ë¯¸ í¬ë¡¬ì— ì„¤ì •ëœ HSTS ì„¤ì •ì„ ì œê±°í•´ì•¼í•œë‹¤.</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">chrome://net-internals/#hsts</code> ì ‘ì†</li>
  <li>Query HSTS/PKP domainì—ì„œ HSTS ì„¤ì •ë˜ì–´ ìˆëŠ”ì§€ ê²€ìƒ‰
<img src="/assets/img/contents/ki-4.png" alt="ki-4.png" /></li>
  <li>Delete domain security policiesì—ì„œ í•´ë‹¹ ë„ë©”ì¸ HSTS ì„¤ì • ì§€ìš°ê¸°</li>
</ol>

<p>ì´í›„ í¬ë¡¬ì„ í†µí•´ ì¬ì ‘ì†í•˜ë©´ https redirectê°€ ì„±ê³µì ìœ¼ë¡œ ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.</p>

<hr />
<h2 id="ì°¸ê³ ì‚¬í•­">ì°¸ê³ ì‚¬í•­</h2>
<ol>
  <li>Ingress controller ê¸°ë³¸ ì¸ì¦ì„œë¥¼ ê°€ì ¸ê°„ë‹¤?</li>
</ol>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span> successfully <span class="nb">set </span>certificate verify locations:
<span class="k">*</span>   CAfile: /etc/ssl/certs/ca-certificates.crt
  CApath: /etc/ssl/certs
</code></pre></div></div>

<p>ìœ„ì²˜ëŸ¼ Ingress Controllerì—ì„œ ê¸°ë³¸ ì„¤ì • SSL Certë¥¼ ê°€ì ¸ê°„ë‹¤ê³  ë‚˜ì˜¤ëŠ”ë° Ingress Controllerì—ì„œ SSLì„ ì„¤ì •í•˜ëŠ” ê²ƒì´ ì•„ë‹Œ Ingressì˜ Secret ì„¤ì •ì— ìˆëŠ” ì¸ì¦ì„œ íŒŒì¼ì„ ì ìš©í•˜ëŠ” ê²ƒì´ê¸° ë•Œë¬¸ì— ë¬´ì‹œí•´ë„ ëœë‹¤.</p>

<hr />
<h2 id="troubleshooting">Troubleshooting</h2>

<ol>
  <li>Kubernetes Ingress Controller Fake Certificate ì¸ì¦ì„œê°€ ì ìš©ë  ë•Œ</li>
</ol>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Certificate:
    Data:
        Version: 3 <span class="o">(</span>0x2<span class="o">)</span>
        Serial Number:
            0a:2a:7b:52:02:51:fe:7d:ff:ad:65:ea:41:8a:95:44
        Signature Algorithm: sha256WithRSAEncryption
        Issuer: O <span class="o">=</span> Acme Co, CN <span class="o">=</span> Kubernetes Ingress Controller Fake Certificate
</code></pre></div></div>

<p>Ingressì— tls ì„¤ì •ì„ ì¶”ê°€í•  ê²½ìš° ê¸°ë³¸ì ìœ¼ë¡œ í•´ë‹¹ ì„œë¹„ìŠ¤ëŠ” httpsë¥¼ ì‚¬ìš©í•˜ê²Œ ë˜ë©° ì¸ì¦ì„œ ì„¤ì •ì„ ë³„ë„ë¡œ í•´ì£¼ì§€ ì•Šì€ ê²½ìš° Ingress Controller fake certificateë¥¼ ê¸°ë³¸ì ìœ¼ë¡œ ì‚¬ìš©í•˜ê²Œ ëœë‹¤.</p>

<p>ì´ ê²½ìš°ëŠ” ìœ„ì—ì„œ ì„¤ì •í•œ ì¸ì¦ì„œ ì ìš©ì´ ì•ˆ ëœ ê²½ìš°ì´ë‹¤.</p>

<ol>
  <li>kubernetes secretì—ì„œ certì™€ keyë¥¼ ì˜ ë¬¼ê³  ê°”ëŠ”ì§€ í™•ì¸</li>
  <li>Ingress yaml íŒŒì¼ì— tls ì ìš©ì´ ì œëŒ€ë¡œ ë˜ì—ˆëŠ”ì§€ í™•ì¸
    <ul>
      <li>sslì„ ì ìš©í•  ê²½ìš° ì—°ë™ë˜ëŠ” ì„œë¹„ìŠ¤ì™€ tls ì„¤ì •ì— host ì´ë¦„ì„ ê¼­ ì¶”ê°€í•´ì£¼ì–´ì•¼í•œë‹¤.</li>
    </ul>
  </li>
</ol>

<hr />

<h2 id="reference">Reference</h2>

<ol>
  <li><a href="https://kubernetes.io/docs/concepts/services-networking/ingress/">Ingress</a></li>
  <li><a href="https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/">Ingress Controllers</a></li>
  <li><a href="https://kubernetes.io/docs/concepts/configuration/secret/">Secret</a></li>
  <li><a href="https://www.udemy.com/course/certified-kubernetes-administrator-with-practice-tests/">Certified Kubernetes Administrator(CKA) with Practice Tests</a></li>
</ol>
:ET