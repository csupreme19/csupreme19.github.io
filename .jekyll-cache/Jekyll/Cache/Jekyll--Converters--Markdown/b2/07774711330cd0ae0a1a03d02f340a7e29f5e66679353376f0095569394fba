I"Ø!<h1 id="kubernetes-metricbeat">Kubernetes Metricbeat</h1>

<p><img src="/assets/img/titles/gitlab-horizontal-color.png" alt="gitlab-horizontal-color.png" /></p>

<p><a href="https://docs.gitlab.com/omnibus/settings/README.html">Configuring Omnibus GitLab</a></p>

<p>Kubernetes í´ëŸ¬ìŠ¤í„°, ë…¸ë“œ, íŒŒë“œì˜ ë©”íŠ¸ë¦­ ì •ë³´ ìˆ˜ì§‘ì„ ìœ„í•œ <code class="language-plaintext highlighter-rouge">kube-state-metrics</code>ì™€ metricbeatë¥¼ ë°°í¬í•˜ì—¬ ë©”íŠ¸ë¦­ ì •ë³´ë¥¼ ìˆ˜ì§‘, ëª¨ë‹ˆí„°ë§í•œë‹¤.</p>

<hr />

<h2 id="ê°œìš”">ê°œìš”</h2>

<p>Kubernetes ë©”íŠ¸ë¦­ ì •ë³´ ìˆ˜ì§‘ì„ ìœ„í•´ Metricbeatë¥¼ DaemonSet í˜•íƒœë¡œ ë„ì›Œ ë©”íŠ¸ë¦­ ìˆ˜ì§‘</p>

<hr />
<h3 id="kube-state-metrics-ë„ìš°ê¸°"><code class="language-plaintext highlighter-rouge">kube-state-metrics</code> ë„ìš°ê¸°</h3>
<p>kube-systemì˜ <code class="language-plaintext highlighter-rouge">kube-state-metrics</code> deployment í•„ìš”</p>

<p><a href="https://github.com/kubernetes/kube-state-metrics#kubernetes-deployment">https://github.com/kubernetes/kube-state-metrics#kubernetes-deployment</a></p>

<p>helm: <a href="https://github.com/prometheus-community/helm-charts/tree/main/charts/kube-state-metrics">https://github.com/prometheus-community/helm-charts/tree/main/charts/kube-state-metrics</a></p>

<ol>
  <li>GitLab ArgoCD repoì— kube-system ë””ë ‰í† ë¦¬ ìƒì„±(ìƒˆ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì´ë¯€ë¡œ)</li>
  <li>kube-system/kube-state-metrics ë””ë ‰í† ë¦¬ ìƒì„±</li>
  <li>ìœ„ helm ë§í¬ì—ì„œ helm chart ë‹¤ìš´ë°›ì•„ kube-state-metricsì— ë„£ê¸°</li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">values.yaml</code> ìˆ˜ì •</p>

    <p>worker ë…¸ë“œì— íŒŒë“œë¥¼ ë„ìš°ê¸° ìœ„í•´ ì•„ë˜ nodeSelector ì§€ì •</p>
    <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">nodeSelector</span><span class="pi">:</span>
 <span class="na">zone</span><span class="pi">:</span> <span class="s">private</span>
 <span class="na">role</span><span class="pi">:</span> <span class="s">kong</span>
</code></pre></div>    </div>
  </li>
  <li>ArgoCD New App ìƒì„±(kube-system)</li>
  <li>ArgoCD sync ì§„í–‰</li>
  <li>ë°°í¬ í™•ì¸</li>
</ol>

<hr />
<h3 id="metricbeat-kubernetes-daemonset-ë°°í¬">Metricbeat-kubernetes DaemonSet ë°°í¬</h3>

<p>kubernetes ë©”íŠ¸ë¦­ì„ ëª¨ë‹ˆí„°ë§í•˜ê¸°ìœ„í•´ metricbeatë¥¼ DaemonSet í˜•íƒœë¡œ k8s clusterì— ë„ì›Œì•¼í•¨</p>

<ol>
  <li>GitLab ArgoCD repo kube-system/metricbeat-kubernetes ìƒì„±</li>
  <li><code class="language-plaintext highlighter-rouge">metricbeat-kubernetes.yaml</code> ë‹¤ìš´ë¡œë“œ
    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># í˜„ì¬ ELK ë²„ì „ 7.12.1ì´ë¯€ë¡œ ë²„ì „ì„ ë§ì¶˜ë‹¤.</span>
curl <span class="nt">-L</span> <span class="nt">-O</span>    https://raw.githubusercontent.com/elastic/beats/7.12/deploy/kubernetes/metricbeat-kubernetes.yaml
</code></pre></div>    </div>
  </li>
  <li>ìœ„ì—ì„œ ë°›ì€ <code class="language-plaintext highlighter-rouge">metricbeat-kubernetes.yaml</code> gitlab repoì— íŒŒì¼ ì¶”ê°€</li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">values.yaml</code> ìˆ˜ì •</p>

    <p>elastic search í˜¸ìŠ¤íŠ¸ ì§€ì •</p>
    <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">ELASTICSEARCH_HOST</span>
   <span class="na">value</span><span class="pi">:</span> <span class="s">elasticsearch</span>
 <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">ELASTICSEARCH_PORT</span>
   <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">9200"</span>
 <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">ELASTICSEARCH_USERNAME</span>
   <span class="na">value</span><span class="pi">:</span> <span class="s">elastic</span>
 <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">ELASTICSEARCH_PASSWORD</span>
   <span class="na">value</span><span class="pi">:</span> <span class="s">changeme</span>
</code></pre></div>    </div>
  </li>
  <li>ArgoCD sync ì§„í–‰</li>
  <li>ë°°í¬ í™•ì¸</li>
</ol>

<hr />
<h3 id="kibana-ëŒ€ì‹œë³´ë“œ-í™•ì¸">Kibana ëŒ€ì‹œë³´ë“œ í™•ì¸</h3>

<p><a href="https://bookstack.ccpinfra.xyz:23443/uploads/images/gallery/2021-06/kubernetes-metricbeat-1.png"><img src="https://bookstack.ccpinfra.xyz:23443/uploads/images/gallery/2021-06/scaled-1680-/kubernetes-metricbeat-1.png" alt="kubernetes-metricbeat-1.png" /></a></p>

<hr />
<h3 id="ì°¸ê³ ì‚¬í•­">ì°¸ê³ ì‚¬í•­</h3>

<h4 id="deployment">deployment</h4>
<p>ìˆ˜ì§‘ í˜•íƒœì— ë”°ë¥¸ metricbeatì˜ deployment ì¢…ë¥˜:</p>
<ul>
  <li>daemonset: ì „ì²´ ê°ê°ì˜ nodeì˜ ì •ë³´ ìˆ˜ì§‘</li>
  <li>deployment(1ê°œì˜ replication): ì „ì²´ì—ì„œ ë‹¨ 1ê°œë§Œ ìˆìœ¼ë©´ ë¨</li>
</ul>

<h4 id="ìˆ˜ì§‘-ì˜ì—­">ìˆ˜ì§‘ ì˜ì—­</h4>
<ul>
  <li>kubelet</li>
  <li>kube-state-metrics</li>
  <li>apiserver</li>
  <li>controller-manager</li>
  <li>scheduler</li>
  <li>proxy</li>
</ul>

<h4 id="apiserver">apiserver</h4>
<p>ssl(https) or toklen ì¸ì¦ í•„ìš”.</p>

<p><code class="language-plaintext highlighter-rouge">/metrics</code> API ì„œë¹„ìŠ¤ì— ì ‘ê·¼ì„ ìœ„í•œ ì•„ë˜ì˜ permissionì„ ClusterRoleì— ì¶”ê°€ í•„ìš”í•  ìˆ˜ë„ ìˆìŒ:</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rules:
- nonResourceURLs:
  - /metrics
  verbs:
  - get
</code></pre></div></div>

<h4 id="proxy">proxy</h4>
<p>ê°ê° ëª¨ë“  nodeì— ì ‘ê·¼ í•„ìš”. =&gt; Metricbeat DaemonSet ìœ¼ë¡œ ë°°í¬.</p>

<h4 id="scheduler-and-controllermanager">scheduler and controllermanager</h4>
<p>kubernetesì˜ <code class="language-plaintext highlighter-rouge">controller-manager</code>ì™€ <code class="language-plaintext highlighter-rouge">scheduler</code>ì— access í•„ìš”.</p>

<p>ì˜¤ì§ master nodeì—ë§Œ ë°°í¬, serviceë¡œ ë…¸ì¶œ ì•ˆì‹œí‚¤ë‚˜ ì•„ë˜ 2ê°€ì§€ ë°©ì‹ ê°€ëŠ¥:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">Kubernetes Service</code> ìƒì„±(kube-controller-manager, kube-scheduler) í›„ ì´ ì„œë¹„ìŠ¤ë“¤ë¡œë¶€í„° ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” Metricbeat Deployment ë¡œ ë°°í¬</li>
  <li>Metdicbeat DaemonSetì˜ ê¸°ëŠ¥ ì¤‘ í•˜ë‚˜ì¸ <code class="language-plaintext highlighter-rouge">Autodiscovery</code>ë¥¼ ì‚¬ìš© -&gt; ??</li>
</ul>

<h4 id="kubernetes-rbac">Kubernetes RBAC</h4>
<p>Metricbeatì€ metric ì •ë³´ë“¤ì„ ê°€ì ¸ì˜¤ê¸° ìœ„í•´ ê¶Œí•œ í•„ìš”í•  ìˆ˜ ìˆìŒ.</p>

<h4 id="kubernetes-module-í˜¸í™˜ì„±">Kubernetes module í˜¸í™˜ì„±</h4>
<p>Kubernetes 1.13.x, 1.14.x, 1.15.x, 1.16.x, 1.17.x, and 1.18.x</p>
<ul>
  <li>KT ì œê³µ OKD 3.11 ì€ k8s 1.8 ê¸°ë°˜ì´ê¸° ë•Œë¬¸ì— ì ìš© ë¶ˆê°€ëŠ¥ í• ìˆ˜ë„â€¦</li>
</ul>

<h4 id="dashboard">Dashboard</h4>
<p>kubernetes moduleì€ <code class="language-plaintext highlighter-rouge">apiserver</code>, <code class="language-plaintext highlighter-rouge">controllermanager</code>, <code class="language-plaintext highlighter-rouge">shceduler</code>, <code class="language-plaintext highlighter-rouge">proxy</code>ë¥¼ ìœ„í•œ ê¸°ë³¸ dashboardë¥¼ í¬í•¨.</p>

<p>HA ì ìš© ì‹œ ë³´í†µ í‰ê·  ê°’ì„ ë³´ì—¬ì£¼ê¸° ë•œëˆ„ì— ì£¼ì˜ í•„ìš”.</p>
<ul>
  <li>hosts ë˜ëŠ” service addressë¡œ í•„í„°ë§ ì²˜ë¦¬</li>
</ul>

<p><code class="language-plaintext highlighter-rouge">controllermanager</code>, <code class="language-plaintext highlighter-rouge">shceduler</code>, <code class="language-plaintext highlighter-rouge">proxy</code> dashbaordëŠ” kibana 7.2.0 í•˜ìœ„ ë²„ì „ê³¼ í˜¸í™˜ì„± ì—†ìŒ.</p>

<h4 id="metricsets">Metricsets</h4>
<p>ì‚¬ìš© ê°€ëŠ¥í•œ Metricsetë“¤ ë¦¬ìŠ¤íŠ¸</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    apiserver
    container
    controllermanager
    event
    node
    pod
    proxy
    scheduler
    state_container
    state_cronjob
    state_daemonset
    state_deployment
    state_node
    state_persistentvolumeclaim
    state_pod
    state_replicaset
    state_resourcequota
    state_service
    state_statefulset
    state_storageclass
    system
    volume
</code></pre></div></div>

<hr />

<h2 id="reference">Reference</h2>

<ol>
  <li>
    <p><a href="https://www.elastic.co/guide/en/beats/metricbeat/current/running-on-kubernetes.html">Run Metricbeat on Kubernetes</a></p>
  </li>
  <li>
    <p><a href="https://www.elastic.co/kr/blog/kubernetes-observability-tutorial-k8s-metrics-collection-and-analysis">Kubernetes í†µí•© ê°€ì‹œì„± ììŠµì„œ: ë©”íŠ¸ë¦­ ìˆ˜ì§‘ ë° ë¶„ì„</a></p>
  </li>
</ol>
:ET