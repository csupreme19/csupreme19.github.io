I"8<h1 id="postgresql-pg_ctl-vs-pg_ctlcluster">PostgreSQL pg_ctl vs pg_ctlcluster</h1>

<p><img src="/assets/img/titles/postgresql-logo.svg" alt="postgresql-logo.svg" /></p>

<p>Postgres 셧다운 모드에 대하여 알아보고 모드를 바꿔본다.</p>

<hr />
<h2 id="pg_ctl-vs-pg_ctlcluster">pg_ctl vs pg_ctlcluster</h2>

<p><a href="https://www.postgresql.org/docs/11/app-pg-ctl.html">https://www.postgresql.org/docs/11/app-pg-ctl.html</a></p>

<p>Ubuntu, Debian과 같은 일부 linux에서는 <code class="language-plaintext highlighter-rouge">pg_ctl</code> 대신 <code class="language-plaintext highlighter-rouge">pg_ctlcluster</code> 명령어를 제공한다.</p>

<p>위 명령어를 사용하려면 <code class="language-plaintext highlighter-rouge">pg_cluster</code>를 따로 구성 후에 실행하여야 한다.</p>

<p>클러스터가 구성되어 있는지 확인하려면 아래 명령어 실행</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>/usr/bin/pg_lsclusters
Ver Cluster Port Status Owner    Data directory              Log file
11  main    5432 online postgres /data                       /var/log/postgresql/postgresql-11-main.log
13  main    5433 down   postgres /var/lib/postgresql/13/main /var/log/postgresql/postgresql-13-main.log
</code></pre></div></div>

<blockquote>
  <p><code class="language-plaintext highlighter-rouge">pg_ctlcluster</code>를 강제로 사용하도록 하는 이유는 서로 다른 postgres를 동시에 사용하고 있는 경우가 존재하기 때문</p>
</blockquote>

<h3 id="서비스-형태로의-사용">서비스 형태로의 사용</h3>

<p>보통 deb와 같은 패키지 매니저를 이용하여 설치한 경우 <code class="language-plaintext highlighter-rouge">pg_ctl</code>, <code class="language-plaintext highlighter-rouge">pg_ctlcluster</code> 명령어 대신</p>

<p>kernel의 systemd에 의해 관리되는 service의 형태로 실행된다.</p>

<blockquote>
  <p>systemctl 명령어를 사용하여 실행하여도 내부적으로 <code class="language-plaintext highlighter-rouge">pg_ctlcluster</code> 호출</p>
</blockquote>

<p><strong>명령어</strong></p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 클러스터 구성되어 있는 경우에는 버전 명시</span>
<span class="c"># ex) $ systemctl status postgresql@11-main.service</span>
<span class="nv">$ </span>systemctl <span class="o">[</span>start|stop|restart|status|cat] <span class="o">[</span>service]
<span class="nv">$ </span>systemctl start postgresql@11-main.service	<span class="c"># 구동</span>
<span class="nv">$ </span>systemctl stop postgresql@11-main.service		<span class="c"># 중지</span>
<span class="nv">$ </span>systemctl restart postgresql@11-main.service	<span class="c"># 재기동</span>
<span class="nv">$ </span>systemctl status postgresql@11-main.service	<span class="c"># 서비스 상태</span>
<span class="nv">$ </span>systemctl <span class="nb">cat </span>postgresql@11-main.service		<span class="c"># 서비스 정의</span>
</code></pre></div></div>

<p>아래의 명령어를 수행하여 현재 구성되어 있는 postgresql 서비스 정보 확인</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># 클러스터 구성되어 있는 경우에는 버전 명시
$ systemctl cat postgresql.service
$ systemctl cat postgresql@11-main.service
...
[Service]
Type=forking
# -: ignore startup failure (recovery might take arbitrarily long)
# the actual pg_ctl timeout is configured in pg_ctl.conf
ExecStart=-/usr/bin/pg_ctlcluster --skip-systemctl-redirect %i start
...
</code></pre></div></div>

<p>내부적으로 <code class="language-plaintext highlighter-rouge">pg_ctlcluster</code> 명령어 호출하도록 설정되어 있음을 확인할 수 있다.</p>

<hr />

<h2 id="reference">Reference</h2>

<ol>
  <li><a href="https://www.postgresql.org/docs/11/server-shutdown.html">Shutting Down the server</a>https://stackoverflow.com/a/48576319)</li>
</ol>
:ET