I"Ø]<h1 id="gitlab-ë°±ì—…-ë°-ê¸°íƒ€-ì„¤ì •">GitLab ë°±ì—… ë° ê¸°íƒ€ ì„¤ì •</h1>

<p><img src="/assets/img/titles/gitlab-horizontal-color.png" alt="gitlab-horizontal-color.png" /></p>

<p><a href="https://docs.gitlab.com/omnibus/settings/README.html">Configuring Omnibus GitLab</a></p>

<p>GitLab ë°±ì—…, SSH, ë©”ì¼ ì„œë²„ ë“± ì„¤ì •</p>

<hr />
<h2 id="backup-ì„¤ì •">Backup ì„¤ì •</h2>
<h3 id="backup-í”Œëœ">Backup í”Œëœ</h3>

<ul>
  <li>ë°±ì—… ì£¼ê¸°: 3ì¼</li>
  <li>ë°±ì—… ë²”ìœ„(ê¸°ë³¸ê°’)
    <ul>
      <li><code class="language-plaintext highlighter-rouge">db</code> (database)</li>
      <li><code class="language-plaintext highlighter-rouge">uploads</code> (attachments)</li>
      <li><code class="language-plaintext highlighter-rouge">builds</code> (CI job output logs)</li>
      <li><code class="language-plaintext highlighter-rouge">artifacts</code> (CI job artifacts)</li>
      <li><code class="language-plaintext highlighter-rouge">lfs</code> (LFS objects)</li>
      <li><code class="language-plaintext highlighter-rouge">registry</code> (Container Registry images)</li>
      <li><code class="language-plaintext highlighter-rouge">pages</code> (Pages content)</li>
      <li><code class="language-plaintext highlighter-rouge">repositories</code> (Git repositories data)</li>
    </ul>
  </li>
  <li>ë°±ì—… ìœ„ì¹˜: GitLab ë¡œì»¬, nasì˜ nfs</li>
  <li>ë°±ì—… ì‹¤í–‰: 3ì¼ë§ˆë‹¤ ìƒˆë²½ 2ì‹œ</li>
  <li>ë³´ê´€ ì£¼ê¸°: 30ì¼</li>
</ul>

<blockquote>
  <p><code class="language-plaintext highlighter-rouge">gitlab.rb</code>, <code class="language-plaintext highlighter-rouge">gitlab-secrets.json</code>ê³¼ ê°™ì€ ì„¤ì •íŒŒì¼ë“¤ì€ ê¸°ë³¸ì ìœ¼ë¡œ ë°±ì—…ë˜ì§€ ì•Šìœ¼ë©° í•„ìš”ì‹œ ë³„ë„ë¡œ ë°±ì—… ì‹¤í–‰</p>
</blockquote>

<h3 id="ìˆ˜ë™-backup">ìˆ˜ë™ Backup</h3>

<h4 id="1-ë°±ì—…-ì‹¤í–‰">1. ë°±ì—… ì‹¤í–‰</h4>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> gitlab-ce bash <span class="c"># -t: ì‹¤í–‰ ì‰˜ í™•ì¸ ìš©ë„</span>
<span class="nv">$ </span>gitlab-backup create

<span class="c"># 12.1 ì´í•˜ ë²„ì „ì¸ ê²½ìš°</span>
<span class="nv">$ </span>gitlab-rake gitlab:backup:create
</code></pre></div></div>

<h4 id="2-ë°±ì—…-íŒŒì¼-í™•ì¸">2. ë°±ì—… íŒŒì¼ í™•ì¸</h4>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># cd {docker_volume}/gitlab/data/backups</span>
<span class="nv">$ </span><span class="nb">cd</span> /data/docker_volumes/gitlab/data/backups
</code></pre></div></div>

<p>[TIMESTAMP]_gitlab_backup.tar ìƒì„± í™•ì¸</p>

<h4 id="3-ì„¤ì •-íŒŒì¼-ë°±ì—…ì‹œ">3. ì„¤ì • íŒŒì¼ ë°±ì—…ì‹œ</h4>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/data/docker_volumes/gitlab/config/gitlab-secrets.json
/data/docker_volumes/gitlab/config/gitlab.rb
</code></pre></div></div>

<p>ìœ„ ë‘ íŒŒì¼ ë³„ë„ë¡œ ë°±ì—…í•  ê²ƒ</p>

<h3 id="ìˆ˜ë™-restore">ìˆ˜ë™ Restore</h3>

<h4 id="1-ë³µêµ¬-ì¤€ë¹„">1. ë³µêµ¬ ì¤€ë¹„</h4>

<ol>
  <li>
    <h5 id="ë³µêµ¬ëœ-ë²„ì „ê³¼-ë³µêµ¬í•˜ë ¤ëŠ”-gitlab-ë²„ì „ì´-ê°™ì•„ì•¼í•¨">ë³µêµ¬ëœ ë²„ì „ê³¼ ë³µêµ¬í•˜ë ¤ëŠ” gitlab ë²„ì „ì´ ê°™ì•„ì•¼í•¨</h5>
  </li>
  <li>
    <h5 id="gitlab-reconfigure-ì‹¤í–‰-í•„ìš”">gitlab reconfigure ì‹¤í–‰ í•„ìš”</h5>
  </li>
  <li>
    <h5 id="gitlabì´-ì‹¤í–‰ë˜ê³ -ìˆì–´ì•¼í•¨">gitlabì´ ì‹¤í–‰ë˜ê³  ìˆì–´ì•¼í•¨</h5>
  </li>
  <li>
    <h5 id="ë³µêµ¬í• -íŒŒì¼tar-ìœ„ì¹˜ëŠ”-varoptgitlabbackups-ì—-ìˆë‹¤ê³ -ê°€ì •">ë³µêµ¬í•  íŒŒì¼(.tar) ìœ„ì¹˜ëŠ” /var/opt/gitlab/backups ì— ìˆë‹¤ê³  ê°€ì •</h5>
  </li>
</ol>

<p>DB ì ‘ê·¼í•˜ëŠ” í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># gitlab shell ì§„ì…</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> gitlab-ce bash

<span class="c"># process ì •ì§€ ì²˜ë¦¬</span>
<span class="nv">$ </span>gitlab-ctl stop unicorn
<span class="nv">$ </span>gitlab-ctl stop puma
<span class="nv">$ </span>gitlab-ctl stop sidekiq

<span class="c"># ì¢…ë£Œ í™•ì¸</span>
<span class="nv">$ </span>gitlab-ctl status 
</code></pre></div></div>

<h4 id="2-ë³µêµ¬-ì‹¤í–‰">2. ë³µêµ¬ ì‹¤í–‰</h4>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">chmod </span>0644 1612940314_2021_092_10_13.8.1_gitlab_backup.tar	<span class="c"># ëª¨ë“  ì‚¬ìš©ì ì½ê¸° ê¶Œí•œ ì¶”ê°€</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-t</span> gitlab-ce gitlab-backup restore <span class="nv">BACKUP</span><span class="o">={</span>TIMESTAMP<span class="o">}</span> <span class="nv">force</span><span class="o">=</span><span class="nb">yes</span>

<span class="c"># 12.1 ì´í•˜ ë²„ì „ì¸ ê²½ìš°</span>
<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-t</span> gitlab-ce gitlab-rake gitlab:backup:restore <span class="nv">BACKUP</span><span class="o">={</span>TIMESTAMP<span class="o">}</span> <span class="nv">force</span><span class="o">=</span><span class="nb">yes</span>
</code></pre></div></div>

<p>ì˜ˆë¥¼ ë“¤ì–´ íŒŒì¼ëª…ì´ 1612940314_2021_092_10_13.8.1_gitlab_backup.tarì´ë¼ë©´</p>

<p>[TIMESTAMP]_gitlab_backup.tar ì´ë¯€ë¡œ TIMESTAMPëŠ” 1612940314_2021_092_10_13.8.1</p>

<p>ë³µêµ¬ ì‹œì ì— psql must be owner of ê´€ë ¨ ì˜¤ë¥˜ëŠ” ì •ìƒì„</p>

<h4 id="3-ì„œë¹„ìŠ¤-ì¬êµ¬ë™-ë°-ì ê²€">3. ì„œë¹„ìŠ¤ ì¬êµ¬ë™ ë° ì ê²€</h4>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> gitlab-ce bash
<span class="nv">$ </span>gitlab-ctl reconfigure
<span class="nv">$ </span>gitlab-ctl restart

<span class="nv">$ </span>gitlab-rake gitlab:check <span class="nv">SANITIZE</span><span class="o">=</span><span class="nb">true</span>
</code></pre></div></div>

<h3 id="ìë™-backup-ì„¤ì •">ìë™ Backup ì„¤ì •</h3>

<h4 id="1-nfs-ì„¤ì •">1. NFS ì„¤ì •</h4>

<p>mount ë° ê¶Œí•œ ì„¤ì •ì€ ì™„ë£Œë˜ì—ˆë‹¤ëŠ” ê°€ì •í•˜ì— ì‘ì„±í•˜ì˜€ìŠµë‹ˆë‹¤.</p>

<p>GitLab ë°±ì—… í´ë” ìƒì„±</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># mkdir -p {nfs ë³¼ë¥¨ ê²½ë¡œ}/gitlab/data/backups</span>
<span class="nv">$ </span><span class="nb">mkdir</span> <span class="nt">-p</span> /nfs_nas/volumes/gitlab/data/backups
</code></pre></div></div>

<h4 id="2-docker-compose-ì„¤ì •">2. docker compose ì„¤ì •</h4>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># docker_compose yaml ì„¤ì • íŒŒì¼</span>
<span class="nv">$ </span>vim ~/gitlab-ce/docker-compose.yml
</code></pre></div></div>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">...</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="na">GITLAB_OMNIBUS_CONFIG</span><span class="pi">:</span> <span class="pi">|</span>
        <span class="s">gitlab_rails['backup_keep_time'] = 2592000</span>
<span class="s">...</span>
</code></pre></div></div>

<p>gitlab_rails ì„¤ì •ê°’ ë³€ê²½(ì¶”ê°€)</p>

<ul>
  <li>backup_path: ë°±ì—… ê²½ë¡œ(local)</li>
  <li>backup_keep_time: ë°±ì—… íŒŒì¼ ë³´ê´€ ì£¼ê¸° (2592000ì´ˆ = 30ì¼)</li>
</ul>

<p>gitlabì´ ì„¤ì¹˜ëœ volumeì˜  gitlab.rb ì„¤ì •íŒŒì¼ ìˆ˜ì •í•´ë„ ë¨</p>

<h4 id="3-ë°±ì—…-ìŠ¤í¬ë¦½íŠ¸-ì‘ì„±">3. ë°±ì—… ìŠ¤í¬ë¦½íŠ¸ ì‘ì„±</h4>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>vim ~/gitlab-ce/gitlab_backup.sh
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="c">#!/bin/sh</span>
 <span class="nv">BACKUP_DIR</span><span class="o">=</span><span class="s1">'/data/docker_volumes/gitlab/data/backups'</span>
 <span class="nv">BACKUP_REMOTE_DIR</span><span class="o">=</span><span class="s1">'/nfs_nas1/volumes/gitlab/data/backups'</span>
 <span class="nv">BACKUP_REMOTE_DIR2</span><span class="o">=</span><span class="s1">'/nfs_nas2/backups/gitlab'</span>
 <span class="nv">BACKUP_LIFETIME</span><span class="o">=</span>30
 docker <span class="nb">exec </span>gitlab-ce gitlab-backup create <span class="nv">CRON</span><span class="o">=</span>1
 <span class="nv">BACKUP_FILE</span><span class="o">=</span><span class="sb">`</span><span class="nb">ls</span> <span class="nt">-t</span> <span class="nv">$BACKUP_DIR</span> | <span class="nb">head</span> <span class="nt">-n</span> 1<span class="sb">`</span>
 <span class="nb">echo</span> <span class="s2">"gitlab-backup create::: </span><span class="nv">$BACKUP_DIR</span><span class="s2">/</span><span class="nv">$BACKUP_FILE</span><span class="s2"> "</span>

 <span class="nv">BACKUP_REMOVE_FILES</span><span class="o">=</span><span class="sb">`</span>find <span class="nv">$BACKUP_DIR</span> <span class="nt">-name</span> <span class="s2">"*_gitlab_backup.tar"</span> <span class="nt">-mtime</span> +<span class="nv">$BACKUP_LIFETIME</span> <span class="nt">-type</span> f<span class="sb">`</span>
 <span class="k">if</span> <span class="o">[</span> <span class="nt">-n</span> <span class="s2">"</span><span class="nv">$BACKUP_REMOVE_FILES</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
 </span><span class="nb">echo</span> <span class="s2">"gitlab-backup remove old backups::: </span><span class="nv">$BACKUP_REMOVE_FILES</span><span class="s2">"</span>
 <span class="nb">rm</span> <span class="nt">-rf</span> <span class="nv">$BACKUP_REMOVE_FILES</span>
 <span class="k">fi

 </span><span class="nv">BACKUP_REMOTE_REMOVE_FILES</span><span class="o">=</span><span class="sb">`</span>find <span class="nv">$BACKUP_REMOTE_DIR</span> <span class="nt">-name</span> <span class="s2">"*_gitlab_backup.tar"</span> <span class="nt">-mtime</span> +<span class="nv">$BACKUP_LIFETIME</span> <span class="nt">-type</span> f<span class="sb">`</span>
 <span class="k">if</span> <span class="o">[</span> <span class="nt">-n</span> <span class="s2">"</span><span class="nv">$BACKUP_REMOTE_REMOVE_FILES</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
 </span><span class="nb">echo</span> <span class="s2">"gitlab-backup remove old backups::: </span><span class="nv">$BACKUP_REMOTE_REMOVE_FILES</span><span class="s2">"</span>
 <span class="nb">rm</span> <span class="nt">-rf</span> <span class="nv">$BACKUP_REMOTE_REMOVE_FILES</span>
 <span class="k">fi

 </span><span class="nv">BACKUP_REMOTE_REMOVE_FILES2</span><span class="o">=</span><span class="sb">`</span>find <span class="nv">$BACKUP_REMOTE_DIR2</span> <span class="nt">-name</span> <span class="s2">"*_gitlab_backup.tar"</span> <span class="nt">-mtime</span> +<span class="nv">$BACKUP_LIFETIME</span> <span class="nt">-type</span> f<span class="sb">`</span>
 <span class="k">if</span> <span class="o">[</span> <span class="nt">-n</span> <span class="s2">"</span><span class="nv">$BACKUP_REMOTE_REMOVE_FILES2</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
 </span><span class="nb">echo</span> <span class="s2">"gitlab-backup remove old backups::: </span><span class="nv">$BACKUP_RETMOE_REMOVE_FILES2</span><span class="s2">"</span>
 <span class="nb">rm</span> <span class="nt">-rf</span> <span class="nv">$BACKUP_REMOTE_REMOVE_FILES2</span>
 <span class="k">fi

 </span><span class="nb">cp</span> <span class="nv">$BACKUP_DIR</span>/<span class="nv">$BACKUP_FILE</span> <span class="nv">$BACKUP_REMOTE_DIR</span>
 <span class="nb">echo</span> <span class="s2">"gitlab-backup copy to storage::: </span><span class="nv">$BACKUP_REMOTE_DIR</span><span class="s2">/</span><span class="nv">$BACKUP_FILE</span><span class="s2"> </span><span class="nv">$BACKUP_REMOTE_DIR</span><span class="s2">/</span><span class="nv">$BACKUP_FILE</span><span class="s2">"</span>
 <span class="nb">cp</span> <span class="nv">$BACKUP_DIR</span>/<span class="nv">$BACKUP_FILE</span> <span class="nv">$BACKUP_REMOTE_DIR2</span>
 <span class="nb">echo</span> <span class="s2">"gitlab-backup copy to storage::: </span><span class="nv">$BACKUP_REMOTE_DIR2</span><span class="s2">/</span><span class="nv">$BACKUP_FILE</span><span class="s2"> </span><span class="nv">$BACKUP_REMOTE_DIR2</span><span class="s2">/</span><span class="nv">$BACKUP_FILE</span><span class="s2">"</span>
 <span class="nb">echo</span> <span class="s2">"gitlab-backup done."</span>
</code></pre></div></div>

<blockquote>
  <p>ìœ„ ìŠ¤í¬ë¦½íŠ¸ëŠ” ë°±ì—… ëª…ë ¹ ì‹¤í–‰ í›„ ë°±ì—… íŒŒì¼ì„ mv, rm í•˜ëŠ” ê°„ë‹¨í•œ ìŠ¤í¬ë¦½íŠ¸ì´ë©° ìƒí™©ë³„ë¡œ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ</p>
</blockquote>

<h4 id="4-ë°±ì—…-cron-ë“±ë¡">4. ë°±ì—… cron ë“±ë¡</h4>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>crontab <span class="nt">-e</span>
0 2 <span class="k">*</span>/3 <span class="k">*</span> <span class="k">*</span> /root/gitlab-ce/gitlab_backup.sh <span class="o">&gt;</span> /root/gitlab-ce/gitlab_backup.sh.log
</code></pre></div></div>

<p>gitlab ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì—ì„œ crontab ì„¤ì •ë„ ê°€ëŠ¥</p>

<ul>
  <li>CRON=1: ì—ëŸ¬ê°€ ë°œìƒí•œ ê²½ìš°ì—ë§Œ ì¶œë ¥</li>
</ul>

<h4 id="5-cron-í…ŒìŠ¤íŠ¸">5. cron í…ŒìŠ¤íŠ¸</h4>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>run-parts /var/spool/cron <span class="nt">-v</span>
</code></pre></div></div>

<hr />
<h2 id="email-ì„¤ì •smtp">Email ì„¤ì •(SMTP)</h2>

<blockquote>
  <p>docker container í™˜ê²½ì—ì„œ gitlabì˜ email ì„¤ì •</p>
</blockquote>

<h3 id="ì‚¬ì „-ì¤€ë¹„-ì‚¬í•­">ì‚¬ì „ ì¤€ë¹„ ì‚¬í•­</h3>
<ul>
  <li>mail server ì •ë³´ í™•ì¸: gmail ë˜ëŠ” ë³„ë„ ë¬´ë£Œ ì‚¬ìš© ê°€ëŠ¥í•œ mail server í™•ë³´</li>
  <li>ë³¸ ë¬¸ì„œì—ì„œëŠ” mailgun ì„œë²„ë¥¼ ì ìš©</li>
</ul>

<h4 id="ì°¸ì¡°-site">ì°¸ì¡° site</h4>
<ul>
  <li><a href="https://docs.gitlab.com/omnibus/settings/smtp.html#mailgun">SMTP Settings#Mailgun</a></li>
</ul>

<h4 id="ì„¤ì •ë²•">ì„¤ì •ë²•</h4>

<h3 id="gitlabì˜-ì„¤ì •íŒŒì¼-ìˆ˜ì •">gitlabì˜ ì„¤ì •íŒŒì¼ ìˆ˜ì •</h3>
<ul>
  <li>docker-compose.ymlì˜ gitlab environmentì— ì¶”ê°€ ë˜ëŠ”</li>
  <li>gitlab ì„¤ì¹˜ëœ volumeì—ì„œ gitlab.rb íŒŒì¼ ì°¾ì•„ ìˆ˜ì •</li>
  <li>í•´ë‹¹ íŒŒì¼ ë‚´ìš© ì¤‘ mailgun ë©”ì¼ì„œë²„ ì •ë³´ë¥¼ ì¶”ê°€
    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># mailgun smtp ì„¤ì •</span>
gitlab_rails[<span class="s1">'smtp_enable'</span><span class="o">]</span> <span class="o">=</span> <span class="nb">true
</span>gitlab_rails[<span class="s1">'smtp_address'</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"smtp.mailgun.org"</span>
gitlab_rails[<span class="s1">'smtp_port'</span><span class="o">]</span> <span class="o">=</span> 587
gitlab_rails[<span class="s1">'smtp_authentication'</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"plain"</span>
gitlab_rails[<span class="s1">'smtp_enable_starttls_auto'</span><span class="o">]</span> <span class="o">=</span> <span class="nb">true
</span>gitlab_rails[<span class="s1">'smtp_user_name'</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"mailì„œë²„ ë°œê¸‰ë°›ì€ id"</span>
gitlab_rails[<span class="s1">'smtp_password'</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"ì•”í˜¸"</span>
gitlab_rails[<span class="s1">'smtp_domain'</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"mg.gitlab.com"</span>
</code></pre></div>    </div>
  </li>
  <li>docker container ì¬ê¸°ë™</li>
  <li>mail ë³´ë‚´ê¸° í…ŒìŠ¤íŠ¸
    <ul>
      <li>gitlabì˜ shellë¡œ ì§„ì…</li>
    </ul>
  </li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> &lt;container <span class="nb">id</span><span class="o">&gt;</span> bash
</code></pre></div></div>
<ul>
  <li>gitlab-rails console ì‹¤í–‰
    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>gitlab-rails console
</code></pre></div>    </div>
  </li>
  <li>gitlab-rails console ìƒì—ì„œ mail ë³´ë‚´ê¸° í…ŒìŠ¤íŠ¸
    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>Notify.test_email<span class="o">(</span><span class="s1">'&lt;ë°›ëŠ” email address&gt;'</span>, <span class="s1">'&lt;email ì œëª©&gt;'</span>, <span class="s1">'&lt;email ë‚´ìš©&gt;'</span><span class="o">)</span>.deliver_now
</code></pre></div>    </div>
  </li>
  <li>emailì´ ì™”ëŠ”ì§€ í™•ì¸</li>
</ul>

<hr />
<h3 id="ssh-key-ì„¤ì •">SSH Key ì„¤ì •</h3>

<ol>
  <li>
    <p>ì ‘ì†í•˜ê³ ì í•˜ëŠ” ì‚¬ìš©ìì—ì„œ SSH Key ë°œê¸‰</p>

    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh-keygen <span class="nt">-t</span> rsa
</code></pre></div>    </div>

    <p>RSA í‚¤ ë°œê¸‰, passphraseëŠ” ì¼ë°˜ì ìœ¼ë¡œ ë¹„ì›Œë‘ (Enter)</p>
  </li>
  <li>
    <p>ë°œê¸‰ëœ Public key í™•ì¸</p>

    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">chmod </span>755 ~/.ssh/id_rsa.pub
vi ~/.ssh/id_rsa.pub
</code></pre></div>    </div>

    <p>id_rsa.pubì•ˆì˜ í¼ë¸”ë¦­í‚¤ ë³µì‚¬í•´ë‘ê¸°</p>
  </li>
  <li>
    <p>GitLab ê³„ì •ì— public key ë“±ë¡</p>

    <p><a href="https://bookstack.ccpinfra.xyz:23443/uploads/images/gallery/2021-02/osOgitlab1.png"><img src="https://bookstack.ccpinfra.xyz:23443/uploads/images/gallery/2021-02/scaled-1680-/osOgitlab1.png" alt="gitlab_setting1.png" /></a></p>

    <p>User Settings - SSH Keys</p>

    <p>id_rsa.pubì— ìˆëŠ” ì „ì²´ í‚¤ ë‚´ìš© ë³µì‚¬í•˜ì—¬ ë¶™ì—¬ë„£ê¸°</p>

    <p>Titleì€ ìì‹ ì´ êµ¬ë¶„í•   ìˆ˜ ìˆëŠ” ì œëª© ì•„ë¬´ê±°ë‚˜</p>

    <p>ë§Œë£Œì¼ì€ í•´ë‹¹ í‚¤ì˜ ë§Œë£Œì¼ë¡œ ì„¤ì •</p>
  </li>
  <li>
    <p>git ê³„ì • ì„¤ì •</p>

    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git config <span class="nt">--global</span> user.name <span class="s2">"{USERNAME}"</span>
git config <span class="nt">--global</span> user.email <span class="o">{</span>USER_EMAIL<span class="o">}</span>
</code></pre></div>    </div>

    <p>USERNAME: gitlab ê³„ì •ëª…
USER_EMAIL: gitlab ê³„ì •ì˜ ì´ë©”ì¼ ì£¼ì†Œ</p>
  </li>
  <li>
    <p>SSH ì ‘ì† í™•ì¸</p>

    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ssh -T git@{host} -p {port} -v</span>
<span class="nv">$ </span>ssh <span class="nt">-T</span> git@gitlab.ccpinfra.xyz <span class="nt">-p</span> 20722 <span class="nt">-v</span>
Welcome to GitLab, @csupreme!
</code></pre></div>    </div>

    <p>-p: í¬íŠ¸ ì„¤ì •</p>

    <p>-v: ë””ë²„ê·¸ ë¡œê·¸ í™•ì¸</p>

    <p>ì²˜ìŒ ì ‘ì†ì‹œ í˜¸ìŠ¤íŠ¸ í‚¤ ì €ì¥ ì—¬ë¶€ë¥¼ ë¬¼ìœ¼ë©´ yes</p>
  </li>
  <li>
    <p>Git clone í™•ì¸</p>

    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># git clone ssh://git@{host}:{port}/{repository}.git</span>
git clone ssh://git@gitlab.ccpinfra.xyz:20722/csupreme/commit-test.git
</code></pre></div>    </div>

    <p>ë³„ë„ì˜ ì‚¬ìš©ì, ì•”í˜¸ ì…ë ¥ ì—†ì´ SSH Keyë¥¼ ì´ìš©í•˜ì—¬ clone í™•ì¸</p>
  </li>
</ol>

<hr />
<h3 id="nginx-ssl-ì„¤ì •">nginx SSL ì„¤ì •</h3>
<h4 id="ì„ í–‰ì‚¬í•­">ì„ í–‰ì‚¬í•­</h4>

<ul>
  <li>Docker Container í™˜ê²½(GitLab Omnibus)</li>
  <li>Letâ€™s Encrypt Key ë°œê¸‰ ì™„ë£Œ</li>
</ul>

<ol>
  <li>
    <p>docker_compose.yml ìˆ˜ì •</p>

    <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="na">environment</span><span class="pi">:</span>
      <span class="na">GITLAB_OMNIBUS_CONFIG</span><span class="pi">:</span> <span class="pi">|</span>
        <span class="s">letsencrypt['enable'] = false</span>
        <span class="s">external_url 'https://gitlab.ccpinfra.xyz:20443'</span>
        <span class="s">nginx['redirect_http_to_https'] = true</span>
    <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s1">'</span><span class="s">20780:20443'</span>
        <span class="pi">-</span> <span class="s1">'</span><span class="s">20443:20443'</span>
        <span class="pi">-</span> <span class="s1">'</span><span class="s">20722:22'</span>
</code></pre></div>    </div>

    <p>letsencrypt[â€˜enableâ€™] = falseë¡œ ì„¤ì •í•˜ëŠ” ì´ìœ </p>

    <p>gitlab-ctl reconfigureì‹œ ìë™ìœ¼ë¡œ ì¸ì¦ì„œë¥¼ ê°±ì‹ í•˜ì—¬ ë®ì–´ì“°ê¸° ë•Œë¬¸</p>

    <p>ìˆ˜ë™ìœ¼ë¡œ ë°œê¸‰í•œ ì¸ì¦ì„œì´ë¯€ë¡œ letsencryptì˜ ìë™ ê°±ì‹  ê¸°ëŠ¥ì„ ë¹„í™œì„±í™” í•˜ê¸° ìœ„í•´</p>
  </li>
  <li>
    <p>SSL ì¸ì¦ì„œ ë³µì‚¬</p>

    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ì°¸ê³ ) ì»¨í…Œì´ë„ˆ /etc/gitlabì— ë§ˆìš´íŠ¸ëœ ê²½ë¡œ</span>
<span class="nv">$ </span><span class="nb">sudo mkdir</span> <span class="nt">-p</span> /data/docker_volumes/gitlab/config/ssl
<span class="nv">$ </span><span class="nb">sudo chmod </span>755 /data/docker_volumes/gitlab/config/ssl
<span class="nv">$ </span><span class="nb">cp</span> /etc/letsencrypt/live/ccpinfra.xyz/privkey.pem /data/docker_volumes/gitlab_2/config/ssl
<span class="nv">$ </span><span class="nb">cp</span> /etc/letsencrypt/live/ccpinfra.xyz/fullchain.pem /data/docker_volumes/gitlab_2/config/ssl
</code></pre></div>    </div>
  </li>
  <li>
    <p>PEM ë³€í™˜</p>

    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>openssl rsa <span class="nt">-in</span> privkey.pem <span class="nt">-text</span> <span class="o">&gt;</span> gitlab.ccpinfra.xyz.key
<span class="nv">$ </span>openssl x509 <span class="nt">-inform</span> PEM <span class="nt">-in</span> fullchain.pem <span class="nt">-out</span> gitlab.ccpinfra.xyz.crt
</code></pre></div>    </div>
  </li>
  <li>
    <p>GitLab ì¬ì„¤ì •</p>

    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-t</span> gitlab-ce gitlab-ctl reconfigure
   
<span class="c"># ë„ì»¤ í¬íŠ¸ ë§¤í•‘ì´ ë³€ê²½ëœ ê²½ìš° ì»¨í…Œì´ë„ˆ ì¬ì‹¤í–‰ í•„ìš”</span>
<span class="nv">$ </span>docker-compose down
<span class="nv">$ </span>docker-compose up <span class="nt">-d</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Https ì ‘ì† í™•ì¸ ë° ì¸ì¦ì„œ í™•ì¸</p>

    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat</span> /data/docker_volumes/gitlab/logs/nginx/gitlab_access.log
</code></pre></div>    </div>
    <p><a href="https://bookstack.ccpinfra.xyz:23443/uploads/images/gallery/2021-02/gitlab-setting2.png"><img src="https://bookstack.ccpinfra.xyz:23443/uploads/images/gallery/2021-02/scaled-1680-/gitlab-setting2.png" alt="gitlab_setting2.png" /></a></p>
  </li>
</ol>

<hr />

<h2 id="reference">Reference</h2>

<ol>
  <li><a href="https://docs.gitlab.com/omnibus/settings/README.html">Configuring Omnibus GitLab</a></li>
  <li><a href="https://docs.gitlab.com/omnibus/settings/smtp.html#mailgun">SMTP Settings#Mailgun</a></li>
  <li><a href="https://kubernetes.io/docs/reference/access-authn-authz/node/">Using ABAC Authorization</a></li>
  <li><a href="https://www.udemy.com/course/certified-kubernetes-administrator-with-practice-tests/">Certified Kubernetes Administrator(CKA) with Practice Tests</a></li>
</ol>
:ET