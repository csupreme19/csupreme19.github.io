I"Æ6<h1 id="ì‹œìŠ¤í…œ-graceful-shutdown">ì‹œìŠ¤í…œ Graceful shutdown</h1>

<p><img src="/assets/img/titles/ubuntu-logo.svg" alt="postgresql-logo.svg" /></p>

<p>PostgreSQL max_connections ì„¤ì • ë°©ë²•(Ubuntu ê¸°ì¤€ìœ¼ë¡œ ì‘ì„±)</p>

<hr />
<h2 id="ì‹œìŠ¤í…œ-ì¬ë¶€íŒ…-ë°©ë²•">ì‹œìŠ¤í…œ ì¬ë¶€íŒ… ë°©ë²•</h2>

<p>ì‹œìŠ¤í…œì„ ì¥ì•  ì—†ì´ Graceful í•˜ê²Œ shutdowní•˜ëŠ” ë°©ë²•ì„ ë‹¤ë£¬ë‹¤.</p>

<hr />

<h2 id="ì„œë²„ë³„-ì¬ë¶€íŒ…">ì„œë²„ë³„ ì¬ë¶€íŒ…</h2>

<h3 id="kubernetes-ì„œë²„">Kubernetes ì„œë²„</h3>
<p>Gracefully shutdown kubernetes nodes</p>

<blockquote>
  <p><a href="https://stackoverflow.com/a/59576322/15263734">https://stackoverflow.com/a/59576322/15263734</a></p>
</blockquote>

<h4 id="1-ë…¸ë“œ-drain">1. ë…¸ë“œ drain</h4>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl drain <span class="nv">$NODENAME</span> <span class="nt">--ignore-daemonsets</span><span class="o">=</span><span class="nb">true</span>

<span class="c"># local storage ë•Œë¬¸ì— ì§€ìš¸ ìˆ˜ ì—†ëŠ” ê²½ìš°</span>
<span class="nv">$ </span>kubectl drain <span class="nv">$NODENAME</span> <span class="nt">--ignore-daemonsets</span><span class="o">=</span><span class="nb">true</span> <span class="nt">--delete-emptydir-data</span>
</code></pre></div></div>
<p>í•´ë‹¹ ë…¸ë“œì—ì„œ ì‹¤í–‰ë˜ëŠ” íŒŒë“œë¥¼ ëª¨ë‘ ì œê±°í•˜ê³  í•´ë‹¹ ë…¸ë“œì˜ íŒŒë“œ ìŠ¤ì¼€ì¤„ë§ì„ ë¹„í™œì„±í™”í•œë‹¤.</p>
<blockquote>
  <p>Replicaê°€ 1ê°œì¸ Deploymentë“¤ì€ ë‹¤ìš´íƒ€ì„ ë°œìƒí•  ìˆ˜ ìˆìŒ</p>
</blockquote>

<h4 id="2-ë…¸ë“œ-drain-í™•ì¸">2. ë…¸ë“œ drain í™•ì¸</h4>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl get nodes <span class="nv">$NODENAME</span>
NAME               STATUS   					ROLES                  AGE    VERSION
<span class="nv">$NODENAME</span>          Ready SchedulingDisabled     control-plane,master   118d   v1.20.6
<span class="nv">$ </span>kubectl get pod <span class="nt">-A</span> <span class="nt">-o</span> wide | <span class="nb">grep</span> <span class="nv">$NODENAME</span>
argocd                 argocd-application-controller-0                  1/1     Succeeded   1          92d     10.244.2.96     <span class="nv">$NODENAME</span>    &lt;none&gt;           &lt;none&gt;
kube-system            filebeat-2svwt                                   1/1     Succeeded   0          21d     10.222.222.22   <span class="nv">$NODENAME</span>    &lt;none&gt;           &lt;none&gt;
kube-system            kube-flannel-ds-4whmt                            1/1     Succeeded   5          118d    10.222.222.22   <span class="nv">$NODENAME</span>    &lt;none&gt;           &lt;none&gt;
kube-system            kube-proxy-qjsc8                                 1/1     Succeeded   4          118d    10.222.222.22   <span class="nv">$NODENAME</span>    &lt;none&gt;           &lt;none&gt;
kube-system            metricbeat-2ggh2                                 1/1     Succeeded   1          69d     10.222.222.22   <span class="nv">$NODENAME</span>    &lt;none&gt;           &lt;none&gt;
kubernetes-dashboard   kubernetes-dashboard-64b46974f-56h9x             1/1     Succeeded   2          81d     10.244.2.98     <span class="nv">$NODENAME</span>    &lt;none&gt;           &lt;none&gt;
production               yourapp-prd-deploy-57f9947968-zklkq             1/1     Succeeded   0          4d15h   10.244.2.130    <span class="nv">$NODENAME</span>    &lt;none&gt;           &lt;none&gt;
</code></pre></div></div>
<ul>
  <li>ë…¸ë“œ ìƒíƒœ <code class="language-plaintext highlighter-rouge">SchedulingDisabled</code> í™•ì¸</li>
  <li>íŒŒë“œ ìƒíƒœ <code class="language-plaintext highlighter-rouge">Succeeded</code> ì •ìƒì¢…ë£Œ í™•ì¸
    <ul>
      <li>íŒŒë“œ ìƒíƒœê°€ <code class="language-plaintext highlighter-rouge">Terminating</code>ì¸ ê²½ìš° íŒŒë“œê°€ ì¤‘ì§€ë˜ëŠ” ì¤‘ì´ë‹ˆ ëŒ€ê¸°</li>
    </ul>

    <blockquote>
      <p><code class="language-plaintext highlighter-rouge">drain</code> ëª…ë ¹ì–´ëŠ” íŒŒë“œì˜ ì •ìƒ ì¢…ë£Œ(Graceful shutdown)ë¥¼ ë³´ì¥í•œë‹¤</p>
    </blockquote>
  </li>
</ul>

<h4 id="3-ì„œë²„-ì¬ë¶€íŒ…">3. ì„œë²„ ì¬ë¶€íŒ…</h4>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ì•„ë˜ ë‘ ëª…ë ¹ì–´ì¤‘ ì•„ë¬´ê±°ë‚˜ ìˆ˜í–‰</span>
<span class="nv">$ </span>shutdown <span class="nt">-r</span> now
<span class="nv">$ </span>systemctl reboot
</code></pre></div></div>

<h4 id="4-ë…¸ë“œ-íŒŒë“œ-ìŠ¤ì¼€ì¤„ë§-ì¬í™œì„±í™”">4. ë…¸ë“œ íŒŒë“œ ìŠ¤ì¼€ì¤„ë§ ì¬í™œì„±í™”</h4>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl uncordon <span class="nv">$NODENAME</span>
</code></pre></div></div>

<h4 id="5-ë…¸ë“œ-ìƒíƒœ-í™•ì¸">5. ë…¸ë“œ ìƒíƒœ í™•ì¸</h4>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl get nodes <span class="nv">$NODENAME</span>
NAME               STATUS   ROLES                  AGE    VERSION
<span class="nv">$NODENAME</span>          Ready    control-plane,master   118d   v1.20.6
</code></pre></div></div>

<p>ë…¸ë“œ ìƒíƒœ <code class="language-plaintext highlighter-rouge">Ready</code>ë§Œ ìˆëŠ” ê²ƒ í™•ì¸</p>

<blockquote>
  <p>ê¸°ì¡´ ë– ìˆëŠ” Podë“¤ì€ Reschedule ì‹œì ê¹Œì§€ ìƒˆë¡œ ìƒê¸´ Nodeë¡œ ìŠ¤ì¼€ì¤„ ë˜ì§€ ì•ŠìŒ</p>
</blockquote>

<h3 id="rdbms-ì„œë²„-ì¬ë¶€íŒ…">RDBMS ì„œë²„ ì¬ë¶€íŒ…</h3>
<h4 id="1-rdbms-ìºì‹œ-flush">1. RDBMS ìºì‹œ flush</h4>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sync</span><span class="p">;</span><span class="nb">sync</span>
</code></pre></div></div>

<h4 id="2-rdbms-ì„œë¹„ìŠ¤-ì¤‘ì§€">2. rdbms ì„œë¹„ìŠ¤ ì¤‘ì§€</h4>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>systemctl stop postgresql <span class="c"># postgresqlì˜ ê²½ìš°</span>
<span class="nv">$ </span>systemctl stop mysql <span class="c"># mysqlì˜ ê²½ìš°</span>
</code></pre></div></div>

<h4 id="3-ì¬ë¶€íŒ…">3. ì¬ë¶€íŒ…</h4>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ì•„ë˜ ë‘ ëª…ë ¹ì–´ì¤‘ ì•„ë¬´ê±°ë‚˜ ìˆ˜í–‰</span>
<span class="nv">$ </span>shutdown <span class="nt">-r</span> now
<span class="nv">$ </span>systemctl reboot
</code></pre></div></div>

<h4 id="4-ì„œë¹„ìŠ¤-ì •ìƒ-ì‹¤í–‰-í™•ì¸">4. ì„œë¹„ìŠ¤ ì •ìƒ ì‹¤í–‰ í™•ì¸</h4>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>systemctl status postgresql@11-main.service <span class="c"># postgresqlì˜ ê²½ìš°</span>
<span class="nv">$ </span>systemctl status mysql.service <span class="c"># mysqlì˜ ê²½ìš°</span>

<span class="nv">$ </span>systemctl status metricbeat.service <span class="c"># metricbeat</span>
<span class="nv">$ </span>systemctl status filebeat.service <span class="c"># filebeat</span>
</code></pre></div></div>

<p>ì •ìƒ ì‹¤í–‰ ì•ˆë˜ì—ˆì„ì‹œ í•˜ë‹¨ ìˆ˜ë™ êµ¬ë™ ëª…ë ¹ì–´ ì°¸ê³ </p>

<h3 id="ì˜¤í”ˆì†ŒìŠ¤-ì„œë²„-ì¬ë¶€íŒ…">ì˜¤í”ˆì†ŒìŠ¤ ì„œë²„ ì¬ë¶€íŒ…</h3>
<h4 id="1-ì¬ë¶€íŒ…">1. ì¬ë¶€íŒ…</h4>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ì•„ë˜ ë‘ ëª…ë ¹ì–´ì¤‘ ì•„ë¬´ê±°ë‚˜ ìˆ˜í–‰</span>
<span class="nv">$ </span>shutdown <span class="nt">-r</span> now
<span class="nv">$ </span>systemctl reboot
</code></pre></div></div>

<h4 id="2-ì„œë¹„ìŠ¤-ì •ìƒ-ì‹¤í–‰-í™•ì¸">2. ì„œë¹„ìŠ¤ ì •ìƒ ì‹¤í–‰ í™•ì¸</h4>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ê° ì„œë²„ì˜ ì˜¤í”ˆì†ŒìŠ¤ì— í•´ë‹¹ë˜ëŠ” ì„œë¹„ìŠ¤ ì ê²€</span>
<span class="nv">$ </span>systemctl status mongos.service <span class="c"># mongos</span>
<span class="nv">$ </span>systemctl status mongod.service <span class="c"># mongod</span>
<span class="nv">$ </span>systemctl status zookeeper.service <span class="c"># zookeeper</span>
<span class="nv">$ </span>systemctl status kafka.service <span class="c"># kafka</span>
<span class="nv">$ </span>systemctl status elasticsearch.service <span class="c"># elasticsearch</span>
<span class="nv">$ </span>systemctl status logstash.service <span class="c"># logstash</span>
<span class="nv">$ </span>systemctl status kibana.service <span class="c"># kibana</span>
<span class="nv">$ </span>systemctl status nginx.service <span class="c"># nginx</span>
<span class="nv">$ </span>systemctl status metricbeat.service <span class="c"># metricbeat</span>
<span class="nv">$ </span>systemctl status filebeat.service <span class="c"># filebeat</span>
</code></pre></div></div>

<p>ì •ìƒ ì‹¤í–‰ ì•ˆë˜ì—ˆì„ì‹œ í•˜ë‹¨ ìˆ˜ë™ êµ¬ë™ ëª…ë ¹ì–´ ì°¸ê³ </p>

<hr />

<h2 id="ì°¸ê³ ì‚¬í•­">ì°¸ê³ ì‚¬í•­</h2>

<h3 id="ì¬ë¶€íŒ…-ì •ë³´-í™•ì¸">ì¬ë¶€íŒ… ì •ë³´ í™•ì¸</h3>

<h4 id="ìµœê·¼-ì¬ë¶€íŒ…-ì‹œê°„-í™•ì¸">ìµœê·¼ ì¬ë¶€íŒ… ì‹œê°„ í™•ì¸</h4>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">who</span> <span class="nt">-b</span>
         system boot  2021-06-15 19:00

<span class="nv">$ </span>last reboot
reboot   system boot  3.10.0-1160.31.1 Tue Jun 15 19:00 - 10:06 <span class="o">(</span>55+15:06<span class="o">)</span>
reboot   system boot  3.10.0-1160.25.1 Wed Jun  9 20:25 - 10:06 <span class="o">(</span>61+13:40<span class="o">)</span>
reboot   system boot  3.10.0-957.el7.x Tue Jun  8 17:43 - 10:06 <span class="o">(</span>62+16:23<span class="o">)</span>
</code></pre></div></div>

<h4 id="ì—…íƒ€ì„-í™•ì¸">ì—…íƒ€ì„ í™•ì¸</h4>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">uptime
</span>10:05:54 up 55 days, 15:05,  1 user,  load average: 0.00, 0.01, 0.05
</code></pre></div></div>

<h3 id="systemd-ì •ë³´-í™•ì¸">systemd ì •ë³´ í™•ì¸</h3>

<h4 id="systemd-ë“±ë¡-ì„œë¹„ìŠ¤-ë¦¬ìŠ¤íŠ¸-í™•ì¸">systemd ë“±ë¡ ì„œë¹„ìŠ¤ ë¦¬ìŠ¤íŠ¸ í™•ì¸</h4>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>systemctl list-unit-files | <span class="nb">grep </span>enabled
<span class="nv">$ </span>systemctl status ì˜¤í”ˆì†ŒìŠ¤
<span class="nv">$ </span>ps <span class="nt">-ef</span>
</code></pre></div></div>
<p>systemd ì‹œìŠ¤í…œ ë°ëª¬ì— ë“±ë¡ëœ í”„ë¡œì„¸ìŠ¤ë“¤ì€ ë¦¬ë¶€íŠ¸ì‹œ ìë™ìœ¼ë¡œ ì‹¤í–‰ëœë‹¤.</p>

<p>systemdë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” í”„ë¡œì„¸ìŠ¤ëŠ” OS ì¬ì‹œì‘ì‹œ ì¬ê¸°ë™ ì—¬ë¶€ í™•ì¸ í›„ ì¬ê¸°ë™ë˜ì§€ ì•Šìœ¼ë©´ ìˆ˜ë™ êµ¬ë™ í•„ìš”</p>

<p>systemdì— ë“±ë¡ì´ ë˜ì–´ ìë™ ì‹¤í–‰ëœë‹¤ê³  í•˜ë”ë¼ë„ ì‹¤ì œ ì‘ë™ ì—¬ë¶€ í™•ì¸ í•„ìš”í•˜ë‹¤.</p>

<h3 id="ì„œë¹„ìŠ¤ë³„-systemd-ì‚¬ìš©-ì—¬ë¶€">ì„œë¹„ìŠ¤ë³„ systemd ì‚¬ìš© ì—¬ë¶€</h3>

<p>ì•„ë˜ í…Œì´ë¸”ì€ ì˜¤í”ˆì†ŒìŠ¤ ë¦¬ìŠ¤íŠ¸ì™€ systemd ë“±ë¡ ì—¬ë¶€ ë° ìˆ˜ë™ ì‹œì‘ ëª…ë ¹ì–´ë¥¼ ì‘ì„±í•˜ì˜€ë‹¤.</p>

<p>ì„¤ì¹˜í˜•ì„ ê¸°ì¤€ìœ¼ë¡œ ì‘ì„±ë˜ì—ˆìœ¼ë©° ë²„ì „ ë° í™˜ê²½ë³„ë¡œ ë‹¤ë¥¼ ìˆ˜ ìˆìœ¼ë‹ˆ ì°¸ê³ ë§Œ í•  ê²ƒ</p>

<table>
  <thead>
    <tr>
      <th>ì„œë¹„ìŠ¤</th>
      <th>systemd</th>
      <th>ìˆ˜ë™ ì‹œì‘ ëª…ë ¹ì–´(systemctl ë¶ˆê°€ì‹œ)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>metricbeat</td>
      <td>O</td>
      <td>/usr/share/metricbeat/bin/metricbeat â€“environment systemd -c /etc/metricbeat/metricbeat.yml â€“path.home /usr/share/metricbeat â€“path.config /etc/metricbeat â€“path.data /var/lib/metricbeat â€“path.logs /var/log/metricbeat</td>
    </tr>
    <tr>
      <td>filebeat</td>
      <td>O</td>
      <td>/usr/share/filebeat/bin/filebeat â€“environment systemd -c /etc/filebeat/filebeat.yml â€“path.home /usr/share/filebeat â€“path.config /etc/filebeat â€“path.data /var/lib/filebeat â€“path.logs /var/log/filebeat</td>
    </tr>
    <tr>
      <td>mongos</td>
      <td>O</td>
      <td>/usr/bin/mongos â€“config /etc/mongos.conf</td>
    </tr>
    <tr>
      <td>mongod</td>
      <td>O</td>
      <td>/usr/bin/mongod â€“config /etc/mongod.conf</td>
    </tr>
    <tr>
      <td>postgresql</td>
      <td>O</td>
      <td>/usr/bin/pg_ctlcluster â€“skip-systemctl-redirect %i start</td>
    </tr>
    <tr>
      <td>mysql</td>
      <td>O</td>
      <td>/usr/sbin/mysqld</td>
    </tr>
    <tr>
      <td>zookeeper</td>
      <td>O</td>
      <td>/usr/local/zookeeper/bin/zkServer.sh start</td>
    </tr>
    <tr>
      <td>kafka</td>
      <td>O</td>
      <td>/usr/local/kafka/bin/kafka-server-start.sh /usr/local/kafka/config/server.properties</td>
    </tr>
    <tr>
      <td>elasticseaerch</td>
      <td>O</td>
      <td>/usr/share/elasticsearch/bin/systemd-entrypoint -p /var/run/elasticsearch/elasticsearch.pid â€“quiet</td>
    </tr>
    <tr>
      <td>logstash</td>
      <td>O</td>
      <td>/usr/share/logstash/bin/logstash â€œâ€“path.settingsâ€ â€œ/etc/logstashâ€</td>
    </tr>
    <tr>
      <td>kibana</td>
      <td>O</td>
      <td>/usr/share/kibana/bin/kibana â€œ-c /etc/kibana/kibana.ymlâ€ â€“logging.dest=â€/var/log/kibana/kibana.log</td>
    </tr>
    <tr>
      <td>nginx</td>
      <td>O</td>
      <td>nginx -c /etc/config/nginx.conf</td>
    </tr>
  </tbody>
</table>

<p>í•´ë‹¹í•˜ëŠ” ì„œë²„ ì¬ë¶€íŒ…í›„ <code class="language-plaintext highlighter-rouge">systemctl status ì„œë¹„ìŠ¤</code> ëª…ë ¹ì–´ë¡œ ê° ì„œë¹„ìŠ¤ì˜ êµ¬ë™ìƒíƒœ í™•ì¸ í›„</p>

<p>êµ¬ë™ë˜ì–´ ìˆì§€ ì•Šìœ¼ë©´ <code class="language-plaintext highlighter-rouge">systemctl start ì„œë¹„ìŠ¤</code>ë¡œ ì •ìƒ ì‹¤í–‰ì—¬ë¶€ í™•ì¸í•œë‹¤</p>

<p>ê·¸ë˜ë„ ì‹¤í–‰ë˜ì§€ ì•Šìœ¼ë©´ ìœ„ í‘œì— ìˆëŠ” ìˆ˜ë™ ì‹œì‘ ëª…ë ¹ì–´ ì‹¤í–‰(ê¶Œì¥í•˜ì§€ ì•ŠìŒ)</p>

<hr />

<h2 id="reference">Reference</h2>

<ol>
  <li><a href="https://stackoverflow.com/a/59576322/15263734">https://stackoverflow.com/a/59576322/15263734</a></li>
</ol>
:ET